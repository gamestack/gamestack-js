"use strict";function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function jstr(obj){return JSON.stringify(obj)}function $Q(selector){var $GFunx={};$GFunx.each=function(callback){for(var x=0;x<this.length;x++)"number"==typeof x&&callback(x,this[x])},$GFunx.on=function(evt_key,selectorObject,controller_ix,callback){var criterion=$Q.between("[","]",evt_key);criterion.indexOf("===")>=0&&(criterion=criterion.replace("===","=")),criterion.indexOf("==")>=0&&(criterion=criterion.replace("==","=").replace("==",0));criterion.split("=");evt_key.indexOf("[")>=0&&(evt_key=$Q.before("[",evt_key).trim());var padding=0;controller_ix&&"function"==typeof controller_ix&&!callback&&(callback=controller_ix,controller_ix=0),selectorObject&&"function"==typeof selectorObject&&!callback&&(callback=selectorObject,selectorObject=$Q("*"),controller_ix=0);var evt_profile={};if(evt_profile.cix=controller_ix,evt_profile.evt_key=evt_key,$Q.contains_any(["stick","button","click","key"],evt_profile.evt_key)){evt_profile.evt_key.indexOf("button")>=0;Gamestack.GamepadAdapter.on(evt_profile.evt_key,0,function(x,y){callback(x,y)}),console.info("detected input event key in:"+evt_profile.evt_key),console.info("TODO: rig events")}else if($Q.contains_any(["collide","collision","hit","touch"],evt_profile.evt_key))console.info("Rigging a collision event"),console.info("detected collision event key in:"+evt_profile.evt_key),console.info("TODO: rig collision events"),this.each(function(ix,item1){console.info("Collision Processing 1:"+item1.name),console.info("Collision Processing 1:"+item1.type),selectorObject.each(function(iy,item2){console.info("Collision Processing 2:"+item2.name),console.info("Collision Processing 2:"+item2.type),"function"==typeof item1.onUpdate&&item1.onUpdate(function(sprite){item1.collidesRectangular(item2,padding)&&callback(item1,item2)})})});else{console.info("Rigging a property event"),console.info("detected property threshhold event key in:"+evt_profile.evt_key),console.info("TODO: rig property events");var condition="_",key=criterion||evt_profile.evt_key;(key.indexOf("[")>=0||key.indexOf("]")>=0)&&(key=$Q.between("[","]",key));var evt_parts=[],run=function(){console.error("Sprite property check was not set correctly")};key.indexOf(">=")>=0?condition=">=":key.indexOf("<=")>=0?condition="<=":key.indexOf(">")>=0?condition=">":key.indexOf("<")>=0?condition="<":key.indexOf("=")>=0&&(condition="="),evt_parts=key.split(condition);for(var x=0;x<evt_parts.length;x++)evt_parts[x]=evt_parts[x].replace("=","").replace("=","").trim();var mykey,number;try{mykey=evt_parts[0],number=parseFloat(evt_parts[1])}catch(e){console.log(e)}switch(console.info("Gamestack:Processing condition with:"+condition),condition){case">=":run=function(obj,key){obj[key]>=number&&callback()};break;case"<=":run=function(obj,key){obj[key]<=number&&callback()};break;case">":run=function(obj,key){obj[key]>number&&callback()};break;case"<":run=function(obj,key){obj[key]<number&&callback()};break;case"=":run=function(obj,key){obj[key]==number&&callback()}}var keys=mykey.split("."),propkey="";this.each(function(ix,item){var object={};if(1==keys.length?(object=item,propkey=mykey):2==keys.length?(object=item[keys[0]],propkey=keys[1]):3==keys.length?(object=item[keys[0]][keys[1]],propkey=keys[2]):console.error(":length of '.' notation out of range. We use max length of 3 or prop.prop.key."),"function"==typeof item.onUpdate){item.onUpdate(function(sprite){run(object,propkey)})}})}};var object_out=new Object;if("string"!=typeof selector)"object"!==("undefined"==typeof selector?"undefined":_typeof(selector))&&(selector={}),object_out=selector;else if(selector&&"*"!==selector){var s=selector||"";console.info("selector:"+s);var mainSelector=$Q.before("[",s).trim(),msfChar=mainSelector.substring(0,1),__targetClassName="*",cleanSelectorString=function(str){return str.replace(",","")};switch(msfChar.toLowerCase()){case".":console.info('Selecting by "." or class'),__targetClassName=cleanSelectorString($Q.after(".",mainSelector)),console.info("Target class is:"+__targetClassName);break;case"*":console.info('Selecting by "*" or ANY object in the library instance'),__targetClassName="*"}var criterion=$Q.between("[","]",s),cparts=criterion.split("="),__targetType="*",__targetName="*",getParts=function(){if(cparts.length>=2)switch(cparts[0].toLowerCase()){case"name":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetName=cleanSelectorString(cparts[1]);break;case"type":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetType=cleanSelectorString(cparts[1])}if(cparts.length>=4)switch(cparts[2]=cparts[2].replace(",",""),cparts[2].toLowerCase()){case"name":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetName=cleanSelectorString(cparts[3]);break;case"type":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetType=cleanSelectorString(cparts[3])}};getParts(cparts),object_out=GameStack.select(__targetClassName,__targetName,__targetType)}else"*"==selector&&(object_out=GameStack.all_objects);for(var x in $GFunx)object_out[x]=$GFunx[x];return object_out}function makeArray(obj){return obj instanceof Array||(obj=[obj]),obj}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},Gamestack={},GamestackEngine=function(){var lib={game_windows:[],all_objects:[],DEBUG:!1,gui_mode:!0,__gameWindow:{},__sprites:[],__animations:[],spriteTypes:[],systemSpriteTypes:["player","enemy","background","interactive","terrain","weapon","subsprite"],samples:{},log_modes:["reqs","info","warning"],log_mode:"all",recursionCount:0,__gameWindowList:[],getObjectById:function(id){for(var x=0;x<this.all_objects.length;x++)if(this.all_objects[x].id==id)return this.all_objects[x]},interlog:function(message,div){this.recursionCount++,!isNaN(div)&&this.recursionCount%div==0},create_id:function(){var S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()},error:function(quit,message){if(quit)throw new Error(message);console.error("E!"+message)},info:function(m){GameStack.DEBUG&&console.info("Info:"+m)},log:function(m){GameStack.DEBUG&&console.log("GameStack:"+m)},Extendors:{hasInit:function(obj,args,f){},hasOnComplete:function(obj,args,f){},hasMultiOnComplete:function(obj,args,f){},hasOnRun:function(obj,args,f){},hasMultiOnRun:function(obj,args,f){},hasOnCollide:function(obj,args,f){},hasMultiOnCollide:function(obj,args,f){},collideable:function(obj,args){obj.collision_callback=function(){},obj.onCollide=args.onCollide||function(collideables,callback){"function"==typeof collideables&&(callback=collideables),this.collision_callback=callback||function(){}}},spatial:function(obj){obj.Size=function(s){return this.size=new Gamestack.Vector(s,s,s),this},obj.Pos=function(p){return this.position=new Gamestack.Vector(p,p,p),this},obj.Rot=function(r){return this.rotation=new Gamestack.Vector(r,r,r),this},obj.Position=obj.Pos,obj.Rotate=obj.Rot,obj.Rotation=obj.Rot},informable:function(obj,args){obj.name=Gamestack.getArg(args,"name","__"),obj.description=Gamestack.getArg(args,"description",!1)},tweenable:function(obj,args){obj.curve_string=args.curve_string||"linearNone",obj.setTweenCurve=function(c){c=c||"linear_none";var cps=c.split("_");alert(cps);var s1=cps[0].toLowerCase(),s2=cps[1].toLowerCase(),curve=TWEEN.Easing.Linear.None;return obj.curve_string="linear_none",$.each(TWEEN.Easing,function(ix,easing){$.each(TWEEN.Easing[ix],function(iy,easeType){ix==s1&&iy==s2&&(curve=TWEEN.Easing[ix][iy],obj.curve_string=ix+"_"+iy)})}),obj.curve=curve,curve},obj.curvesToArray=function(){var c=[];return GameStack.each(TWEEN.Easing,function(ix,easing){GameStack.each(easing,function(iy,easeType){["in","out","inout","none"].indexOf(iy.toLowerCase())>=0&&c.push(ix+"_"+iy)})}),c}},applyParentalArgs:function(obj,args){return args.parent instanceof Gamestack.Sprite?(alert("parent was Sprite()"),obj.parent=args.parent,obj.parent_id=obj.parent.id):(obj.parent_id=args.parent_id||args.object_id||"__blank",obj.parent=Gamestack.getObjectById(obj.parent_id)),obj.parent}},ChainSet:{informable:function(obj){obj.Info=function(name,description){return this.name=name,this.description=description,this}},posable:function(obj){obj.Position=function(){return"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):"object"==("undefined"==typeof p?"undefined":_typeof(p))&&(this.position=p),this}},rotable:function(obj){obj.Rotation=function(){return"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):"object"==("undefined"==typeof p?"undefined":_typeof(p))&&(this.position=p),this}}},Collision:{spriteRectanglesCollide:function(obj1,obj2,gw){gw=gw||Gamestack.game_windows[0];var camPos=new Gamestack.Vector(0,0,0);obj1.padding=obj1.padding||new Gamestack.Vector(0,0,0);var paddingX=Math.round(obj1.padding.x*obj1.size.x),paddingY=Math.round(obj1.padding.y*obj1.size.y),left=obj1.position.x+paddingX+camPos.x,right=obj1.position.x+obj1.size.x-paddingX+camPos.x,top=obj1.position.y+camPos.y+paddingY,bottom=obj1.position.y+obj1.size.y-paddingY+camPos.y;if(right>obj2.position.x&&left<obj2.position.x+obj2.size.x&&bottom>obj2.position.y&&top<obj2.position.y+obj2.size.y)return!0}},_gameWindow:{},setGameWindow:function(gameWindow){this._gameWindow=gameWindow},ExtendEvents:function(extendedObject,extendedKey,extendor,extendorKey){new GSEventLink(extendedObject,extendedKey,extendor,extendorKey);this.all_objects.push(new GSEventLink(extendedObject,extendedKey,extendor,extendorKey));var parent=extendedObject;parent&&(console.log("Gamestack:EXTENDING EVENTS:"+extendedKey+":"+extendorKey),parent.onRun&&parent.onRun(extendor,extendorKey),parent.onComplete&&parent.onComplete(extendor,extendorKey))},removeOffscreenObjects:function(gw){gw=gw||Gamestack.game_windows[0],Gamestack.each(Gamestack.all_objects,function(ix,item){item instanceof Gamestack.Sprite&&0==item.onScreen()&&!item.__keepAlive&&!item.keepAlive&&gw.remove(item)})},removeDeadObjects:function(gw){gw=gw||Gamestack.game_windows[0],Gamestack.each(Gamestack.all_objects,function(ix,item){item instanceof Gamestack.Sprite&&item.isDead()&&gw.remove(item)})},getGameWindow:function(){return this._gameWindow},assignAll:function(object,args,keys){__gameStack.each(keys,function(ix,item){object[ix]=args[ix]})},each:function(list,onResult,onComplete){for(var i in list)onResult(i,list[i]);"function"==typeof onComplete&&onComplete(!1,list)},ready_callstack:[],ready:function(callback){this.ready_callstack.push(callback)},reload:function(){this.callReady()},callReady:function(){var funx=this.ready_callstack,gameWindow=this._gameWindow,lib=this,objects=this.__gameWindow.objects;this.each(funx,function(ix,call){call(lib,gameWindow,objects)}),this.InputSystem.init(),this.__running=!0},getArg:function(args,keys,fallback){"string"==typeof keys&&(keys=[keys]);for(var x=0;x<keys.length;x++){var k=keys[x];if(args&&args.hasOwnProperty(k))return args[k]}return fallback},normalArgs:function(args){function normal(str){return str.toLowerCase().replace("-","").replace(" ","").replace("_","")}var a={};for(var x in args)a[normal(x)]=args[x];return a},isNormalStringMatch:function(str1,str2){return str1.toLowerCase().replace(" ","")==str2.toLowerCase().replace(" ","")},instance_type_pairs:function(){var objectList=[];return this.each(this.all_objects,function(ix,item){objectList.push({constructor_name:item.constructor.name,type:item.type})}),objectList},getById:function(id){for(var x in this.all_objects)if(this.all_objects[x].id==id)return this.all_objects[x]},select:function(constructor_name,name,type){var objects_out=[],__inst=this;return this.each(this.all_objects,function(ix,item){"*"!=constructor_name&&item.constructor.name!=constructor_name||("*"==type||__inst.isNormalStringMatch(type,item.type))&&("*"==name||__inst.isNormalStringMatch(name,item.name))&&objects_out.push(item)}),objects_out}};return lib},GamestackApi={get:function(){},post:function(object){object.id||(object.id=Gamestack.create_id());object.name,object.constructor.name,jstr(object),object.id}},GSO=function(){function GSO(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GSO),this.run_ext=args.run_ext||[],this.complete_ext=args.complete_ext||[]}return _createClass(GSO,[{key:"onRun",value:function(caller,callkey){this.run_ext=this.run_ext||[],this.run_ext.indexOf(caller[callkey])==-1&&this.run_ext.push({caller:caller,callkey:callkey})}},{key:"onComplete",value:function(caller,callkey){this.complete_ext=this.complete_ext||[],this.complete_ext.indexOf(caller[callkey])==-1&&this.complete_ext.push({caller:caller,callkey:callkey})}},{key:"call_on_run",value:function(){for(var x=0;x<this.run_ext.length;x++)this.run_ext[x].caller[this.run_ext[x].callkey]()}},{key:"call_on_complete",value:function(){for(var x=0;x<this.complete_ext.length;x++)this.complete_ext[x].caller[this.complete_ext[x].callkey]()}}]),GSO}(),GameImage=function(){function GameImage(src,onCreate){if(_classCallCheck(this,GameImage),!src||src instanceof String&&![".jpg",".png",".gif"].indexOf(src.toLowerCase())>=0)return console.info("Requested an UNDEFINED or Non-Image-File for image src"),{};if(src instanceof Object&&src.src)this.image=document.createElement("IMG"),this.image.src=src.src,this.src=src.src;else if("string"==typeof src){src.substring(src.lastIndexOf("."),src.length);this.image=document.createElement("IMG"),this.image.src=src,this.src=this.image.src}if(!this.image)return this.image={error:"Image not instantiated, set to object by default"},{};this.image.onerror=function(){this.__error=!0},this.domElement=this.image,(src.data||src.image&&src.image.data)&&(console.info("GameImage() : found and applied image.data"),this.data=src.data);this.image.onload=function(){"function"==typeof this.onCreate&&this.onCreate(this.image)}}return _createClass(GameImage,[{key:"getImage",value:function(){return this.image}}]),GameImage}(),GameStack=new GamestackEngine;Gamestack=GameStack;var __gameStack=GameStack,Quick2d=GameStack,__gameInstance=Gamestack;Gamestack.Sound=Sound,Gamestack.GameImage=GameImage,"undefined"!=typeof module&&module.exports&&(module.exports=Gamestack),Gamestack.jstr=jstr,$Q.each=function(obj,callback,complete){for(var x in obj)callback(obj);"function"==typeof complete&&complete(obj)},$Q.before=function(c1,test_str){var start_pos=0,end_pos=test_str.indexOf(c1,start_pos);return test_str.substring(start_pos,end_pos)},$Q.contains=function(c1,test_str){return test_str.indexOf(c1)>=0},$Q.contains_all=function(cList,test_str){for(var x=0;x<cList.length;x++)if(test_str.indexOf(cList[x])<0)return!1;return!0},$Q.contains_any=function(cList,test_str){for(var x=0;x<cList.length;x++)if(test_str.indexOf(cList[x])>=0)return!0;return!1},$Q.after=function(c1,test_str){var start_pos=test_str.indexOf(c1)+1,end_pos=test_str.length;return test_str.substring(start_pos,end_pos)},$Q.between=function(c1,c2,test_str){var start_pos=test_str.indexOf(c1)+1,end_pos=test_str.indexOf(c2,start_pos);return test_str.substring(start_pos,end_pos)},$Q.test_selector_method=function(){for(var Q_TestStrings=["*",".Sprite",'*[type="enemy_type_0"]','.Sprite[type="enemy_type_0"]'],x=0;x<Q_TestStrings.length;x++){var test=Q_TestStrings[x];console.info("testing:"+test),$Q(test)}console.log("Testing stick left"),this.on("stick_left_0"),console.log("Testing button"),this.on("button_0"),console.log("Testing collide"),this.on("collide"),console.log("Testing button"),this.on("collide"),console.log("Testing prop"),this.on("health>=0")},Gamestack.$Q=$Q,Gamestack.query=$Q,Gamestack.InputSystem={events:{mousemove:[],leftclick:{},rightclick:{},middleclick:[],wheelup:[],wheelDown:[]},keymap:{},keyReplace:function(str){return str.toLowerCase().replace("space"," ").replace("left",String.fromCharCode(37)).replace("left",String.fromCharCode(37)).replace("up",String.fromCharCode(38)).replace("right",String.fromCharCode(39)).replace("down",String.fromCharCode(40))},extendKey:function(evt_key,_callback,onFinish){return evt_key=this.keyReplace(evt_key),Gamestack.InputSystem.keymap[evt_key]={down:!1,callback:function(){_callback(evt_key)}},Gamestack.InputSystem.keymap[evt_key]},extend:function(evt_key,downCall,upCall,onFinish){return evt_key=evt_key.toLowerCase(),Gamestack.InputSystem[evt_key]={down:downCall,up:upCall},Gamestack.InputSystem[evt_key]},init:function(){function getMousePos(e,c){var x,y;return e.pageX||e.pageY?(x=e.pageX,y=e.pageY):(x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),x-=c.offsetLeft,y-=c.style.top,{x:x,y:y}}function fullMoveInputSystem(event,c){var pos=getMousePos(event,c),InputSystem=GameStack.InputSystem;for(var x in InputSystem.events)InputSystem.events[x]instanceof Array&&"mousemove"==x&&GameStack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)})}window.setInterval(function(){Gamestack.each(GameStack.InputSystem.keymap,function(im,kmapItem){1==kmapItem.down&&kmapItem.callback()})},10),document.onkeydown=document.onkeyup=function(e){e=e||event;var gs_key_string="key_"+String.fromCharCode(e.keyCode),evt_object=Gamestack.InputSystem.keymap[gs_key_string]||Gamestack.InputSystem.keymap[gs_key_string.toLowerCase()];evt_object&&(evt_object.down="keydown"==e.type)};for(var canvases=document.getElementsByTagName("CANVAS"),x=0;x<canvases.length;x++){var applyMouseMove=function(e){fullMoveInputSystem(e,c)},c=canvases[x];document.addEventListener("mousemove",applyMouseMove),c.onmousedown=function(e){var pos=(e.which,getMousePos(e,c)),InputSystem=GameStack.InputSystem;switch(e.preventDefault(),e.which){case 1:for(var x in InputSystem.events)InputSystem.events[x]instanceof Array&&"leftclick"==x&&GameStack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)});break;case 2:for(var x in GameStack.InputSystem.events)InputSystem.events[x]instanceof Array&&"middleclick"==x&&GameStack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)});break;case 3:for(var x in GameStack.InputSystem.events)if(InputSystem.events[x]instanceof Array&&"rightclick"==x)return GameStack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)}),!1;break;default:return 0}return e.preventDefault(),0},c.onmouseup=function(e){var pos=(e.which,getMousePos(e,c)),InputSystem=GameStack.InputSystem;switch(e.preventDefault(),e.which){case 1:for(var x in InputSystem.events)InputSystem.events[x]instanceof Array&&"leftclick"==x&&GameStack.each(InputSystem.events[x],function(ix,el){el.up(pos.x,pos.y)});break;case 2:for(var x in GameStack.InputSystem.events)InputSystem.events[x]instanceof Array&&"middleclick"==x&&GameStack.each(InputSystem.events[x],function(ix,el){el.up(pos.x,pos.y)});break;case 3:for(var x in GameStack.InputSystem.events)if(InputSystem.events[x]instanceof Array&&"rightclick"==x)return GameStack.each(InputSystem.events[x],function(ix,el){el.up(pos.x,pos.y)}),!1;break;default:return 0}}}}},window.onload=function(){__gameStack.callReady()},Gamestack.file_system={localizedSource:function(src,hostUrl){hostUrl=hostUrl||"../";var gs_folder_ix=src.indexOf("assets/game");return hostUrl+src.substring(gs_folder_ix,src.length)},loadJSON:function(filepath,callback){$.getJSON(filepath,function(data){callback(!1,data)})},loadJSONLevel:function(filepath,gw,callback){"function"!=typeof gw&&gw||(callback=gw||callback||function(){},gw=Gamestack.game_windows[0]),$.getJSON(filepath,function(data){$.each(data.sprites,function(ix,xitem){"string"==typeof xitem.src&&(xitem.src=Gamestack.file_system.localizedSource(xitem.src)),__gameStack.each(xitem,function(iy,yitem){yitem.src&&(yitem.src=Gamestack.file_system.localizedSource(yitem.src)),__gameStack.each(yitem,function(iz,zitem){zitem.src&&(zitem.src=Gamestack.file_system.localizedSource(zitem.src))})}),xitem=new Gamestack.Sprite(xitem),gw.add(xitem),ix>=data.sprites.length-1&&callback(!1,data)})})}},Gamestack.ready(function(lib){Gamestack.log("GameStack:lib :: ready")});var GameWindow=function(){function GameWindow(){var _ref=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},_ref$canvas=_ref.canvas,canvas=void 0!==_ref$canvas&&_ref$canvas,objects=_ref.objects,update=_ref.update;_ref.camera;_classCallCheck(this,GameWindow),this.objects=objects||[],this.canvas=canvas||!1,canvas||(console.info("GameWindow() had no {canvas:canvas} argument. Creating a new canvas in document.body..."),this.canvas=document.createElement("CANVAS"),document.body.append(this.canvas)),document.body.style.position="absolute",document.body.style.width="100%",document.body.style.height="100%",this.camera=new Gamestack.Camera,this.camera.target=!1,__gameStack.camera=this.camera,"function"==typeof update&&this.onUpdate(update);var __inst=this;this.adjustSize(),this.update_ext=[],window.onresize=function(){__inst.adjustSize()},this.ctx=this.canvas.getContext("2d"),Gamestack.game_windows.push(this)}return _createClass(GameWindow,[{key:"uniques",value:function(list){var listout=[];return $Q.each(list,function(ix,item){if(!listout.indexOf(item.id)>=0){item.name;listout.push({sprite:item})}}),listout}},{key:"setPlayer",value:function(player){this.player=player,!this.objects.indexOf(player)>=0&&this.objects.push(player)}},{key:"onUpdate",value:function(f){this.update_ext.push(f)}},{key:"update",value:function(){GameStack.each(this.objects,function(ix,item){item&&"function"==typeof item.def_update&&item.def_update(item),item&&"function"==typeof item.update&&item.update(item)});for(var x in this.update_ext)this.update_ext[x]()}},{key:"draw",value:function(){var _gw=this;this.before_draw_ext&&this.before_draw_ext(),GameStack.each(this.objects,function(ix,item){(["Sprite","Background","Interactive","Terrain"].indexOf(item.constructor.name)>=0||item.__isDrawable)&&Gamestack.Canvas.draw(item,_gw.ctx)}),this.draw_ext&&this.draw_ext()}},{key:"onDraw",value:function(f){this.draw_ext=function(){f()}}},{key:"onBeforeDraw",value:function(f){this.before_draw_ext=function(){f()}}},{key:"adjustSize",value:function(w,h){w=w||this.canvas.parentNode.clientWidth,h=h||this.canvas.parentNode.clientHeight;var c=document.getElementById("#gs-container");c&&c.setAttribute("width",w),c&&c.setAttribute("height",h),__gameStack.WIDTH=w,__gameStack.HEIGHT=h,this.canvas.width=w,this.canvas.height=h}},{key:"add",value:function(obj,onBottom){if(obj instanceof Gamestack.Camera)this.camera=obj;else if(obj instanceof Gamestack.GSEvent){if(__gameStack.__running)return console.error("Events can only be added before Gamstack.animate() is called::aka before the main update / loop begins");obj.apply()}else onBottom?this.objects.splice(0,0,obj):this.objects.push(obj);return this.collect(obj),obj}},{key:"remove",value:function(obj){var ix=this.objects.indexOf(obj);ix>=0&&this.objects.splice(ix,1);var ixG=Gamestack.all_objects.indexOf(obj);ixG>=0&&Gamestack.all_objects.splice(ixG,1)}},{key:"collect",value:function(obj){Gamestack.all_objects.push(obj)}},{key:"animate",value:function(time){var __inst=this;requestAnimationFrame(function(){__inst.animate()}),Gamestack.__stats&&(Gamestack.__stats.begin(),Gamestack.__statsMS.begin(),Gamestack.__statsMB.update()),__gameStack.isAtPlay=!0,window.TWEEN&&TWEEN.update(time),__inst.update(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.draw(),Gamestack.__stats&&(Gamestack.__stats.end(),Gamestack.__statsMS.end())}},{key:"start",value:function(){"function"==typeof Stats&&(Gamestack.__stats=new Stats,Gamestack.__stats.showPanel(0),Gamestack.__stats.dom.style.left="30%",this.canvas.parentNode.appendChild(Gamestack.__stats.dom),Gamestack.__statsMS=new Stats,Gamestack.__statsMS.showPanel(1),Gamestack.__statsMS.dom.style.left="30%",Gamestack.__statsMS.dom.style.marginLeft="90px",this.canvas.parentNode.appendChild(Gamestack.__statsMS.dom),Gamestack.__statsMB=new Stats,Gamestack.__statsMB.showPanel(2),Gamestack.__statsMB.dom.style.left="30%",Gamestack.__statsMB.dom.style.marginLeft="180px",this.canvas.parentNode.appendChild(Gamestack.__statsMB.dom)),this.animate()}}]),GameWindow}(),FullScreenGameWindow=function(_GameWindow){function FullScreenGameWindow(){var _ref2,_ref2$canvas,args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(_ref2={},_ref2$canvas=_ref2.canvas,canvas=void 0!==_ref2$canvas&&_ref2$canvas,objects=_ref2.objects,update=_ref2.update,camera=_ref2.camera,_ref2);_classCallCheck(this,FullScreenGameWindow);var _this=_possibleConstructorReturn(this,(FullScreenGameWindow.__proto__||Object.getPrototypeOf(FullScreenGameWindow)).call(this,args));_this.canvas||(console.info("creating new canvas"),_this.canvas=document.createElement("CANVAS"),document.body.append(_this.canvas)),_this.canvas.style.position="absolute",_this.canvas.style.width="100%",_this.canvas.style.height="100%",_this.canvas.style.background="black";_this.canvas;return _this.ctx=_this.canvas.getContext("2d"),__gameStack.canvas=_this.canvas,__gameStack.ctx=_this.ctx,_this.adjustSize(),__gameStack.__gameWindow=_this,_this}return _inherits(FullScreenGameWindow,_GameWindow),_createClass(FullScreenGameWindow,[{key:"adjustSize",value:function(w,h){w=w||this.canvas.clientWidth,h=h||this.canvas.clientHeight;var c=document.getElementById("#gs-container");c&&c.setAttribute("width",w),c&&c.setAttribute("height",h),__gameStack.WIDTH=w,__gameStack.HEIGHT=h,this.canvas.width=w,this.canvas.height=h}}]),FullScreenGameWindow}(GameWindow);Gamestack.GameWindow=GameWindow,function(){console.log("Animation class... creating");var Animation=function(){function Animation(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Animation),args=args||{},"string"==typeof args&&(this.image=new Gamestack.GameImage(args),args={});for(var x in this.args)this[x]=args[x];this.name=args.name||"__animationName",this.description=args.description||"__animationDesc",this.image||(this.image=new Gamestack.GameImage(args.src||args.image));var __inst=this,imgDom=this.image.domElement;this.frameSize=new Gamestack.Vector(args.frameSize||new Gamestack.Vector(0,0)),this.image.domElement.onload=function(){0==__inst.frameSize.x&&0==__inst.frameSize.y&&(__inst.frameSize=new Gamestack.Vector(imgDom.width,imgDom.height))},args.frameBounds&&args.frameBounds.min&&args.frameBounds.max?this.frameBounds=new Gamestack.VectorFrameBounds(args.frameBounds.min,args.frameBounds.max,args.frameBounds.termPoint):this.frameBounds=new Gamestack.VectorFrameBounds(new Gamestack.Vector(0,0,0),new Gamestack.Vector(0,0,0),new Gamestack.Vector(0,0,0)),this.frameOffset=this.getArg(args,"frameOffset",new Gamestack.Vector(0,0,0)),this.apply2DFrames(),this.flipX=this.getArg(args,"flipX",!1),this.cix=0,this.selected_frame=this.frames[0]||{},this.timer=0,this.duration=args.duration||2e3,this.seesaw_mode=args.seesaw_mode||!1,this.reverse_frames=args.reverse_frames||!1,this.run_ext=args.run_ext||[],this.complete_ext=args.complete_ext||[],Gamestack.ChainSet.informable(this)}return _createClass(Animation,[{key:"onRun",value:function(call){this.run_ext.indexOf(call)==-1&&this.run_ext.push(call)}},{key:"onComplete",value:function(call){this.complete_ext.indexOf(call)==-1&&this.complete_ext.push(call)}},{key:"call_on_run",value:function(){for(var x=0;x<this.run_ext.length;x++)this.run_ext[x]()}},{key:"call_on_complete",value:function(){for(var x=0;x<this.complete_ext.length;x++)this.complete_ext[x]()}},{key:"reverseFrames",value:function(){this.frames.reverse()}},{key:"singleFrame",value:function(frameSize){return this.__frametype="single",this.frameSize=frameSize||this.frameSize,this.selected_frame={image:this.image,frameSize:this.frameSize,framePos:{x:0,y:0}},this.frames[0]=this.selected_frame,this}},{key:"getArg",value:function(args,key,fallback){return args.hasOwnProperty(key)?args[key]:fallback}},{key:"apply2DFrames",value:function(){this.frames=[];for(var fcount=0,quitLoop=!1,y=this.frameBounds.min.y;y<=this.frameBounds.max.y;y++)for(var _x5=this.frameBounds.min.x;_x5<=this.frameBounds.max.x;_x5++){var framePos={x:_x5*this.frameSize.x+this.frameOffset.x,y:y*this.frameSize.y+this.frameOffset.y};if(this.frames.push({image:this.image,frameSize:this.frameSize,framePos:framePos}),_x5>=this.frameBounds.termPoint.x&&y>=this.frameBounds.termPoint.y){quitLoop=!0;break}if(fcount+=1,quitLoop)break}if(this.frames[0]=this.frames[0]?this.frames[0]:{image:this.image,frameSize:this.frameSize,framePos:{x:this.frameBounds.min.x,y:this.frameBounds.min.y}},this.seesaw_mode){console.log("ANIMATION: applying seesaw");var frames_reversed=this.frames.slice().reverse();this.frames.pop(),this.frames=this.frames.concat(frames_reversed)}this.reverse_frames&&this.reverseFrames()}},{key:"update",value:function(){this.selected_frame=this.frames[Math.round(this.cix)%this.frames.length]}},{key:"reset",value:function(){this.apply2DFrames(),this.cix=0}},{key:"continuous",value:function(){return"single"==this.__frametype?0:(this.apply2DFrames(),this.update(),void(0==this.cix&&this.engage()))}},{key:"engage",value:function(duration,complete){if(this.call_on_run(),duration=duration||this.duration||20*this.frames.length,"single"==this.__frametype)return 0;var __inst=this;this.tween=new TWEEN.Tween(this).easing(__inst.curve||TWEEN.Easing.Linear.None).to({cix:__inst.frames.length-1},duration).onUpdate(function(){__inst.update()}).onComplete(function(){__inst.cix=0,__inst.call_on_complete(),__inst.isComplete=!0}),this.tween.start()}},{key:"animate",value:function(){this.apply2DFrames(),this.timer+=1,0!=this.delay&&this.timer%this.delay!=0||(this.cix>=this.frames.length-1&&this.call_on_complete(),this.cix=this.cix>=this.frames.length-1?this.frameBounds.min.x:this.cix+1,this.update())}}]),Animation}();Gamestack.Animation=Animation}(),function(){console.log("Camera class... creating");var Camera=function Camera(args){_classCallCheck(this,Camera),this.position=new Gamestack.Vector(0,0,0)};Gamestack.Camera=Camera}(),function(){console.log("CanvasStack class... creating");var CanvasStack=function CanvasStack(){return _classCallCheck(this,CanvasStack),{__levelMaker:!1,draw:function(sprite,ctx,camera){camera=camera||Gamestack.game_windows[0].camera||{position:new Gamestack.Vector(0,0,0)},sprite.active&&(this.__levelMaker||sprite.onScreen(__gameStack.WIDTH,__gameStack.HEIGHT))&&this.drawPortion(sprite,ctx,camera)},drawFrameWithRotation:function(img,fx,fy,fw,fh,x,y,width,height,deg,canvasContextObj,flipX,flipY){canvasContextObj.save(),deg=Math.round(deg),deg%=360;var rad=deg*Math.PI/180;canvasContextObj.translate(x,y),canvasContextObj.rotate(rad),canvasContextObj.translate(0,canvasContextObj.width),
flipX&&canvasContextObj.scale(-1,1),flipY&&canvasContextObj.scale(1,-1),canvasContextObj.drawImage(img,fx,fy,fw,fh,width/2*-1,height/2*-1,width,height),canvasContextObj.restore()},drawData:function(x,y,w,h,data,ctx){ctx.putImageData(data,x,y,0,0,w,h)},drawPortion:function(sprite,ctx,camera){var frame;if(sprite.active){if(!(sprite.selected_animation instanceof Object&&sprite.selected_animation.hasOwnProperty("selected_frame")))return;frame=sprite.selected_animation.selected_frame;var p=sprite.position,camera_pos=camera.position||{x:0,y:0,z:0};sprite.hasOwnProperty("scrollFactor")||(sprite.scrollFactor=1);var x=p.x,y=p.y,scrollFactor=sprite.scrollFactor>=0&&sprite.scrollFactor<=1?sprite.scrollFactor:1;sprite.noScroll&&(scrollFactor=0),x-=camera_pos.x*scrollFactor||0,y-=camera_pos.y*scrollFactor||0;var targetSize=sprite.size||sprite.selected_animation.size,realWidth=targetSize.x,realHeight=targetSize.y;sprite.selected_animation&&sprite.selected_animation.hasOwnProperty("offset")&&(x+=sprite.selected_animation.offset.x,y+=sprite.selected_animation.offset.y);var rotation;rotation="object"==_typeof(sprite.rotation)?sprite.rotation.x:sprite.rotation;var frame=sprite.selected_animation.selected_frame;frame&&frame.image&&frame.image.data?ctx.putImageData(frame.image.data,x,y,0,0,sprite.size.x,sprite.size.y):sprite.selected_animation.image.domElement instanceof HTMLImageElement&&this.drawFrameWithRotation(sprite.selected_animation.image.domElement,frame.framePos.x,frame.framePos.y,frame.frameSize.x,frame.frameSize.y,Math.round(x+realWidth/2),Math.round(y+realHeight/2),realWidth,realHeight,rotation%360,ctx,sprite.flipX,sprite.flipY)}}}};Gamestack.Canvas=new CanvasStack,Gamestack.CanvasStack=CanvasStack}(),function(){console.log("CollisionSettings class... creating");var CollisionSettings=function CollisionSettings(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,CollisionSettings),this.fourway=args.fourway||args.four_way||!1,this.top=this.four_way||args.top||!1,this.bottom=this.four_way||args.bottom||!1,this.left=this.four_way||args.left||!1,this.right=this.four_way||args.right||!1,this.pixel=args.pixel||!1,this.stop=args.stop||!1,this.padding=args.padding||new Gamestack.Vector(0,0,0)};Gamestack.CollisionSettings=CollisionSettings}(),function(){console.log("Force class... creating");var GravityForce=function(){function GravityForce(args){_classCallCheck(this,GravityForce),this.name=args.name||"",this.description=args.description||"",this.subjects=args.subjects||[],this.clasticObjects=args.clasticObjects||[],this.topClastics=args.topClastics||[],this.max=args.max||new Vector3(3,3,3),this.accel=args.accel||new Vector3(1.3,1.3,1.3);for(var x in this.clasticObjects)!this.clasticObjects[x]instanceof Gamestack.Sprite&&(this.clasticObjects[x]=Gamestack.getById(this.clasticObjects[x].id));for(var x in this.topClastics)!this.topClastics[x]instanceof Gamestack.Sprite&&(this.topClastics[x]=Gamestack.getById(this.topClastics[x].id));for(var x in this.subjects)!this.subjects[x]instanceof Gamestack.Sprite&&(this.subjects[x]=Gamestack.getById(this.subjects[x].id))}return _createClass(GravityForce,[{key:"getArg",value:function(args,key,fallback){return args.hasOwnProperty(key)?args[key]:fallback}},{key:"update",value:function(){var subjects=this.subjects,clasticObjects=this.clasticObjects,topClastics=this.topClastics,accel=this.accel||{},max=this.max||{};__gameStack.each(subjects,function(ix,itemx){itemx.accelY(accel,max),itemx.__inAir=!0,itemx.position.y>=itemx.groundMaxY&&(itemx.position.y=itemx.groundMaxY),itemx.groundMaxY=3e6,__gameStack.each(clasticObjects,function(iy,itemy){itemx.collide_stop(itemy)}),__gameStack.each(topClastics,function(iy,itemy){itemx.collide_stop_top(itemy)})})}}]),GravityForce}(),Force=GravityForce;Gamestack.Force=Force,Gamestack.GravityForce=GravityForce}();var ControllerEventKeys=function ControllerEventKeys(){return _classCallCheck(this,ControllerEventKeys),{left_stick:!1,right_stick:!1,0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,10:!1,11:!1,12:!1,13:!1,14:!1,15:!1,16:!1,17:!1,18:!1,19:!1}};Gamestack.ControllerEventKeys=ControllerEventKeys,GameStack.gamepads=GameStack.gamepads||__gameInstance.gamepads;var GamepadAdapter=function(){function GamepadAdapter(){_classCallCheck(this,GamepadAdapter),this.__gamepads=[],this.intervals=[];var __gamepadMaster=this;this.events=[],window.addEventListener("gamepadconnected",function(e){console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length),__gamepadMaster.mainLoop&&window.clearInterval(__gamepadMaster.mainLoop),__gamepadMaster.mainLoop=window.setInterval(function(){var gps=navigator.getGamepads();__gamepadMaster.gps=gps;for(var x=0;x<gps.length;x++){var events=__gamepadMaster.__gamepads[x]?__gamepadMaster.__gamepads[x]:{};__gamepadMaster.process(__gamepadMaster.gps[x],events)}},20)})}return _createClass(GamepadAdapter,[{key:"gamepads",value:function(){return navigator.getGamepads()}},{key:"disconnect_all",value:function(){for(var x=0;x<this.intervals.length;x++)window.clearInterval(this.intervals[x])}},{key:"disconnect_by_index",value:function(game_pad_index){window.clearInterval(this.intervals[game_pad_index])}},{key:"hasAnyPad",value:function(){return"getGamepads"in navigator}},{key:"Event",value:function(key,game_pad,callback){return{key:key,game_pad:game_pad,callback:callback}}},{key:"GamepadEvents",value:function(args){var gp={};return gp.stick_left=args.stick_left||function(x,y){},gp.stick_right=args.stick_right||function(x,y){},gp.buttons=[],gp.extendFunc=function(f1,f2){return function(x,y){f2(x,y),f1(x,y)}},gp.on=function(key,callback){if(this[key]&&"on"!==key){var current_cb="function"==typeof this[key]?this[key]:function(x,y){};this[key]=this.extendFunc(callback,current_cb)}else if(key.indexOf("button")>=0&&key.indexOf("_")>=0){var number,parts=key.split("_");try{number=parseInt(parts[1]);var current_cb="function"==typeof this.buttons[number]?this.buttons[number]:function(x,y){};this.buttons[number]=this.extendFunc(callback,current_cb)}catch(e){console.error('could not parse "on" event with '+key)}}},gp.constructor={name:"GamepadEvents"},this.__gamepads.push(gp),Gamestack.gamepads=this.__gamepads,gp}},{key:"getGamepads",value:function(){return Gamestack.gamepads}},{key:"process",value:function(gp,gpEvents){this.process_buttons(gp,gpEvents),this.process_axes(gp,gpEvents)}},{key:"process_axes",value:function(gp,events){if(!gp||!gp.axes)return!1;for(var i=0;i<gp.axes.length;i+=2){var ix=(gp.axes[i],gp.axes[i+1],Math.ceil(i/2)+1),x=gp.axes[i],y=gp.axes[i+1];1==ix&&events.stick_left&&events.stick_left(x,y),2==ix&&events.stick_right&&events.stick_right(x,y),this.events&&this.events["stick_"+i]&&"function"==typeof this.events["stick_"+i].callback&&this.events["stick_"+i].callback()}}},{key:"process_buttons",value:function(gp,events){if(!gp||!gp.buttons)return!1;for(var i=0;i<gp.buttons.length&&events.buttons;i++){events.buttons.length>i&&"function"==typeof events.buttons[i]?events.buttons[i](gp.buttons[i].pressed):events.buttons.length>i&&"object"==_typeof(events.buttons[i])&&"function"==typeof events.buttons[i].update&&events.buttons[i].update(events.buttons[i].pressed);var gpc,clearance_1=this.events&&this.events[i],bkey="button_"+i;clearance_1&&(gpc=this.events[bkey]&&!isNaN(this.events[bkey].game_pad)?this.gamepads[this.events[bkey].game_pad]:this.events[bkey].game_pad),clearance_1&&gpc&&"function"==typeof this.events[bkey].callback&&this.events[i].callback()}}},{key:"on",value:function(key,gpix,callback){gpix>=this.__gamepads.length&&this.__gamepads.push(this.GamepadEvents({})),this.__gamepads[gpix].on(key,callback)}}]),GamepadAdapter}();__gameInstance.GamepadAdapter||(Gamestack.GamepadAdapter=new GamepadAdapter),function(){function GSEventLink(extendedObject,extendedKey,extendor,extendorKey){this.parent_id=extendedObject.id,this.child_id=extendor.id,this.parent_key=extendedKey,this.child_key=extendorKey}console.log("GSEvent class... creating");var GSEvent=function GSEvent(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GSEvent),this.name=args.name||"blankEvent",this.objects=args.objects||args.object||args.obj||[],this.siblings=args.siblings||args.sibling||args.sibs||args.sib||[]},InputEvent=function(_GSEvent){function InputEvent(args){_classCallCheck(this,InputEvent);var _this2=_possibleConstructorReturn(this,(InputEvent.__proto__||Object.getPrototypeOf(InputEvent)).call(this,args)),btnix=args.btnix||args.button_ix||!1,gpix=args.gpix||args.gamepad_ix||0,callback=args.callback||function(){},six=args.stickix||args.six||args.stick_ix||!1,inputKey=six!==!1?"stick_"+six:btnix!==!1&&"button_"+btnix,keyboardKeys=args.keys||!1;return keyboardKeys instanceof Array&&(keyboardKeys=makeArray(keyboardKeys),Gamestack.each(keyboardKeys,function(ix,keyitem){Gamestack.InputSystem.extendKey("key_"+keyitem.toLowerCase(),function(){callback(keyitem.toLowerCase())})})),inputKey&&gpix>=0&&Gamestack.GamepadAdapter.on(inputKey,gpix,function(x,y){callback(x,y)}),_this2}return _inherits(InputEvent,_GSEvent),InputEvent}(GSEvent),CollisionEvent=function(_GSEvent2){function CollisionEvent(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arg2=arguments[1],arg3=arguments[2];_classCallCheck(this,CollisionEvent);var _this3=_possibleConstructorReturn(this,(CollisionEvent.__proto__||Object.getPrototypeOf(CollisionEvent)).call(this,args)),callback=function(){};return args&&arg2&&arg3?(_this3.objects=makeArray(args),_this3.siblings=makeArray(arg2),callback=arg3):callback=args.callback||function(){},$Q(_this3.objects).on("collide",$Q(_this3.siblings),function(obj1,obj2){callback(obj1,obj2)}),_this3}return _inherits(CollisionEvent,_GSEvent2),CollisionEvent}(GSEvent),BoolEvent=function(_GSEvent3){function BoolEvent(args){_classCallCheck(this,BoolEvent);var _this4=_possibleConstructorReturn(this,(BoolEvent.__proto__||Object.getPrototypeOf(BoolEvent)).call(this,args));_this4.on=args.on||function(){console.info("CustomBoolEvent():needs .on function(){} returning bool argument")},_this4.callback=args.callback||function(){console.info("CustomBoolEvent():needs .callback function(){} argument")};return console.info("CustomBoolEvent():: this class is due for completion soon, still in development."),_this4}return _inherits(BoolEvent,_GSEvent3),BoolEvent}(GSEvent);Gamestack.GSEvent=GSEvent,Gamestack.GSEventLink=GSEventLink,Gamestack.InputEvent=InputEvent,Gamestack.CollisionEvent=CollisionEvent,Gamestack.BoolEvent=BoolEvent}(),function(){console.log("CanvasStack class... creating");var GSProton=function(){function GSProton(image,canvas,parent,collideables){_classCallCheck(this,GSProton);var args={image:image,canvas:canvas,parent:parent,collideables:collideables};image.image&&image.canvas&&(args=image),args.canvas=args.canvas||Gamestack.canvas,args.parent=args.parent||new Gamestack.Vector(0,0,0),args.image=args.image||new Gamestack.GameImage,this.name=args.name||"__NO-Name",this.description=args.description||"__NO-Description",this.image=args.image,this.active=!1,this.image=args.image,this.canvas=args.canvas,this.emission_amount_min=1,this.emission_amount_max=1,this.radius=0,this.mass=1,this.emissions_frequency=5,this.gravity=0,this.proton={},this.usingAttraction=!1,this.usingRepulsion=!1,this.usingPointZone=!1,this.pointZoneX=0,this.pointZoneY=0,this.usingBlendAlpha=!1,this.attraction={position:new Vector(0,0),min:0,max:0},this.repulsion={position:new Gamestack.Vector(0,0),min:0,max:0},this.startAlpha=1,this.endAlpha=1,this.startColor_asRandom=!0,this.startColor="#FFFFFF",this.startScale=1,this.endScale=1,this.endColor_asRandom=!0,this.endColor="#FFFFFF",this.positionX_asRandom=!1,this.positionY_asRandom=!1,this.positionX=0,this.positionY=0,this.vSpeedMin=.5,this.vSpeedMax=1.5,this.vSpeedRotationMin=0,this.vSpeedRotationMax=360,this.lifeMin=5,this.lifeMax=10;for(var x in this)args.hasOwnProperty(x)&&(this[x]=args[x]);this.initializers=[],this.behaviors=[]}return _createClass(GSProton,[{key:"replaceBehaviorByType",value:function(constructor,replacement){for(var x in this.behaviors)this.behaviors[x]instanceof constructor&&this.behaviors.splice(x,1);this.behaviors.push(replacement),this.ticker=0}},{key:"Collideables",value:function(collideableArray){this.collideables=collideableArray}},{key:"Rotation",value:function(minRot,maxRot){maxRot=maxRot||minRot,this.vSpeedRotationMin=minRot,this.vSpeedRotationMax=maxRot,this.replaceBehaviorByType(Proton.V,new Proton.V(new Proton.Span(this.vSpeedMin,this.vSpeedMax),new Proton.Span(this.vSpeedRotationMin,this.vSpeedRotationMax),"polar"))}},{key:"Gravity",value:function(grav){this.gravity=grav,this.replaceBehaviorByType(Proton.Gravity,new Proton.Gravity(this.gravity))}},{key:"Velocity",value:function(minV,maxV){maxV=maxV||minV,this.vSpeedMin=minV,this.vSpeedMax=maxV,this.replaceBehaviorByType(Proton.V,new Proton.V(new Proton.Span(this.vSpeedMin,this.vSpeedMax),new Proton.Span(this.vSpeedRotationMin,this.vSpeedRotationMax),"polar"))}},{key:"Attraction",value:function(position,min,max){this.usingAttraction=!0,this.attraction.position=position,this.attraction.min=min,this.attraction.max=max}},{key:"Repulsion",value:function(x,y,min,max){this.usingRepulsion=!0,this.repulsion.position=position,this.repulsion.min=min,this.repulsion.max=max}},{key:"onUpdate",value:function(){}},{key:"isRectangularCollision",value:function(obj1,obj2){return obj1.position.x+obj1.size.x>obj2.position.x&&obj1.position.y+obj1.size.y>obj2.position.y&&obj1.position.x<obj2.position.x+obj2.size.x&&obj1.position.y<obj2.position.y+obj2.size.y}},{key:"collide",value:function(obj1,obj2){console.log("collide() function UNSET")}},{key:"update",value:function(collideables){collideables=collideables||this.collideables||[],this.ticker+=1,this.ticker%100==0&&(console.log("Proton:update():"),console.log(this.emitter)),this.positionX_asRandom?this.emitter.p.x=Math.floor(Math.random()*canvas.width):this.emitter.p.x=this.positionX,this.positionY_asRandom?this.emitter.p.y=Math.floor(Math.random()*canvas.width):this.emitter.p.y=this.positionY;for(var particles=this.emitter.particles,x=0;x<particles.length;x++)for(var p={size:{x:Math.round(this.emitter.initializes[0].w*this.emitter.scale),y:Math.round(this.emitter.initializes[0].h*this.emitter.scale)},position:particles[x].p},y=0;y<collideables.length;y++)collideables[y].hasOwnProperty("position")&&collideables[y].hasOwnProperty("size")&&this.isRectangularCollision(p,collideables[y])&&this.collide(p,collideables[y])}},{key:"init",value:function(){function allNumbers(list){for(var x in list)if("number"!=typeof list[x])return!1;return!0}this.proton=new Proton,this.emit_mode=this.emit_mode||"",this.emitter=new Proton.Emitter,this.emission_amount=this.emission_amount||10,this.emissions_frequency=this.emissions_frequency||10;var rps=5/this.emissions_frequency;this.emitter.rate=new Proton.Rate([this.emission_amount_min,this.emission_amount_max],rps),this.initializers=[],this.behaviors=[],this.initializers.push(new Proton.ImageTarget(this.image)),this.initializers.push(new Proton.Mass(this.mass)),this.initializers.push(new Proton.Life(this.lifeMin,this.lifeMax)),this.initializers.push(new Proton.V(new Proton.Span(this.vSpeedMin,this.vSpeedMax),new Proton.Span(this.vSpeedRotationMin,this.vSpeedRotationMax),"polar")),this.usingPointZone&&this.initializers.push(new Proton.Position(new Proton.PointZone(this.pointZoneX,this.pointZoneY))),this.behaviors.push(new Proton.Gravity(this.gravity)),this.behaviors.push(new Proton.Alpha(1,[this.startAlpha,this.endAlpha])),this.behaviors.push(new Proton.Color(this.startColor_asRandom?"random":this.startColor,this.endColor_asRandom?"random":this.endColor,1/0,Proton.easeInSine)),this.behaviors.push(new Proton.Scale(this.startScale,this.endScale)),allNumbers([this.attractionX,this.attractionY,this.attractionMin,this.attractionMax])&&(console.info("Creating attraction"),this.behaviors.push(new Proton.Attraction({x:this.attractionX,y:this.attractionY},this.attractionMin,this.attractionMax))),allNumbers([this.repulsionX,this.repulsionY,this.repulsionMin,this.repulsionMax])&&(console.info("Creating repulsion"),this.behaviors.push(new Proton.Repulsion({x:this.repulsionX,y:this.repulsionY},this.repulsionMin,this.repulsionMax))),this.usingAttraction&&this.behaviors.push(new Proton.Attraction(this.attraction.position,this.attraction.min,this.attraction.max)),this.usingRepulsion&&this.behaviors.push(new Proton.Repulsion(this.repulsion.position,this.repulsion.min,this.repulsion.max)),this.radius>0&&this.initializers.push(new Proton.Radius(this.radius));var i=this.initializers;for(var x in i)this.emitter.addInitialize(i[x]);var b=this.behaviors;for(var x in b)this.emitter.addBehaviour(b[x]);this.emitter.p=this.parent&&this.parent.hasOwnProperty("x")?new Vector(this.parent):this.emitter.p,this.emitter.p=this.parent&&this.parent.hasOwnProperty("position")&&this.parent.position.hasOwnProperty("x")?new Vector(this.parent.position):this.emitter.p,this.emitter.p.x+=this.positionX,this.emitter.p.y+=this.positionY,this.emitter.emit(),this.proton.addEmitter(this.emitter),this.renderer=new Proton.Renderer("canvas",this.proton,this.canvas),this.usingBlendAlpha&&this.renderer.blendFunc("SRC_ALPHA","ONE");this.renderer.start(),this.tick()}},{key:"on",value:function(){this.init()}},{key:"off",value:function(){this.emitter&&this.emitter.stopEmit&&this.emitter.stopEmit()}},{key:"tick",value:function(){requestAnimationFrame(function(){__inst.tick()});var __inst=this;this.proton.update()}}]),GSProton}();Gamestack.GSProton=GSProton}();var head=document.head||document.getElementsByTagName("head")[0];head.innerHTML+='<style>\r\n.speech-triangle { overflow:visible; }.speech-triangle:before { content: "";position: absolute;z-index:-1;width: 0;height: 0;left: 38px;bottom: -18px;border-width: 8px 8px;border-style: solid;border-color: #fff transparent transparent #fff; } .farLeft:after{ right:0px; left:20px; } .farRight:after{ left:0px; right:20px; }   .flipX:after{  -moz-transform: scaleX(-1); -webkit-transform: scaleX(-1); -o-transform: scaleX(-1); transform: scaleX(-1); -ms-filter: fliph; /*IE*/ filter: fliph; /*IE*/  }  </style>',function(){console.log("HtmlExtra classes... creating");var HtmlExtra=function(){function HtmlExtra(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,HtmlExtra),this.applyCSSArgs(args)}return _createClass(HtmlExtra,[{key:"applyCSSArgs",value:function(args){var norms=Gamestack.normalArgs(args);this.widthFloat=Gamestack.getArg(norms,["width","widthfloat","w"],.5),this.heightFloat=Gamestack.getArg(norms,["height","heightfloat","h"],.5),this.topFloat=Gamestack.getArg(norms,["top","topfloat","t"],.5),this.bottomFloat=Gamestack.getArg(norms,["bottom","bottomfloat","b"],!1),this.color=norms.color||"#ffffff",this.backgroundColor=Gamestack.getArg(norms,["backgroundcolor","backcolor","background","bc"],"black"),this.text=norms.text||"__BLANK",this.fontFamily=norms.font||norms.fontFamily||"appFont",this.border="2px inset "+this.color,this.fontSize=norms.fontsize||"20px",this.bottomFloat>=0?this.targetBottom=this.get_float_pixels(this.bottomFloat,document.body.clientHeight):this.targetTop=this.get_float_pixels(this.topFloat,document.body.clientHeight),this.fadeTime={"in":200,out:200}}},{key:"Top",value:function(v){return this.targetTop=this.get_float_pixels(v,document.body.clientHeight),this.domElement.style.bottom="auto",this.domElement.style.top=this.targetTop,this}},{key:"Left",value:function(v){return this.targetLeft=this.get_float_pixels(v,document.body.clientWidth),this.domElement.style.right="auto",this.domElement.style.left=this.targetLeft,this}},{key:"Bottom",value:function(v){return this.targetBottom=this.get_float_pixels(v,document.body.clientHeight),this.domElement.style.top="auto",this.domElement.style.bottom=this.targetBottom,this}},{key:"Right",value:function(v){return this.targetRight=this.get_float_pixels(v,document.body.clientWidth),this.domElement.style.left="auto",this.domElement.style.right=this.targetRight,this}},{key:"FontSize",value:function(v){return this.domElement.style.fontSize=v,this}},{key:"FontFamily",value:function(v){return this.domElement.style.fontFamily=v,this}},{key:"FontSize",value:function(v){return this.domElement.style.fontSize=v,this}},{key:"Text",value:function(v){return this.domElement.innerText=v,this}},{key:"Background",value:function(v){return this.domElement.style.background=v,this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"FadeTime",value:function(fadeInTime,fadeOutTime){return this.fadeTime={"in":fadeInTime||250,out:fadeOutTime||250},this}},{key:"Color",value:function(c){return this.domElement.style.color=c,this}},{key:"get_float_pixels",value:function(float,dimen){return Math.round(dimen*float)+"px"}},{key:"onComplete",value:function(fun){return this.complete=fun,this}},{key:"show",value:function(text,duration){document.body.append(this.domElement);var __inst=this;this.show_interval&&clearInterval(this.show_interval),this.show_interval=setInterval(function(){var o=parseFloat(__inst.domElement.style.opacity);o<1&&(o+=1*(20/__inst.fadeTime["in"]),__inst.domElement.style.opacity=o)},20),setTimeout(function(){clearInterval(__inst.show_interval),__inst.hide_interval=setInterval(function(){var o=parseFloat(__inst.domElement.style.opacity);o>0?(o-=1*(20/__inst.fadeTime.out),__inst.domElement.style.opacity=o):(__inst.domElement.style.opacity=o,"function"==typeof __inst.complete&&__inst.complete(),clearInterval(__inst.hide_interval))},20)},__inst.duration)}},{key:"update",value:function(){}}]),HtmlExtra}(),TextDisplay=function(_HtmlExtra){function TextDisplay(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,TextDisplay);var _this5=_possibleConstructorReturn(this,(TextDisplay.__proto__||Object.getPrototypeOf(TextDisplay)).call(this,args));return args||(args={}),_this5.duration=args.duration||5e3,_this5.complete=args.complete||function(){},_this5.create_dom(),_this5}return _inherits(TextDisplay,_HtmlExtra),_createClass(TextDisplay,[{key:"create_dom",value:function(){this.domElement=document.createElement("SPAN"),this.domElement.style.position="fixed",this.domElement.style.color=this.color,this.domElement.style.padding="10px",!this.targetBottom>=0?this.domElement.style.top=Math.round(document.body.clientHeight*this.topFloat)+"px":this.domElement.style.bottom=Math.round(document.body.clientHeight*this.bottomFloat)+"px",!this.targetRight>=0?this.domElement.style.left=Math.round(document.body.clientWidth*this.leftFloat)+"px":this.domElement.style.right=Math.round(document.body.clientWidth*this.rightFloat)+"px",this.domElement.style.width="90%",this.domElement.style.left="5%",this.domElement.style.height="auto",this.domElement.style.fontFamily=this.fontFamily,this.domElement.style.fontSize=this.fontSize,this.domElement.style.display="block",this.domElement.style.textAlign="center",this.domElement.style.zIndex="9999",this.domElement.innerText=this.text,this.domElement.textContent=this.text,this.domElement.style.backgroundColor="transparent",this.domElement.style.opacity=this.fadeIn?0:1,this.domElement.id=GameStack.create_id()}}]),TextDisplay}(HtmlExtra);Gamestack.TextDisplay=TextDisplay;var ImageStatDisplay=function(_HtmlExtra2){function ImageStatDisplay(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ImageStatDisplay);var _this6=_possibleConstructorReturn(this,(ImageStatDisplay.__proto__||Object.getPrototypeOf(ImageStatDisplay)).call(this,args));return _this6.src=args.src||"__NONE",_this6.size=args.size||new Vector3(50,50),_this6.text_id=GameStack.create_id(),_this6.id=GameStack.create_id(),_this6.img_id=GameStack.create_id(),_this6.create_dom(),_this6}return _inherits(ImageStatDisplay,_HtmlExtra2),_createClass(ImageStatDisplay,[{key:"setValue",value:function(value){document.getElementById(this.text_id)}},{key:"get_float_pixels",value:function(float,dimen){return Math.round(dimen*float)+"px"}},{key:"get_id",value:function(){return this.id}},{key:"update",value:function(v){var e=document.getElementById(this.text_id);this.text=v+"",e.innerText=this.text}},{key:"create_dom",value:function(){this.domElement=document.createElement("DIV"),this.domElement.setAttribute("class","gameStack-stats"),this.domElement.innerHTML+='<img style="float:left;" width="'+this.size.x+'" height="'+this.size.y+'" id="'+this.img_id+'" src="'+this.src+'"/>',this.domElement.style.color=this.color,this.domElement.innerHTML+='<span id="'+this.text_id+'" style="padding:5px; vertical-align:middle; display:table-cell; font-size:'+this.fontSize+"; color:"+this.color+';">'+this.text+"</span>",this.domElement.style.position="fixed",this.domElement.style.fontFamily=this.fontFamily,this.domElement.style.fontSize=this.fontSize,this.domElement.style.zIndex="9999",this.domElement.id=this.id}},{key:"show",value:function(x,y){this.domElement.style.left=x+"px",this.domElement.style.top=y+"px",document.body.append(this.domElement)}}]),ImageStatDisplay}(HtmlExtra);Gamestack.ImageStatDisplay=ImageStatDisplay;var Bar=function(){function Bar(background,border){_classCallCheck(this,Bar),this.background=background;var e=document.createElement("SPAN");e.style.position="fixed",e.style.background=this.background,e.style.zIndex="9999",e.style.backgroundSize="100% 100%",e.style.backgroundPosition="center bottom",border&&(e.style.border=border),this.domElement=e}return _createClass(Bar,[{key:"width",value:function(w){return this.domElement.style.width=w,this}},{key:"height",value:function(h){return this.domElement.style.height=h,this}}]),Bar}();Gamestack.Bar=Bar;var BarFill=function(){function BarFill(background){_classCallCheck(this,BarFill),this.background=background;var e=document.createElement("SPAN");e.style.background=this.background,e.style.position="fixed",e.style.zIndex="9995",this.domElement=e}return _createClass(BarFill,[{key:"width",value:function(w){return this.domElement.style.width=w,this}},{key:"height",value:function(h){return this.domElement.style.height=h,this}}]),BarFill}();Gamestack.BarFill=BarFill;var BarDisplay=function(_HtmlExtra3){function BarDisplay(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,BarDisplay);var _this7=_possibleConstructorReturn(this,(BarDisplay.__proto__||Object.getPrototypeOf(BarDisplay)).call(this,args));return _this7.border=args.border||"none",args.fill_src?_this7.fill=new BarFill(args.fill_src).width(args.fill_width||"80px").height(args.fill_height||"10px"):_this7.fill=args.fill||new BarFill(args.fill_color||"green").width(args.fill_width||"80px").height(args.fill_height||"10px"),args.bar_src?_this7.bar=new Bar(args.bar_src,_this7.border).width(args.bar_width||"80px").height(args.bar_height||"10px"):_this7.bar=new Bar(args.bar_color||"goldenrod",_this7.border).width(args.bar_width||"80px").height(args.bar_height||"10px"),_this7}return _inherits(BarDisplay,_HtmlExtra3),_createClass(BarDisplay,[{key:"show",value:function(){document.body.append(this.fill.domElement),document.body.append(this.bar.domElement)}},{key:"get_float_pixels",value:function(float,dimen){return Math.round(dimen*float)+"px"}},{key:"portion_top",value:function(v){this.fill.domElement.style.top=this.get_float_pixels(v||this.topFloat,GameStack.HEIGHT),this.bar.domElement.style.top=this.get_float_pixels(v||this.topFloat,GameStack.HEIGHT)}},{key:"portion_left",value:function(v){this.fill.domElement.style.left=this.get_float_pixels(v||this.leftFloat,GameStack.WIDTH),this.bar.domElement.style.left=this.get_float_pixels(v||this.leftFloat,GameStack.WIDTH)}},{key:"portion_width",value:function(w){this.fill.domElement.style.width=this.get_float_pixels(w||this.widthFloat,GameStack.WIDTH),this.bar.domElement.style.width=this.get_float_pixels(w||this.widthFloat,GameStack.WIDTH)}},{key:"portion_height",value:function(h){this.fill.domElement.style.height=this.get_float_pixels(h||this.heightFloat,GameStack.HEIGHT),this.bar.domElement.style.height=this.get_float_pixels(h||this.heightFloat,GameStack.HEIGHT)}},{key:"update",value:function(f){this.fill.domElement.style.width=this.get_float_pixels(f||0,parseFloat(this.bar.domElement.style.width))}}]),BarDisplay}(HtmlExtra);Gamestack.BarDisplay=BarDisplay;var TextBubble=function(_HtmlExtra4){function TextBubble(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,TextBubble);var _this8=_possibleConstructorReturn(this,(TextBubble.__proto__||Object.getPrototypeOf(TextBubble)).call(this,args));return _this8.opacity=args.opacity||.85,_this8.create_dom(),_this8.duration=args.stay||args.duration||100*_this8.text.length,_this8}return _inherits(TextBubble,_HtmlExtra4),_createClass(TextBubble,[{key:"create_dom",value:function(){this.domElement=document.createElement("SPAN"),this.domElement.setAttribute("class","speech-triangle"),this.domElement.style.textAlign="left",this.domElement.style.opacity=this.opacity,this.domElement.style.position="fixed",this.domElement.style.color=this.color||"white","transparent"==this.backgroundColor&&(this.backgroundColor="black"),this.domElement.style.backgroundColor=this.backgroundColor||"black",this.domElement.style.borderRadius="0.4em",this.domElement.style.border=this.border||"1px outset snow",this.domElement.style.borderColor=this.borderColor||"snow",this.domElement.style.padding="5px",this.domElement.style.paddingBottom="2px",this.domElement.style.height="auto",this.domElement.style.top=Math.round(document.body.clientHeight*this.topFloat)+"px",this.domElement.style.left=Math.round(document.body.clientWidth*this.leftFloat)+"px",this.domElement.style.width="auto",this.domElement.style.height="auto",this.domElement.style.fontFamily=this.fontFamily,this.domElement.style.fontSize=this.fontSize,this.domElement.style.display="block",this.domElement.style.textAlign="center",this.domElement.style.zIndex="9999",this.domElement.innerText=this.text,this.domElement.textContent=this.text,this.domElement.style.opacity=this.fadeIn?0:this.opacity,this.domElement.id=GameStack.create_id()}}]),TextBubble}(HtmlExtra);Gamestack.TextBubble=TextBubble}();var Level=function(){function Level(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Level),this.sprites=args.sprites||[],this.backgrounds=args.backgrounds||[],this.terrains=args.terrains||[],this.interactives=args.interactives||[],this.threes=args.threes||[]}return _createClass(Level,[{key:"add",value:function(){}},{key:"add_all_to_game",value:function(){}}]),Level}();!function(){console.log("Line() class... creating");var Curves={linearNone:function(t){return t},easeInQuadratic:function(t){return t*t},easeOutQuadratic:function(t){return t*(2-t)},easeInOutQuadratic:function(t){return t<.5?2*t*t:-1+(4-2*t)*t},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuartic:function(t){return t*t*t*t},easeOutQuartic:function(t){return 1- --t*t*t*t},easeInOutQuartic:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuintic:function(t){return t*t*t*t*t},easeOutQuintic:function(t){return 1+--t*t*t*t*t},easeInOutQuintic:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}};Gamestack.Curves=Curves;var inOutCurves={quadratic:function(t){return t<.5?2*t*t:-1+(4-2*t)*t},cubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},quartic:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},quintic:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},linear:function(t){return t}};Gamestack.Curves.InOut=inOutCurves;var Line=function(){function Line(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Line),this.points=[],this.pointDisp=1,this.size=args.size||new Gamestack.Vector(100,100,0),
this.position=new Gamestack.Vector(0,0,0)}return _createClass(Line,[{key:"Rot",value:function(r){return this.rotation=r,this}},{key:"Pos",value:function(p){return this.position=p,"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):this.position=p,this}},{key:"Size",value:function(s){return this.size=s,"number"==typeof s&&(this.size=new Gamestack.Vector(s,s,s)),this}},{key:"Dispersion",value:function(num){return this.pointDisp=num,this}},{key:"Curve",value:function(c,size){return this.curve=c,this.curveMethod=Gamestack.Curves.InOut[this.curve.toLowerCase()],c&&(this.curve_size=new Gamestack.Vector(size)),this}},{key:"CurveSize",value:function(s){return"number"==typeof s?this.curve_size=new Gamestack.Vector(s,s,s):this.curve_size=s,this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"Fill",value:function(){for(var current_point=new Gamestack.Vector(0,0,0),x=0;x<=Math.abs(this.size.x);x++){var position=new Gamestack.Vector(x,0,0);current_point.trig_distance_xy(position)>=this.pointDisp&&(this.points.push(new Gamestack.Vector(position)),current_point=new Gamestack.Vector(position))}return this.TransposeByRotation(this.rotation),this}},{key:"TransposeByRotation",value:function(rotation){function rotate(cx,cy,x,y,angle){var radians=Math.PI/180*angle,cos=Math.cos(radians),sin=Math.sin(radians),nx=cos*(x-cx)+sin*(y-cy)+cx,ny=cos*(y-cy)-sin*(x-cx)+cy;return new Gamestack.Vector(nx,ny)}this.rotation=rotation;for(var x=0;x<this.points.length;x++){var p=this.points[x],np=rotate(this.position.x,this.position.y,p.x,p.y,this.rotation);this.points[x]=np}return this}},{key:"Highlight",value:function(sprite,ctx,gameWindow){this.highlight_sprites=this.highlight_sprites||[],ctx=ctx||Gamestack.ctx;var points=this.points;gameWindow=gameWindow||Gamestack.game_windows[0];for(var x in points){console.log(points[x]),this.highlight_sprites[x]||(this.highlight_sprites[x]=gameWindow.add(new Gamestack.Sprite(sprite),ctx));var point=points[x];this.highlight_sprites[x].position=new Gamestack.Vector(point.sub(this.highlight_sprites[x].size.div(2)))}return this}},{key:"RemoveHighlight",value:function(sprite,ctx,gameWindow){gameWindow=gameWindow||Gamestack.game_windows[0];for(var x in this.highlight_sprites)gameWindow.remove(this.highlight_sprites[x]);return this.highlight_sprites=[],this}}]),Line}();Gamestack.Line=Line;var WaveLine=function(_Line){function WaveLine(pos,size,curve_key){_classCallCheck(this,WaveLine);var args={};if("number"==typeof size||size instanceof Gamestack.Vector)var _this9=_possibleConstructorReturn(this,(WaveLine.__proto__||Object.getPrototypeOf(WaveLine)).call(this,{}));else if(size instanceof Object){var _this9=_possibleConstructorReturn(this,(WaveLine.__proto__||Object.getPrototypeOf(WaveLine)).call(this,size));args=size}return _this9.Pos(pos),_this9.Size(size),_this9.curve_options=Curves,curve_key=curve_key||args.curve_key||"quadratic",_this9.curve=curve_key?curve_key.toLowerCase():"quadratic",_this9.curve_options=["cubic","quartic","quadratic","quintic","sine"],_this9.curveMethod=Gamestack.Curves.InOut[_this9.curve.toLowerCase()],_this9.points=args.points||[],_this9.is_highlighted=args.is_highlighted||!1,_this9.offset=args.offset||new Gamestack.Vector(0,0,0),_this9.pointDisp=args.pointDisp||5,_this9.rotation=args.rotation||0,_this9.iterations=args.iterations||1,_this9.max_size=args.max_size||_this9.size||new Gamestack.Vector(5e3,5e3),_this9.growth=args.growth||1,_possibleConstructorReturn(_this9)}return _inherits(WaveLine,_Line),_createClass(WaveLine,[{key:"Max",value:function(p){return this.target=p,"number"==typeof p?this.target=new Gamestack.Vector(p,p,p):this.target=p,this.max=this.target,this}},{key:"Min",value:function(p){return this.position=p,"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):this.tposition=p,this.min=this.position,this}},{key:"Decay",value:function(n){return n<-1&&(n=-1),n>1&&(n=1),this.growth=1-n,this}},{key:"next",value:function(position){for(var found=!1,x=0;x<this.points.length;x++){if(position.equals(this.points[x])&&x<this.points.length-1)return found=!0,new Gamestack.Vector(this.points[x+1]);if(x==this.points.length-1&&!found)return new Gamestack.Vector(this.points[0])}}},{key:"getGraphCanvas",value:function(curveCall,existing_canvas){var canvas=existing_canvas||document.createElement("canvas");canvas.style.position="relative",canvas.id="curve-display",canvas.setAttribute("class","motion-curve"),canvas.width=180,canvas.height=100,canvas.style.background="black";var context=canvas.getContext("2d");context.fillStyle="rgb(0,0,0)",context.fillRect(0,0,180,100),context.lineWidth=.5,context.strokeStyle="rgb(230,230,230)",context.beginPath(),context.moveTo(0,20),context.lineTo(180,20),context.moveTo(0,80),context.lineTo(180,80),context.closePath(),context.stroke(),context.lineWidth=2,context.strokeStyle="rgb(255,127,127)";var position={x:0,y:80},position_old={x:0,y:80};this.test_graph_size=new Gamestack.Vector(185,60);var points=this.get_line_segment(this.test_graph_size,5,curveCall);for(var x in points){var position=new Gamestack.Vector(points[x].x,this.test_graph_size.y+20-points[x].y);context.beginPath(),context.moveTo(position_old.x,position_old.y),context.lineTo(position.x,position.y),context.closePath(),context.stroke(),position_old.x=position.x,position_old.y=position.y}return canvas}},{key:"Fill",value:function(){this.size=new Gamestack.Vector(this.size);this.points=[];for(var current_point=new Gamestack.Vector(this.position),x=1,max_recursion=300,position=current_point,dist=new Gamestack.Vector(20,20,20),size=new Gamestack.Vector(this.curve_size||this.size);Math.abs(position.x)<=Math.abs(this.max_size.x)&&size.x>2&&dist.x>2;){position=new Gamestack.Vector(current_point);var target=new Gamestack.Vector(position.add(size)),start=new Gamestack.Vector(position),curveMethod=this.curveMethod;new Gamestack.Vector(start);for(position.x=position.x;position.x<Math.abs(target.x);position.x+=1){dist=position.sub(start);var pct=dist.x/size.x;if(position.y=start.y+curveMethod(pct)*(x%2==0?size.y:size.y*-1),current_point.trig_distance_xy(position)>=this.pointDisp){var p=new Gamestack.Vector(position);this.points.push(p),current_point=new Gamestack.Vector(position)}}if(size=size.mult(this.growth),x>max_recursion)return console.error("Too much recursion in SwagLine");x+=1}return this.TransposeByRotation(this.rotation),this}},{key:"Rotate",value:function(rotation){return this.rotation=rotation,"object"==_typeof(this.rotation)&&(this.rotation=this.rotation.x),this}}]),WaveLine}(Line);Gamestack.WaveLine=WaveLine;var ShapeLine=function(_Line2){function ShapeLine(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ShapeLine);var _this10=_possibleConstructorReturn(this,(ShapeLine.__proto__||Object.getPrototypeOf(ShapeLine)).call(this,args));return _this10.targetTotalPoints=args.total||200,_this10}return _inherits(ShapeLine,_Line2),_createClass(ShapeLine,[{key:"Total",value:function(t){return this.targetTotalPoints=t,this}},{key:"Eliptical",value:function(pos,size,rotation){function fill(elipse){elipse.points=[];for(var center=elipse.position.add(elipse.size.div(2)),current_point=new Gamestack.Vector(0,0,0),a=Math.abs(elipse.size.x/2),b=Math.abs(elipse.size.y/2),step=(2*Math.PI*Math.sqrt(a*a+b*b),2*Math.PI/elipse.targetTotalPoints),i=0*Math.PI;i<2*Math.PI;i+=step){var p=new Gamestack.Vector(center.x-a*Math.cos(i),center.y+b*Math.sin(i));elipse.points.push(new Gamestack.Vector(p)),current_point=new Gamestack.Vector(p)}}return this.Pos(pos||this.position),this.Size(size||this.size),this.Rot(rotation||this.rotation),fill(this),this.Fill=function(){return fill(this),this},this}},{key:"Quadrilateral",value:function(pos,size,rotation){function fill(quad){quad.points=[];for(var perim=(new Gamestack.Vector(0,0,0),2*quad.size.x+2*quad.size.y),stepX=quad.size.x/(quad.targetTotalPoints*(quad.size.x/perim)),stepY=quad.size.y/(quad.targetTotalPoints*(quad.size.y/perim)),x=0;x<quad.size.x;x+=stepX){var p1=new Gamestack.Vector(x,0).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}for(var y=0;y<quad.size.y;y+=stepY){var p1=new Gamestack.Vector(quad.size.x,y).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}for(var x=quad.size.x;x>=0;x-=stepX){var p1=new Gamestack.Vector(x,quad.size.y).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}for(var y=quad.size.y;y>=0;y-=stepY){var p1=new Gamestack.Vector(0,y).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}}return this.Pos(pos||this.position),this.Size(size||this.size),this.Rot(rotation||this.rotation),fill(this),this.Fill=function(){return fill(this),this},this}}]),ShapeLine}(Line);Gamestack.ShapeLine=ShapeLine}(),function(){console.log("Motion class... creating");var Motion=function(_GSO){function Motion(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Motion);var _this11=_possibleConstructorReturn(this,(Motion.__proto__||Object.getPrototypeOf(Motion)).call(this,args));return _this11.state_save=!1,_this11.parent=args.parent||Gamestack.Extendors.applyParentalArgs(_this11,args),Gamestack.Extendors.informable(_this11,args),Gamestack.Extendors.tweenable(_this11,args),_this11}return _inherits(Motion,_GSO),_createClass(Motion,[{key:"restoreState",value:function(){for(var x in this.state_save)this.parent[x]=this.state_save[x]}}]),Motion}(GSO),TweenMotion=function(_Motion){function TweenMotion(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,TweenMotion);var _this12=_possibleConstructorReturn(this,(TweenMotion.__proto__||Object.getPrototypeOf(TweenMotion)).call(this,args));return _this12.getArg=$Q.getArg,_this12.transition=args.trans||args.transition||"literal"||"add",_this12.transition_options=["literal","add"],"string"==typeof args.curve&&(args.curve_string=args.curve),_this12.setTweenCurve(args.curve_string),_this12.target=!1,args.target&&(_this12.target=args.target),_this12.curvesList=_this12.curvesToArray(),_this12.duration=Gamestack.getArg(args,"duration",500),_this12.delay=Gamestack.getArg(args,"delay",0),_this12}return _inherits(TweenMotion,_Motion),_createClass(TweenMotion,[{key:"targetCheck",value:function(parent){this.target.position||(this.target.position=new Vector),this.target.size||(this.target.size=new Vector),this.target.rotation||(this.target.rotation=new Vector)}},{key:"engage",value:function(){var __inst=this;__inst.call_on_run(),this.tweens=[];var object=this.parent;this.targetCheck(),this.state_save||(this.state_save={position:new Gamestack.Vector(this.parent.position),rotation:new Gamestack.Vector(this.parent.rotation),size:new Gamestack.Vector(this.parent.size)}),this.parent&&!this.target?this.target={position:new Gamestack.Vector(this.parent.position),rotation:new Gamestack.Vector(this.parent.rotation),size:new Gamestack.Vector(this.parent.size)}:this.target||(this.target={position:new Gamestack.Vector,rotation:new Gamestack.Vector,size:new Gamestack.Vector}),"literal"!==this.transition&&(this.target.position=object.position.add(this.target.position),this.target.rotation=object.rotation.add(this.target.rotation),this.target.size=object.size.add(this.target.size)),this.tweens.push(new TWEEN.Tween(object.position).easing(__inst.curve||__inst.motion_curve).to(this.target.position,__inst.duration).onUpdate(function(){}).onComplete(function(){__inst.complete&&__inst.call_on_complete()})),this.tweens.push(new TWEEN.Tween(object.rotation).easing(__inst.curve||__inst.motion_curve).to(this.target.rotation,__inst.duration).onUpdate(function(){}).onComplete(function(){__inst.complete&&__inst.call_on_complete()})),this.tweens.push(new TWEEN.Tween(object.size).easing(__inst.curve||__inst.motion_curve).to(this.target.size,__inst.duration).onUpdate(function(){}).onComplete(function(){__inst.complete&&__inst.call_on_complete()}));for(var x=0;x<this.tweens.length;x++)this.tweens[x].start()}},{key:"start",value:function(){this.engage()}},{key:"getGraphCanvas",value:function(t,f,c){var canvas=c||document.createElement("canvas");canvas.style.position="relative",canvas.id="curve-display",canvas.setAttribute("class","motion-curve"),canvas.width=180,canvas.height=100,canvas.style.background="black";var context=canvas.getContext("2d");context.fillStyle="rgb(0,0,0)",context.fillRect(0,0,180,100),context.lineWidth=.5,context.strokeStyle="rgb(230,230,230)",context.beginPath(),context.moveTo(0,20),context.lineTo(180,20),context.moveTo(0,80),context.lineTo(180,80),context.closePath(),context.stroke(),context.lineWidth=2,context.strokeStyle="rgb(255,127,127)";var position={x:5,y:80},position_old={x:5,y:80};return new TWEEN.Tween(position).to({x:175},2e3).easing(TWEEN.Easing.Linear.None).start(),new TWEEN.Tween(position).to({y:20},2e3).easing(f).onUpdate(function(){context.beginPath(),context.moveTo(position_old.x,position_old.y),context.lineTo(position.x,position.y),context.closePath(),context.stroke(),position_old.x=position.x,position_old.y=position.y}).start(),canvas}},{key:"getTweenPoints",value:function(size,line){var points=(line.curve,line.duration,[]),position=new Vector(line.position);new Vector(position).add(size),new Vector(position),new Vector(0,0,0);return points}}]),TweenMotion}(Motion);Gamestack.TweenMotion=TweenMotion;var LineMotion=function(_Motion2){function LineMotion(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,LineMotion);var _this13=_possibleConstructorReturn(this,(LineMotion.__proto__||Object.getPrototypeOf(LineMotion)).call(this,args));return Gamestack.Extendors.spatial(_this13),_this13.Size(args.size||new Gamestack.Vector(200,200)),_this13.Pos(args.size||new Gamestack.Vector(200,200)),_this13.Rot(args.size||new Gamestack.Vector(200,200)),_this13}return _inherits(LineMotion,_Motion2),_createClass(LineMotion,[{key:"Highlight",value:function(spr,ctx,gameWindow){return this.line.Highlight(spr,ctx,gameWindow),this}},{key:"Eliptical",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=(new Gamestack.ShapeLine).Eliptical(pos,size,0).Fill(),this}},{key:"Box",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=(new Gamestack.ShapeLine).Quadrilateral(pos,size,0).Fill(),this}},{key:"QuadraticWave",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=new Gamestack.WaveLine(pos,size,"quadratic").Fill(),this}},{key:"CubicWave",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=new Gamestack.WaveLine(pos,size,"cubic").Fill(),this}},{key:"QuinticWave",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=new Gamestack.WaveLine(pos,size,"quintic").Fill(),this}}]),LineMotion}(Motion);Gamestack.LineMotion=LineMotion}();var Projectile=function(){function Projectile(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Projectile),this.getArg=$Q.getArg;for(var x in args)this[x]=args[x];this.name=args.name||"__",this.description=args.description||"__",this.animation=Gamestack.getArg(args,"animation",new Animation),this.parent_id=args.parent_id||args.object_id||"__blank",this.name=Gamestack.getArg(args,"name","__"),this.size=!1,args.size?this.size=new Vector(args.size):this.animation&&this.animation.frameSize?this.size=new Vector(this.animation.frameSize):(console.info("Projectile():using default size."),this.size=new Vector(20,20,20)),this.origin=args.origin||new Vector(0,0,0),this.rotation=args.rotation||0,this.line.Rotation(this.rotation),this.description=Gamestack.getArg(args,"description",!1),this.duration=Gamestack.getArg(args,"duration",500),this.delay=Gamestack.getArg(args,"delay",0),this.position=Gamestack.getArg(args,"position",new Vector(0,0,0)),this.motion_curve=Gamestack.getArg(args,"motion_curve",TWEEN.Easing.Linear.None),this.highlighted=!1,this.sprites=[],this.run_ext=args.run_ext||[]}return _createClass(Projectile,[{key:"onComplete",value:function(fun){this.complete=fun}},{key:"onCollide",value:function(fun){this.collide=fun}},{key:"setAnimation",value:function(anime){return this.animation=anime,this}},{key:"setMotionCurve",value:function(c){return this.motion_curve=c,this}},{key:"kill_one",value:function(){var spr=this.sprites[this.sprites.length-1];Gamestack.remove(spr)}},{key:"onRun",value:function(caller,callkey){this.run_ext=this.run_ext||[],this.run_ext.push({caller:caller,callkey:callkey})}},{key:"shoot_basic",value:function(position,size,rot_offset,speed,numberShots,disp){for(var bx=position.x,by=position.y,half=(size.x,size.y,numberShots/2),x=half*-1;x<=half;x++){var shot=Gamestack.add(new Sprite({active:!0,position:position,size:size,speed:speed,image:animation.image,rotation:new Vector3(0,0,0),flipX:!1}));shot.setAnimation(animation),rot_offset=new Vector(rot_offset+x*disp,0,0),shot.position.x=bx,shot.position.y=by,shot.rotation.x=0+rot_offset.x,shot.stats={damage:1},options.line||shot.onUpdate(function(){shot.position.x+=Math.cos(3.14*shot.rotation.x/180)*speed,shot.position.y+=Math.sin(3.14*shot.rotation.x/180)*speed})}}},{key:"fire",value:function(origin,rotation){for(var x=0;x<this.run_ext.length;x++)this.run_ext[x].caller[this.run_ext[x].callkey]();this.line.origin=origin,this.line.rotation=rotation,console.log("FIRING FROM:"+jstr(origin));var sprite=new Sprite({image:this.animation.image});sprite.setAnimation(this.animation),sprite.setSize(this.size),sprite.position=new Vector(0,0,0);var __inst=this;__inst.line.fill();var lp=this.line.points;sprite.position=new Vector(lp[0]),sprite.onUpdate(function(sprite){for(var x=0;x<lp.length;x++){if(sprite.position.equals(lp[x])&&x<lp.length-1){sprite.position=new Vector(lp[x+1]);break}x==lp.length-1&&Gamestack.remove(sprite)}}),Gamestack.add(sprite),this.sprites.push(sprite)}}]),Projectile}();Gamestack.Projectile=Projectile;var Shapes={circle:function(radius,freq){return{radius:radius,points:[],fill:function(center,freq){}}},square:function(s,freq){return console.error("STILL NEED TO BUILD THIS SQUARE IN GS-API"),{size:new Gamestack.Vector(s,s),width:w,height:h,freq:freq,points:[],fill:function(start,freq){}}},rect:function(w,h,freq){return console.error("STILL NEED TO BUILD THIS TRIANGLE"),{size:new Gamestack.Vector(w,h),width:w,height:h,freq:freq,points:[],fill:function(start,freq){}}},triangle:function(base,h,freq){return console.error("STILL NEED TO BUILD THIS TRIANGLE"),{base:base,height:height,freq:freq,points:[],fill:function(start,freq){}}}};Gamestack.Shapes=Shapes;var Shot=function(){function Shot(name,imageOrAnimation){_classCallCheck(this,Shot),this.name=name||"No-Name",imageOrAnimation instanceof Gamestack.GameImage?this.anime=new Animation(imageOrAnimation):imageOrAnimation instanceof Gamestack.Animation&&(this.anime=imageOrAnimation),this.rotation=0,this.rot_disp=0;var args=name instanceof Object?name:{};this.init(args)}return _createClass(Shot,[{key:"init",value:function(args){if(args instanceof Object)for(var x in args)this[x]=args[x],args[x]instanceof Object&&args[x].hasOwnProperty("x")&&(this[x]=new Vector(args[x]));Gamestack.ChainSet.informable(this)}},{key:"Image",value:function(image){this.anime=new Animation(image)}},{key:"Animation",value:function(anime){return this.anime=anime,this}},{key:"Total",value:function(total,rot_disp_per_unit){return this.total=total,this.rot_disp=rot_disp_per_unit,this}},{key:"WaveGrowth",value:function(growth){growth>0&&(this.curve_growth=growth)}},{key:"CurveMode",value:function(key,size,growth){return this.curve=Gamestack.Curves.InOut[key.toLowerCase()],this.curve_key=key.toLowerCase(),this.curve_size=size,growth>0&&(this.curve_growth=growth),"number"==typeof this.curve_size&&(this.curve_size=new Gamestack.Vector(this.curve_size,this.curve_size)),this}},{key:"RotDisp",value:function(rot_disp){return this.rot_disp=rot_disp,this}},{key:"Velocity",value:function(v){return this.velocity=v,this}},{key:"Position",value:function(p){return"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):this.position=p,this}},{key:"Size",value:function(s){return"number"==typeof s?this.size=new Gamestack.Vector(s,s,s):this.size=s,this}},{key:"Rotation",value:function(r){return this.rotation=r,this}},{key:"onCollide",value:function(collideables,callback){}}]),Shot}();Gamestack.Shot=Shot;var Rectangle=function(){function Rectangle(min,max){_classCallCheck(this,Rectangle),this.min=new Gamestack.Vector(min),this.max=new Gamestack.Vector(max)}return _createClass(Rectangle,[{key:"toLine",value:function(){}}]),Rectangle}(),VectorBounds=Rectangle;Gamestack.VectorBounds=VectorBounds,Gamestack.Rectangle=Rectangle;var VectorFrameBounds=function(_Rectangle){function VectorFrameBounds(min,max,termPoint){_classCallCheck(this,VectorFrameBounds);var _this14=_possibleConstructorReturn(this,(VectorFrameBounds.__proto__||Object.getPrototypeOf(VectorFrameBounds)).call(this,min,max));return _this14.termPoint=termPoint||new Gamestack.Vector(_this14.max.x,_this14.max.y,_this14.max.z),_this14}return _inherits(VectorFrameBounds,_Rectangle),VectorFrameBounds}(Rectangle);Gamestack.VectorFrameBounds=VectorFrameBounds;var Line=function(){function Line(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Line),this.curve_options=Curves,this.curve_string=args.curve_string||"linearNone",this.curve=this.get_curve_from_string(this.curve_string),this.motion_curve=args.motion_curve||TWEEN.Easing.Linear.None,"function"==typeof args.curve&&(this.curve=args.curve),this.points=args.points||[],this.position=args.position||new Gamestack.Vector,this.is_highlighted=args.is_highlighted||!1,this.offset=args.offset||new Gamestack.Vector,this.pointDist=5,this.size=args.size||new Gamestack.Vector,this.rotation=args.rotation||0,this.origin=args.origin||new Gamestack.Vector(0,0),this.iterations=1,this.growth=args.growth||1.2}return _createClass(Line,[{key:"Iterations",value:function(n){return this.iterations=n,this}},{key:"Growth",value:function(n){return this.growth=n,this}},{key:"Origin",value:function(o){return this.position=o,this.origin=o,this}},{key:"Pos",value:function(p){return this.origin=p,this.position=p,this}},{key:"PointDisp",value:function(num){return this.minPointDist=num,this}},{key:"Curve",value:function(c){return this.curve=c,this.curve_string=this.get_curve_string(c),this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"Rotation",value:function(r){return this.rotation=r,this}},{key:"next",value:function(position){for(var found=!1,x=0;x<this.points.length;x++){if(position.equals(this.points[x])&&x<this.points.length-1)return found=!0,new Gamestack.Vector(this.points[x+1]);if(x==this.points.length-1&&!found)return new Gamestack.Vector(this.points[0])}}},{key:"get_curve_from_string",value:function(str){console.log("Applying Line():curve:"+str);for(var x in this.curve_options)if(x.toLowerCase()==str.toLowerCase())return this.curve_options[x]}},{key:"get_curve_string",value:function(c){for(var x in this.curve_options)if(this.curve_options[x]==c)return x}},{key:"getGraphCanvas",value:function(curveCall,existing_canvas){var canvas=existing_canvas||document.createElement("canvas");canvas.style.position="relative",canvas.id="curve-display",canvas.setAttribute("class","motion-curve"),canvas.width=180,canvas.height=100,canvas.style.background="black";var context=canvas.getContext("2d");context.fillStyle="rgb(0,0,0)",context.fillRect(0,0,180,100),context.lineWidth=.5,context.strokeStyle="rgb(230,230,230)",context.beginPath(),context.moveTo(0,20),context.lineTo(180,20),context.moveTo(0,80),context.lineTo(180,80),context.closePath(),context.stroke(),context.lineWidth=2,context.strokeStyle="rgb(255,127,127)";var position={x:0,y:80},position_old={x:0,y:80};this.test_graph_size=new Gamestack.Vector(185,60);var points=this.get_line_segment(this.test_graph_size,5,curveCall);for(var x in points){var position=new Gamestack.Vector(points[x].x,this.test_graph_size.y+20-points[x].y);context.beginPath(),context.moveTo(position_old.x,position_old.y),context.lineTo(position.x,position.y),context.closePath(),context.stroke(),position_old.x=position.x,position_old.y=position.y}return canvas}},{key:"transpose",value:function(origin,rotation){this.rotation=rotation,this.origin=origin;for(var t_points=[],x=0;x<this.points.length;x++){var p=this.points[x],np=new Gamestack.Vector(Gamestack.GeoMath.rotatePointsXY(p.x,p.y,this.rotation));t_points.push(np.add(origin)),console.log(np)}return t_points}},{key:"add_segment",value:function(next_segment,offset){for(var x=0;x<next_segment.length;x++)next_segment[x]=new Gamestack.Vector(next_segment[x]).add(offset),this.points.push(next_segment[x])}},{key:"get_flipped_segment",value:function(points){for(var t_points=points.slice(),t_len=t_points.length,x=0;x<points.length;x++)t_points[t_len-x].x=points[x].x;return t_points}},{key:"Highlight",value:function(origin,ctx){ctx=ctx||Gamestack.ctx;var points=this.transpose(origin);for(var x in points){var point=points[x],dist=point.sub(Gamestack.point_highlighter.position),d=Math.sqrt(dist.x*dist.x+dist.y*dist.y);d>=10&&(Gamestack.point_highlighter.position=new Gamestack.Vector(points[x])),Canvas.draw(Gamestack.point_highlighter,ctx)}return this}}]),Line}(),GeoMath={rotatePointsXY:function(x,y,angle){var theta=angle*Math.PI/180,point={};return point.x=x*Math.cos(theta)-y*Math.sin(theta),point.y=x*Math.sin(theta)+y*Math.cos(theta),point.z=0,point}};Gamestack.GeoMath=GeoMath;var Sound=function(){function Sound(src,data){if(_classCallCheck(this,Sound),"object"==("undefined"==typeof src?"undefined":_typeof(src))?(this.sound=document.createElement("audio"),this.sound.src=src.src,this.src=src.src):"string"==typeof src&&(this.sound=document.createElement("audio"),this.sound.src=src,this.src=src),"object"==("undefined"==typeof data?"undefined":_typeof(data)))for(var x in data)"sound"!==x&&(this[x]=data[x]);this.onLoad=this.onLoad||function(){},"function"==typeof this.onLoad&&this.onLoad(this.sound)}return _createClass(Sound,[{key:"Loop",value:function(loop){return this.sound.loop=loop||!0,this}},{key:"loop",value:function(_loop){return this.sound.loop=_loop||!0,this}},{key:"Volume",value:function(val){return this.sound.volume=val,this}},{key:"volume",value:function(val){return this.sound.volume=val,this}},{key:"Play",value:function(){return"object"==_typeof(this.sound)&&"function"==typeof this.sound.play&&this.sound.play(),this}},{key:"play",value:function(){return"object"==_typeof(this.sound)&&"function"==typeof this.sound.play&&this.sound.play(),this}}]),Sound}(),SoundList=function(){function SoundList(list){if(_classCallCheck(this,SoundList),this.cix=1,this.sounds=[],list instanceof Array)for(var x in list)list[x].src?this.sounds.push(new Sound(list[x].src,list[x])):"string"==typeof list[x]&&this.sounds.push(new Sound(list[x]))}return _createClass(SoundList,[{key:"add",value:function(src,name){if("object"==("undefined"==typeof src?"undefined":_typeof(src))&&src.src)this.sounds.push(new Sound(src.src,src));else if("string"==typeof src){var data={};name&&(data.name=name),this.sounds.push(new Sound(list[x],data))}}},{key:"Volume",value:function(v){for(var x=0;x<this.sounds.length;x++)this.sounds[x].volume(v);return this}},{key:"volume",value:function(v){for(var x=0;x<this.sounds.length;x++)this.sounds[x].volume(v);return this}},{key:"PlayNext",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}},{key:"Play",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}},{key:"playNext",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}},{key:"play",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}}]),SoundList}();Gamestack.Sound=Sound,Gamestack.SoundList=SoundList,function(){console.log("Sprite class... creating");var Sprite=function(){function Sprite(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arg2=arguments[1];arguments[2];_classCallCheck(this,Sprite);var a={};if(args instanceof Gamestack.Animation)args={selected_animation:args,size:new Gamestack.Vector(args.frameSize)};else if("string"==typeof args){this.image=new Gamestack.GameImage(args);var __inst=this,img=this.image.domElement;if(img.onload=function(){__inst.singleFrame(),__inst.after_load&&__inst.after_load()},"number"==typeof arg2){this.scale=arg2;var img=this.image.domElement;this.image.domElement.onload=function(){__inst.size=new Gamestack.Vector(Math.round(img.width*scale),Math.round(img.width/img.height*scale))}}"object"==("undefined"==typeof arg2?"undefined":_typeof(arg2))&&arg2.hasOwnProperty("x")&&arg2.hasOwnProperty("y")&&(this.size=arg2)}"object"==("undefined"==typeof arg2?"undefined":_typeof(arg2))&&arg2.hasOwnProperty("x")&&(this.size=arg2),Gamestack.Extendors.spatial(this),this.active=!0,"object"==("undefined"==typeof args?"undefined":_typeof(args))?this.apply_args(args):this.apply_args(a)}return _createClass(Sprite,[{key:"afterLoad",value:function(f){this.after_load=f}},{key:"apply_args",value:function(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var x in args)this[x]=args[x];this.name=args.name||"__blankName",this.life=args.life||999999999999,this.description=args.description||"__spriteDesc",this.id=Gamestack.getArg(args,"id",this.create_id()),this.animations=Gamestack.getArg(args,"animations",[]),this.motions=Gamestack.getArg(args,"motions",[]),this.particles=Gamestack.getArg(args,"particles",[]),this.shots=Gamestack.getArg(args,"shots",[]),this.sounds=Gamestack.getArg(args,"sounds",[]),this.__initializers=Gamestack.getArg(args,"__initializers",[]),this.type=Gamestack.getArg(args,"type","basic"),this.scrollFactor=args.scrollFactor||1,this.speed=Gamestack.getArg(args,"speed",new Gamestack.Vector(0,0,0)),this.size=new Gamestack.Vector(Gamestack.getArg(args,"size",new Gamestack.Vector(0,0))),this.position=new Gamestack.Vector(Gamestack.getArg(args,"position",new Gamestack.Vector(0,0,0))),this.collision_bounds=Gamestack.getArg(args,"collision_bounds",new Gamestack.VectorBounds(new Gamestack.Vector(0,0,0),new Gamestack.Vector(0,0,0))),this.rotation=new Gamestack.Vector(Gamestack.getArg(args,"rotation",new Gamestack.Vector(0,0,0))),this.acceleration=Gamestack.getArg(args,"acceleration",new Gamestack.Vector(0,0,0)),this.rot_speed=Gamestack.getArg(args,"rot_speed",new Gamestack.Vector(0,0,0)),this.rot_accel=Gamestack.getArg(args,"rot_accel",new Gamestack.Vector(0,0,0)),this.padding=Gamestack.getArg(args,"padding",new Gamestack.Vector(0,0,0));var __inst=this;args.src?(this.src=args.src,console.log("image src:"+args.src),this.image=new Gamestack.GameImage(args.src)):args.image instanceof Gamestack.GameImage?this.image=args.image:args.image&&args.image.domElement&&args.image.domElement.src&&(this.image=new Gamestack.GameImage(args.image.domElement.src)),GameStack.each(this.shots,function(ix,item){__inst.shots[ix]=new Gamestack.Shot(item)}),GameStack.each(this.sounds,function(ix,item){__inst.sounds[ix]=new Gamestack.Sound(item)}),GameStack.each(this.motions,function(ix,item){__inst.motions[ix]=new Gamestack.TweenMotion(item)}),GameStack.each(this.animations,function(ix,item){__inst.animations[ix]=new Gamestack.Animation(item)}),GameStack.each(this.particles,function(ix,item){__inst.particles[ix]=new Gamestack.GSProton(item)}),GameStack.each(this.__initializers,function(ix,item){__inst.onInit(item)}),Gamestack.ChainSet.informable(this),args.selected_animation&&(this.selected_animation=new Gamestack.Animation(args.selected_animation))}},{key:"singleFrame",value:function(){var __inst=this;return __inst.selected_animation||(console.log("setting Animation with :"+this.image.domElement.src),__inst.setAnimation(new Gamestack.Animation({image:__inst.image,frameSize:new Gamestack.Vector(__inst.image.domElement.width,__inst.image.domElement.height),frameBounds:new Gamestack.VectorFrameBounds(new Gamestack.Vector,new Gamestack.Vector)
}))),0==__inst.size.x&&0==__inst.size.y&&(__inst.size=new Gamestack.Vector(__inst.image.domElement.width,__inst.image.domElement.height)),this}},{key:"add",value:function(obj){switch(obj.constructor.name){case"Shot":this.shots.push(obj);break;case"Animation":this.animations.push(obj);break;case"GSProton":obj.parent=this,this.particles.push(obj);break;case"TweenMotion":this.motions.push(obj);break;case"Sound":this.sounds.push(obj)}}},{key:"init",value:function(){}},{key:"onInit",value:function(fun){if("string"==typeof fun){this.__initializers.indexOf(fun)<0&&this.__initializers.push(fun);var __inst=this,keys=fun.split(".");if(console.log("finding init from string:"+fun),!keys.length>=2)return console.error('need min 2 string keys separated by "."');var f=GameStack.options.SpriteInitializers[keys[0]][keys[1]];if("function"==typeof f){var __inst=this,f_init=this.init;this.init=function(){f_init(__inst),f(__inst)}}}else if("function"==typeof fun){console.log("extending init:");var f_init=this.init,__inst=this;this.init=function(){f_init(__inst),fun(__inst)}}else"object"==("undefined"==typeof fun?"undefined":_typeof(fun))&&(console.log("extending init:"),console.info("Quick2D does not yet implement onInit() from arg of object type"))}},{key:"get_id",value:function(){return this.id}},{key:"to_map_object",value:function(size,framesize){return this.__mapSize=new Gamestack.Vector(size||this.size),this.frameSize=new Gamestack.Vector(framesize||this.size),this}},{key:"create_id",value:function(){return Gamestack.create_id()}},{key:"setSize",value:function(size){this.size=new Gamestack.Vector(size.x,size.y,size.z)}},{key:"setPos",value:function(pos){this.position=new Gamestack.Vector(pos.x,pos.y,pos.z||0)}},{key:"getSizeByMax",value:function(mx,my){var size=new Gamestack.Vector(this.size),wth=size.y/size.x,htw=size.x/size.y;return size.x>mx&&(size.x=mx,size.y=size.x*wth),size.y>my&&(size.y=my,size.x=size.y*htw),size}},{key:"assertSpeed",value:function(){this.speed||(this.speed=new Gamestack.Vector(0,0,0))}},{key:"setAnimation",value:function(anime){return anime instanceof Gamestack.Animation&&this.animations.indexOf(anime)<0&&this.animations.push(anime),this.selected_animation=anime,Gamestack.log("set the animation"),this}},{key:"setToSingleFrame",value:function(){this.selected_animation=new Gamestack.Animation({image:this.image,frameSize:new Gamestack.Vector(this.image.domElement.width,this.image.domElement.height)});var __inst=this;return this.selected_animation.image.domElement.onload=function(){__inst.size=new Gamestack.Vector(__inst.selected_animation.image.domElement.width,__inst.selected_animation.image.domElement.height)},Gamestack.log("set single-frame animation"),this}},{key:"LifeSpan",value:function(value){this.life=value}},{key:"Life",value:function(value){this.life=value}},{key:"isDead",value:function(gw){return gw=gw||Gamestack.game_windows[0],this.hasOwnProperty("life")&&this.life<=0}},{key:"die",value:function(gw){return this.life=0,this}},{key:"onScreen",value:function(w,h,gw){w=w||Gamestack.WIDTH,h=h||Gamestack.HEIGHT,gw=gw||Gamestack.game_windows[0];var camera=gw.camera||Gamestack.camera||{position:new Gamestack.Vector(0,0,0)},scrollFactor=this.noScroll?0:this.scrollFactor,camPos=new Gamestack.Vector(camera.position).mult(scrollFactor),p=new Gamestack.Vector(this.position.x-camPos.x,this.position.y-camPos.y,this.position.z-camPos.z);return p.x+this.size.x>-1e3-w&&p.x<w+1e3&&p.y+this.size.y>-1e3-h&&p.y<h+1e3}},{key:"update",value:function(sprite){}},{key:"def_update",value:function(sprite){this.hasOwnProperty("life")&&!isNaN(this.life)&&(this.life-=1);for(var x in this.speed)(this.speed[x]>0||this.speed[x]<0)&&(this.position[x]+=this.speed[x]);for(var x in this.acceleration)(this.acceleration[x]>0||this.acceleration[x]<0)&&(this.speed[x]+=this.acceleration[x]);for(var x in this.rot_speed)(this.rot_speed[x]>0||this.rot_speed[x]<0)&&(this.rotation[x]+=this.rot_speed[x]);for(var x in this.rot_accel)(this.rot_accel[x]>0||this.rot_accel[x]<0)&&(this.rot_speed[x]+=this.rot_accel[x])}},{key:"resolveFunctionFromDoubleKeys",value:function(keyString1,keyString2,obj,callback){callback("function"==typeof obj[keyString1][keyString2]?obj[keyString1][keyString2]:{})}},{key:"extendFunc",value:function(fun,extendedFunc){console.log("extending func");var ef=extendedFunc,__inst=this;return function(){ef(__inst),fun(__inst)}}},{key:"onUpdate",value:function(fun){fun=fun||function(){};var update=this.update;this.update=function(__inst){update(__inst),fun(__inst)}}},{key:"travelLineTwoWay",value:function(lineObject,speed,curveKey,offset){speed=speed||1;curveKey=curveKey||"linear";var line=lineObject;lineObject.line&&(line=lineObject.line),this.__crtLineIx=this.__crtLineIx||0;var __inst=this,pctFloat=__inst.__crtLineIx%((line.points.length-1)/2)/((line.points.length-1)/2);__inst.__crtLineIx>=(line.points.length-1)/2&&(pctFloat=1-pctFloat);var ixChange=Gamestack.Curves.InOut[curveKey](pctFloat)*speed*.5;"linear"==curveKey&&(ixChange=speed),ixChange=Math.round(ixChange),ixChange<1&&(ixChange=1),__inst.position=new Gamestack.Vector(line.points[__inst.__crtLineIx]),console.log(ixChange),__inst.__crtLineIx+=ixChange,__inst.__crtLineIx>=line.points.length&&(line.points=line.points.reverse(),__inst.__crtLineIx=0),offset instanceof Gamestack.Vector&&(this.position=this.position.add(offset))}},{key:"travelLineOnLoop",value:function(lineObject,speed,curveKey,offset){speed=speed||1;curveKey=curveKey||"linear";var line=lineObject;lineObject.line&&(line=lineObject.line),this.__crtLineIx=this.__crtLineIx||0;var __inst=this,pctFloat=__inst.__crtLineIx%((line.points.length-1)/2)/((line.points.length-1)/2);__inst.__crtLineIx>=(line.points.length-1)/2&&(pctFloat=1-pctFloat);var ixChange=Gamestack.Curves.InOut[curveKey](pctFloat)*speed*.5;"linear"==curveKey&&(ixChange=speed),ixChange=Math.round(ixChange),ixChange<1&&(ixChange=1),__inst.position=new Gamestack.Vector(line.points[__inst.__crtLineIx]),console.log(ixChange),__inst.__crtLineIx+=ixChange,__inst.__crtLineIx>=line.points.length&&(__inst.__crtLineIx=0),offset instanceof Gamestack.Vector&&(this.position=this.position.add(offset))}},{key:"collidesRectangular",value:function(sprite){return Gamestack.Collision.spriteRectanglesCollide(this,sprite)}},{key:"shoot",value:function(options,gw){gw=gw||Gamestack.game_windows[0],this.prep_key="shoot";for(var animation=options.bullet||options.animation||options.anime||new Gamestack.Animation,speed=options.speed||options.velocity||1,size=options.size||new Gamestack.Vector(10,10,0),position=new Gamestack.Vector(options.position)||new Gamestack.Vector(this.position),rot_offset=options.rot_offset||options.rotation||0,total=options.total||1,rot_disp=options.rot_disp||0,curve=options.curve,curve_size=options.curve_size,curve_key=(options.curve_growth||1,options.curve_key||"quintic"),shots=(options.life||900,[]),x=0;x<total;x++){if(__gameInstance.isAtPlay){var bx=position.x,by=position.y,shot=(size.x,size.y,new Gamestack.Sprite({active:!0,position:new Gamestack.Vector(position),size:new Gamestack.Vector(size),speed:speed,image:animation.image,rotation:new Gamestack.Vector(0,0,0),flipX:!1,life:options.life}));shot.noScroll=!0,shot.setAnimation(animation),rot_offset=new Gamestack.Vector(rot_offset,0,0),shot.position.x=bx,shot.position.y=by;var div=rot_disp/total,rotPlus=div*x+div/2-rot_disp/2;if(shot.rotation.x=rot_offset.x+rotPlus,shot.origin=new Gamestack.Vector(position),shot.speed=new Gamestack.Vector(Math.cos(3.14*shot.rotation.x/180)*speed,Math.sin(3.14*shot.rotation.x/180)*speed),shots.push(shot),curve){shot.ticker=0;var r=shot.rotation.x+0;shot.line=(new Gamestack.CurvedLine).Pos(position).Curve(curve_key).SegmentSize(curve_size).MaxSize(2e3).Growth(1.5).Rotate(r).Fill(),shot.onUpdate(function(spr){spr.ticker+=1,spr.ticker<spr.line.points.length&&(spr.position=new Gamestack.Vector(spr.line.points[spr.ticker]))})}else shot.onUpdate(function(spr){});gw.add(shot)}}return shots}},{key:"subsprite",value:function subsprite(options,gw){gw=gw||Gamestack.game_windows[0];var animation=options.animation||new Gamestack.Animation,position=options.position||new Gamestack.Vector(this.position),offset=options.offset||new Gamestack.Vector(0,0,0),size=new Gamestack.Vector(options.size||this.size);if(__gameInstance.isAtPlay){var subsprite=gw.add(new Gamestack.Sprite({active:!0,position:position,size:size,offset:offset,image:animation.image,rotation:new Gamestack.Vector(0,0,0),flipX:!1,scrollFactor:this.scrollFactor,noScroll:this.noScroll}));return subsprite.setAnimation(animation),subsprite}alert("No subsprite when not at play")}},{key:"animate",value:function(animation){__gameInstance.isAtPlay&&(animation&&this.setAnimation(animation),this.selected_animation.animate())}},{key:"onAnimationComplete",value:function(fun){this.selected_animation.onComplete(fun)}},{key:"accelY",value:function(accel,max){accel=Math.abs(accel),"number"==typeof max&&(max={y:max}),this.assertSpeed();var diff=max.y-this.speed.y;diff>0&&(this.speed.y+=Math.abs(diff)>=accel?accel:diff),diff<0&&(this.speed.y-=Math.abs(diff)>=accel?accel:diff)}},{key:"accelX",value:function(accel,max){accel=Math.abs(accel),"number"==typeof max&&(max={x:max}),this.assertSpeed();var diff=max.x-this.speed.x;diff>0&&(this.speed.x+=Math.abs(diff)>=accel?accel:diff),diff<0&&(this.speed.x-=Math.abs(diff)>=accel?accel:diff)}},{key:"accel",value:function(prop,key,_accel,max){_accel=Math.abs(_accel),"number"==typeof max&&(max={x:max});var diff=(prop[key],max.x-prop[key]);diff>0&&(prop[key]+=Math.abs(diff)>=_accel?_accel:diff),diff<0&&(prop[key]-=Math.abs(diff)>=_accel?_accel:diff)}},{key:"decel",value:function(prop,key,rate){"object"==("undefined"==typeof rate?"undefined":_typeof(rate))&&(rate=rate.rate),rate=Math.abs(rate),Math.abs(prop[key])<=rate?prop[key]=0:prop[key]>0?prop[key]-=rate:prop[key]<0?prop[key]+=rate:prop[key]=0}},{key:"decelY",value:function(amt){amt=Math.abs(amt),Math.abs(this.speed.y)<=amt?this.speed.y=0:this.speed.y>amt?this.speed.y-=amt:this.speed.y<amt*-1&&(this.speed.y+=amt)}},{key:"decelX",value:function(amt){amt=Math.abs(amt),this.speed.x>amt?this.speed.x-=amt:this.speed.x<amt*-1&&(this.speed.x+=amt),Math.abs(this.speed.x)<=amt&&(this.speed.x=0)}},{key:"shortest_stop",value:function(item,callback){var diff_min_y=item.min?item.min.y:Math.abs(item.position.y-this.position.y+this.size.y),diff_min_x=item.min?item.min.x:Math.abs(item.position.x-this.position.x+this.size.x),diff_max_y=item.max?item.max.y:Math.abs(item.position.y+item.size.y-this.position.y),diff_max_x=item.max?item.max.x:Math.abs(item.position.x+item.size.x-this.position.y),dimens={top:diff_min_y,left:diff_min_x,bottom:diff_max_y,right:diff_max_x},minkey="",min=1e7;for(var x in dimens)dimens[x]<min&&(min=dimens[x],minkey=x);callback(minkey)}},{key:"center",value:function(){return new Gamestack.Vector(this.position.x+this.size.x/2,this.position.y+this.size.y/2,0)}},{key:"overlap_x",value:function(item,padding){padding||(padding=0);var paddingX=Math.round(padding*this.size.x),paddingY=Math.round(padding*this.size.y),left=this.position.x+paddingX,right=this.position.x+this.size.x-paddingX;this.position.y+paddingY,this.position.y+this.size.y-paddingY;return right>item.position.x&&left<item.position.x+item.size.x}},{key:"overlap_y",value:function(item,padding){padding||(padding=0);var paddingX=Math.round(padding*this.size.x),paddingY=Math.round(padding*this.size.y),top=(this.position.x+paddingX,this.position.x+this.size.x-paddingX,this.position.y+paddingY),bottom=this.position.y+this.size.y-paddingY;return bottom>item.position.y&&top<item.position.y+item.size.y}},{key:"collide_stop_x",value:function(item){for(var apart=!1,ct=1e4;!apart&&ct>0;){ct--;var diffX=this.center().sub(item.center()).x,distX=Math.abs(this.size.x/2+item.size.x/2-Math.round(this.size.x*this.padding.x));Math.abs(diffX)<distX?this.position.x-=diffX>0?-1:1:(this.speed.x=0,apart=!0)}}},{key:"Life",value:function(v){return this.life=v,this}},{key:"collide_stop",value:function(item){if(this.id==item.id)return!1;if(this.collidesRectangular(item)){var diff=this.center().sub(item.center());if(this.overlap_x(item,this.padding.x+.1)&&Math.abs(diff.x)<Math.abs(diff.y))for(var apart=!1,ct=1e4;!apart&&ct>0;){ct--;var diffY=this.center().sub(item.center()).y,distY=Math.abs(this.size.y/2+item.size.y/2-Math.round(this.size.y*this.padding.y));if(!(Math.abs(diffY)<distY))return diffY<=0&&(this.__inAir=!1),this.speed.y=0,apart=!0;this.position.y-=diffY>0?-1:diffY<0?1:0,this.position.y=Math.round(this.position.y)}this.overlap_y(item,this.padding.y)&&Math.abs(diff.y)<Math.abs(diff.x)&&this.collide_stop_x(item)}}},{key:"collide_stop_top",value:function(item){if(this.id==item.id)return!1;if(this.overlap_x(item,this.padding.x+.1)){console.log("OVERLAP_X");var paddingY=this.padding.y*this.size.y;this.position.y+this.size.y-paddingY<=item.position.y&&(this.groundMaxY=item.position.y-this.size.y+paddingY)}}},{key:"restoreFrom",value:function(data){return data.image=new GameImage(data.src||data.image.src),new Gamestack.Sprite(data)}},{key:"fromFile",value:function(file_path){if("string"==typeof file_path){var __inst=this;$.getJSON(file_path,function(data){__inst=new Gamestack.Sprite(data)})}}},{key:"toJSONString",value:function(){for(var x=0;x<this.motions.length;x++)this.motions[x].parent=!1;return jstr(this)}}]),Sprite}();Gamestack.Sprite=Sprite;var SpriteInitializersOptions={Clastics:{top_collideable:function(sprite){for(var x in Gamestack.__gameWindow.forces){var force=Gamestack.__gameWindow.forces[x];force.topClastics.push(sprite)}sprite.onUpdate(function(){})},fourside_collideable:function(sprite){for(var x in Gamestack.__gameWindow.forces){var force=Gamestack.__gameWindow.forces[x];force.clasticObjects.push(sprite)}sprite.onUpdate(function(){})}},MainGravity:{very_light:function(sprite,gw){gw=gw||Gamestack.game_windows[0];gw.add(new Gamestack.Force({name:"very_light_grav",accel:.05,max:new Gamestack.Vector(0,3.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},light:function(sprite,gw){gw=gw||Gamestack.game_windows[0];gw.add(new Gamestack.Force({name:"light_grav",accel:.1,max:new Gamestack.Vector(0,4.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},medium:function(sprite,gw){gw=gw||Gamestack.game_windows[0];gw.add(new Gamestack.Force({name:"medium_grav",accel:.2,max:new Gamestack.Vector(0,7.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},strong:function(sprite,gw){gw=gw||Gamestack.game_windows[0];gw.add(new Gamestack.Force({name:"strong_grav",accel:.4,max:new Gamestack.Vector(0,10.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},very_strong:function(sprite,gw){gw=gw||Gamestack.game_windows[0];gw.add(new Gamestack.Force({name:"strong_grav",accel:.5,max:new Gamestack.Vector(0,12.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})}},ControllerStickMotion:{player_move_x:function(sprite){alert("applying initializer"),console.log("side_scroll_player_run:init-ing");Gamestack.GamepadAdapter.on("stick_left",0,function(x,y){if(console.log("stick-x:"+x),Math.abs(x)<.2)return 0;var accel=.2,max=7;sprite.accelX(accel,x*max),x<-.2?sprite.flipX=!0:x>.2&&(sprite.flipX=!1)}),sprite.onUpdate(function(spr){spr.decelX(.1),spr.__falling||spr.decelY(.2)})},player_move_xy:function(sprite){alert("applying initializer"),console.log("side_scroll_player_run:init-ing");Gamestack.GamepadAdapter.on("stick_left",0,function(x,y){console.log("stick-x:"+x),Math.abs(x)<.2&&(x=0),Math.abs(y)<.2&&(y=0);var accel=.2,max=7;sprite.accelX(accel,x*max),sprite.accelY(accel,y*max),x<-.2?sprite.flipX=!0:x>.2&&(sprite.flipX=!1)}),sprite.onUpdate(function(spr){sprite.decel(sprite.speed,"x",.1),sprite.decel(sprite.speed,"y",.1)})},player_rotate_x:function(sprite){Gamestack.GamepadAdapter.on("stick_left",0,function(x,y){if(console.log("stick-x:"+x),Math.abs(x)<.2)return 0;var accel=.25,max=7;sprite.accel(sprite.rot_speed,"x",accel,x*max),x<-.2?sprite.flipX=!0:x>.2&&(sprite.flipX=!1)}),sprite.onUpdate(function(spr){sprite.decel(sprite.rot_speed,"x",.1),spr.__falling||spr.decelY(.2)})}}};Gamestack.Sprite=Sprite,Gamestack.options=Gamestack.options||{},Gamestack.options.SpriteInitializers=SpriteInitializersOptions}(),function(){console.log("Vector class... creating");var Vector=function(){function Vector(x,y,z,r){return _classCallCheck(this,Vector),"object"==("undefined"==typeof x?"undefined":_typeof(x))&&x.hasOwnProperty("x")&&x.hasOwnProperty("y")?(this.x=x.x,this.y=x.y,this.z=x.z||0,null==this.z&&(this.z=0),this.valid_check(),this):(null==z&&(z=0),this.x=x,this.y=y,this.z=z,this.r=r,void this.valid_check())}return _createClass(Vector,[{key:"valid_check",value:function(){void 0!=this.x&&void 0!=this.y&&void 0!=this.z||(this.x=0,this.y=0,this.z=0)}},{key:"sub",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x-v.x,this.y-v.y,this.z-v.z)}},{key:"add",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x+v.x,this.y+v.y,this.z+v.z)}},{key:"mult",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x*v.x,this.y*v.y,this.z*v.z)}},{key:"div",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x/v.x,this.y/v.y,this.z/v.z)}},{key:"round",value:function(){return new Gamestack.Vector(Math.round(this.x),Math.round(this.y),Math.round(this.z))}},{key:"floor",value:function(){return new Gamestack.Vector(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}},{key:"ceil",value:function(){return new Gamestack.Vector(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}},{key:"equals",value:function(v){return this.x==v.x&&this.y==v.y&&this.z==v.z}},{key:"trig_distance_xy",value:function(v){var dist=this.sub(v);return Math.sqrt(dist.x*dist.x+dist.y*dist.y)}},{key:"diff",value:function(){}},{key:"abs_diff",value:function(){}},{key:"is_between",value:function(v1,v2){return this.x>=v1.x&&this.x<=v2.x&&this.y>=v1.y&&this.y<=v2.y&&this.z>=v1.z&&this.z<=v2.z}}]),Vector}();Gamestack.Vector=Vector,Gamestack.Rotation=Vector,Gamestack.Pos=Vector,Gamestack.Position=Vector,Gamestack.Size=Vector;var VectorMath={rotatePointsXY:function(x,y,angle){var theta=angle*Math.PI/180,point={};return point.x=x*Math.cos(theta)-y*Math.sin(theta),point.y=x*Math.sin(theta)+y*Math.cos(theta),point.z=0,point}};Gamestack.VectorMath=VectorMath}();var Background=function(_Gamestack$Sprite){function Background(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Background);var _this15=_possibleConstructorReturn(this,(Background.__proto__||Object.getPrototypeOf(Background)).call(this,args));_this15.type=args.type||"parallax"||"basic"||!1,_this15.source_objects=args.objects||args.source_objects||[],_this15.members=[],_this15.rows=args.rows||1,_this15.cols=args.cols||1,_this15.flip=args.flip||!1,_this15.fill=args.fill||!1,_this15.noScroll=args.noScroll||!1,_this15.scrollFactor=args.scrollFactor||1,_this15.noScroll&&(_this15.scrollFactor=0),_this15.flip=args.flip||!1;return _this15}return _inherits(Background,_Gamestack$Sprite),_createClass(Background,[{key:"Flip",value:function(value){return void 0==value?this.flip=!0:1!=value&&0!=value||(this.flip=value),this}},{key:"Rows",value:function(r){return this.rows=r,this}},{key:"Cols",value:function(c){return this.cols=c,this}},{key:"ScrollFactor",value:function(sf){return this.scrollFactor=sf,this}},{key:"Fill",value:function(approxRows,approxCols,gw){approxRows=approxRows||this.rows||1,approxCols=approxCols||this.cols||1,this.members.push(new Background(this));for(var x=0;x<this.source_objects.length;x++)this.members.push(new Background(this.source_objects[x]));gw=gw||Gamestack.game_windows[0];for(var xBacksTotal=(gw.canvas.width,gw.canvas.height,Math.floor(approxRows/2)),yBacksTotal=Math.floor(approxCols/2),y=-yBacksTotal;y<=yBacksTotal+1;y++){console.log("adding background:"+y);for(var x=-xBacksTotal;x<=xBacksTotal+1;x++){this.members.push(new Background(this));var b=this.members[this.members.length-1];b.setSize(this.size);b.position.x=x*this.size.x,b.position.y=y*this.size.y,b.minX=-xBacksTotal*b.size.x+b.size.x,b.maxX=(xBacksTotal+1)*b.size.x,b.minY=-yBacksTotal*b.size.y+b.size.y,b.maxY=yBacksTotal*b.size.y,x%2==0&&(b.flipX=!0),y%2==0&&(b.flipY=!0),b.onUpdate(function(spr){spr.campos=gw.camera.position;var cx=spr.campos.x-spr.campos.x%spr.size.x,cy=spr.campos.y-spr.campos.y%spr.size.y;spr.position.x-cx<spr.minX&&(spr.position.x=spr.maxX+cx),spr.position.x-cx>spr.maxX&&(spr.position.x=spr.minX+cx),spr.position.y-cy<spr.minY&&(spr.position.y=spr.maxY+cy),spr.position.y-cy>spr.maxY&&(spr.position.y=spr.minY+cy)}),gw.add(b)}}return this}},{key:"add",value:function(object){var cleanCheck=object instanceof Gamestack.Sprite||object instanceof Array&&object[0]instanceof Gamestack.Sprite;return cleanCheck?(object instanceof Array?this.source_objects.cancat(object):this.source_objects.push(object),this):console.error("Must have: valid contents (Gamestack.Sprite OR [] of Gamestack.Sprite())")}}]),Background}(Gamestack.Sprite);Gamestack.Background=Background,function(){console.log("Interactive class... creating");var Interactive=function(_Gamestack$Sprite2){function Interactive(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Interactive);var _this16=_possibleConstructorReturn(this,(Interactive.__proto__||Object.getPrototypeOf(Interactive)).call(this,args));return _this16.collision_settings=new Gamestack.CollisionSettings(args),_this16.collideables=args.collideables||[],Gamestack.Extendors.collideable(_this16,args),_this16}return _inherits(Interactive,_Gamestack$Sprite2),_createClass(Interactive,[{key:"Collideables",value:function(c){return this.collideables=c||[],!this.collideables instanceof Array?console.error('Must pass array for "c" argument'):this}},{key:"onCollide",value:function(){}}]),Interactive}(Gamestack.Sprite);Gamestack.Interactive=Interactive}(),function(){console.log("Terrain class... creating");var Terrain=function(_Gamestack$Sprite3){function Terrain(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Terrain);var _this17=_possibleConstructorReturn(this,(Terrain.__proto__||Object.getPrototypeOf(Terrain)).call(this,args));return _this17.collision_settings=new Gamestack.CollisionSettings(args),_this17.collideables=args.collideables||args.colliders||[],Gamestack.Extendors.collideable(_this17,args),_this17}return _inherits(Terrain,_Gamestack$Sprite3),_createClass(Terrain,[{key:"Collideables",value:function(c){return this.collideables=c||[],!this.collideables instanceof Array?console.error('Must pass array for "c" argument'):this}},{key:"onCollide",value:function(){}}]),Terrain}(Gamestack.Sprite);Gamestack.Terrain=Terrain}();var THREE_EXT={defaults:{DodecahedronGeometry:{radius:1,detail:0},SphereGeometry:{radius:5,widthSegments:32,heightSegments:32},BoxGeometry:{width:20,height:20,depth:20},CylinderGeometry:{radiusTop:5,radiusBottom:5,height:20,heightSegments:32},TorusGeometry:{radius:10,tube:3,radialSegments:16,tubularSegments:100}}},Three=function(_Gamestack$Sprite4){function Three(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Three);var _this18=_possibleConstructorReturn(this,(Three.__proto__||Object.getPrototypeOf(Three)).call(this,args));if(!THREE){var _ret;return _ret=console.error("ThreeJSObject():Library: Three.js is required for this object."),_possibleConstructorReturn(_this18,_ret)}_this18.scene=new THREE.Scene,args.geometry instanceof String&&THREE[args.geometry]?_this18.geometry=new THREE[args.geometry]:_this18.geometry=args.geometry||new THREE.TorusGeometry(50,10,16,100),_this18.scene.add(new THREE.AmbientLight(16777215,1)),_this18.renderer=Gamestack.renderer||new THREE.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0}),_this18.renderer.setSize(1e3,1e3),_this18.camera=new THREE.PerspectiveCamera(70,1,1,1e3),_this18.camera.position.z=125;var __inst=_this18,src=args.src||"../assets/game/image/tiles/perlin_3.png";return __inst.loader=new THREE.TextureLoader,__inst.loader.load(src,function(texture){__inst.material=args.material||new THREE.MeshPhongMaterial({map:texture}),__inst.__init||(__inst.mesh=new THREE.Mesh(__inst.geometry,__inst.material),__inst.scene.add(__inst.mesh),__inst.__init=!0),__inst.renderer.render(__inst.scene,__inst.camera),__ServerSideFile.file_upload("test.png",__inst.renderer.domElement.toDataURL("image/png"),function(relpath,content){relpath=relpath.replace("client/","../"),__inst.selected_animation=new Animation({src:relpath,frameSize:new Vector(1e3,1e3),frameBounds:new VectorFrameBounds(new Vector(0,0,0),new Vector(0,0,0),new Vector(0,0,0))}).singleFrame(),__inst.selected_animation.image.domElement.onload=function(){__inst.setSize(new Vector(__inst.selected_animation.image.domElement.width,__inst.selected_animation.image.domElement.height)),__inst.selected_animation.animate(),console.log(jstr(__inst.selected_animation.frames))}})}),_this18}return _inherits(Three,_Gamestack$Sprite4),_createClass(Three,[{key:"three_update",value:function(){console.log("THREE --GS-Object UPDATE"),this.mesh.rotation.y+=.05,this.renderer.clear(),this.renderer.setSize(this.size.x,this.size.y);var pixels=new Uint8Array(this.size.x*this.size.y*4);this.renderer.render(this.scene,this.camera);var gl=this.renderer.getContext();gl.readPixels(0,0,this.size.x,this.size.y,gl.RGBA,gl.UNSIGNED_BYTE,pixels),this.selected_animation.selected_frame={image:{}},this.selected_animation.selected_frame.image.data=new ImageData(new Uint8ClampedArray(pixels),this.size.x,this.size.y)}},{key:"applyAnimativeState",value:function(){}}]),Three}(Gamestack.Sprite);"function"!=typeof JSON.decycle&&(JSON.decycle=function(object){var objects=[],paths=[];return function derez(value,path){var i,name,nu;switch("undefined"==typeof value?"undefined":_typeof(value)){case"object":if(!value)return null;for(i=0;i<objects.length;i+=1)if(objects[i]===value)return{$ref:paths[i]};if(objects.push(value),paths.push(path),"[object Array]"===Object.prototype.toString.apply(value))for(nu=[],i=0;i<value.length;i+=1)nu[i]=derez(value[i],path+"["+i+"]");else{nu={};for(name in value)Object.prototype.hasOwnProperty.call(value,name)&&(nu[name]=derez(value[name],path+"["+JSON.stringify(name)+"]"))}return nu;case"number":case"string":case"boolean":return value}}(object,"$")}),"function"!=typeof JSON.retrocycle&&(JSON.retrocycle=function retrocycle($){var px=/^\$(?:\[(?:\d?|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return function rez(value){var i,item,name,path;if(value&&"object"===("undefined"==typeof value?"undefined":_typeof(value)))if("[object Array]"===Object.prototype.toString.apply(value))for(i=0;i<value.length;i+=1)item=value[i],item&&"object"===("undefined"==typeof item?"undefined":_typeof(item))&&(path=item.$ref,"string"==typeof path&&px.test(path)?value[i]=eval(path):rez(item));else for(name in value)"object"===_typeof(value[name])&&(item=value[name],item&&(path=item.$ref,"string"==typeof path&&px.test(path)?value[name]=eval(path):rez(item)))}($),$}),function(root,factory){"object"===("undefined"==typeof window?"undefined":_typeof(window))&&(window.Proton=factory())}(void 0,function(){function Proton(proParticleCount,integrationType){this.integrationType=Proton.Util.initValue(integrationType,Proton.EULER),this.emitters=[],this.renderers=[],this.time=0,this.oldTime=0,Proton.pool=new Proton.Pool(100),Proton.integrator=new Proton.NumericalIntegration(this.integrationType)}function EventDispatcher(){this.initialize()}function MStack(){this.mats=[],this.size=0;for(var i=0;i<20;i++)this.mats.push(Proton.Mat3.create([0,0,0,0,0,0,0,0,0]))}function Particle(pOBJ){this.id="particle_"+Particle.ID++,this.reset(!0),Proton.Util.setPrototypeByObject(this,pOBJ)}function Pool(){this.cID=0,this.list={}}function Span(a,b,center){this.isArray=!1,Proton.Util.isArray(a)?(this.isArray=!0,this.a=a):(this.a=Proton.Util.initValue(a,1),this.b=Proton.Util.initValue(b,this.a),this.center=Proton.Util.initValue(center,!1))}function ColorSpan(color){Proton.Util.isArray(color)?this.colorArr=color:this.colorArr=[color]}function Rectangle(x,y,w,h){this.x=x,this.y=y,this.width=w,this.height=h,this.bottom=this.y+this.height,this.right=this.x+this.width}function Behaviour(life,easing){this.id="Behaviour_"+Behaviour.id++,this.life=Proton.Util.initValue(life,1/0),this.easing=Proton.ease.setEasingByName(easing),this.age=0,this.energy=1,this.dead=!1,this.parents=[],this.name="Behaviour"}function Rate(numpan,timepan){this.numPan=Proton.Util.initValue(numpan,1),this.timePan=Proton.Util.initValue(timepan,1),this.numPan=Proton.Util.setSpanValue(this.numPan),this.timePan=Proton.Util.setSpanValue(this.timePan),this.startTime=0,this.nextTime=0,this.init()}function Initialize(){}function Life(a,b,c){Life._super_.call(this),this.lifePan=Proton.Util.setSpanValue(a,b,c)}function Position(zone){Position._super_.call(this),this.zone=Proton.Util.initValue(zone,new Proton.PointZone)}function Velocity(rpan,thapan,type){Velocity._super_.call(this),this.rPan=Proton.Util.setSpanValue(rpan),this.thaPan=Proton.Util.setSpanValue(thapan),this.type=Proton.Util.initValue(type,"vector")}function Mass(a,b,c){Mass._super_.call(this),this.massPan=Proton.Util.setSpanValue(a,b,c)}function Radius(a,b,c){Radius._super_.call(this),this.radius=Proton.Util.setSpanValue(a,b,c)}function ImageTarget(image,w,h){ImageTarget._super_.call(this),this.image=this.setSpanValue(image),this.w=Proton.Util.initValue(w,20),this.h=Proton.Util.initValue(h,this.w)}function Force(fx,fy,life,easing){Force._super_.call(this,life,easing),this.force=this.normalizeForce(new Proton.Vector2D(fx,fy)),this.name="Force"}function Attraction(targetPosition,force,radius,life,easing){Attraction._super_.call(this,life,easing),this.targetPosition=Proton.Util.initValue(targetPosition,new Proton.Vector2D),this.radius=Proton.Util.initValue(radius,1e3),this.force=Proton.Util.initValue(this.normalizeValue(force),100),this.radiusSq=this.radius*this.radius,this.attractionForce=new Proton.Vector2D,this.lengthSq=0,this.name="Attraction"}function RandomDrift(driftX,driftY,delay,life,easing){RandomDrift._super_.call(this,life,easing),this.reset(driftX,driftY,delay),this.time=0,this.name="RandomDrift"}function Repulsion(targetPosition,force,radius,life,easing){Repulsion._super_.call(this,targetPosition,force,radius,life,easing),this.force*=-1,this.name="Repulsion"}function Gravity(g,life,easing){Gravity._super_.call(this,0,g,life,easing),this.name="Gravity"}function Collision(emitter,mass,callback,life,easing){Collision._super_.call(this,life,easing),this.reset(emitter,mass,callback),this.name="Collision"}function CrossZone(zone,crossType,life,easing){CrossZone._super_.call(this,life,easing),this.reset(zone,crossType),this.name="CrossZone"}function Alpha(a,b,life,easing){Alpha._super_.call(this,life,easing),this.reset(a,b),this.name="Alpha"}function Scale(a,b,life,easing){Scale._super_.call(this,life,easing),this.reset(a,b),this.name="Scale"}function Rotate(a,b,style,life,easing){Rotate._super_.call(this,life,easing),this.reset(a,b,style),this.name="Rotate"}function Color(color1,color2,life,easing){Color._super_.call(this,life,easing),this.reset(color1,color2),this.name="Color"}function GravityWell(centerPoint,force,life,easing){GravityWell._super_.call(this,life,easing),this.distanceVec=new Proton.Vector2D,this.centerPoint=Proton.Util.initValue(centerPoint,new Proton.Vector2D),this.force=Proton.Util.initValue(this.normalizeValue(force),100),this.name="GravityWell"}function Emitter(pObj){this.initializes=[],this.particles=[],this.behaviours=[],this.emitTime=0,this.emitTotalTimes=-1,this.damping=.006,this.bindEmitter=!0,this.rate=new Proton.Rate(1,.1),Emitter._super_.call(this,pObj),this.id="emitter_"+Emitter.ID++}function BehaviourEmitter(pObj){
this.selfBehaviours=[],BehaviourEmitter._super_.call(this,pObj)}function FollowEmitter(mouseTarget,ease,pObj){this.mouseTarget=Proton.Util.initValue(mouseTarget,window),this.ease=Proton.Util.initValue(ease,.7),this._allowEmitting=!1,this.initEventHandler(),FollowEmitter._super_.call(this,pObj)}function Renderer(type,proton,element){this.element=element,this.type=Proton.Util.initValue(type,"canvas"),this.proton=proton,this.renderer=this.getRenderer()}function BaseRender(proton,element,stroke){this.proton=proton,this.element=element,this.stroke=stroke,this.pool=new Proton.Pool}function DomRender(proton,element){DomRender._super_.call(this,proton,element),this.stroke=null}function EaselRender(proton,element,stroke){EaselRender._super_.call(this,proton,element),this.stroke=stroke}function CanvasRender(proton,element){CanvasRender._super_.call(this,proton,element),this.stroke=null,this.context=this.element.getContext("2d"),this.bufferCache={}}function PixelRender(proton,element,rectangle){PixelRender._super_.call(this,proton,element),this.context=this.element.getContext("2d"),this.imageData=null,this.rectangle=null,this.rectangle=rectangle,this.createImageData(rectangle)}function WebGLRender(proton,element){WebGLRender._super_.call(this,proton,element),this.gl=this.element.getContext("experimental-webgl",{antialias:!0,stencil:!1,depth:!1}),this.gl||alert("Sorry your browser do not suppest WebGL!"),this.initVar(),this.setMaxRadius(),this.initShaders(),this.initBuffers(),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.BLEND)}function Zone(){this.vector=new Proton.Vector2D(0,0),this.random=0,this.crossType="dead",this.alert=!0}function LineZone(x1,y1,x2,y2,direction){LineZone._super_.call(this),x2-x1>=0?(this.x1=x1,this.y1=y1,this.x2=x2,this.y2=y2):(this.x1=x2,this.y1=y2,this.x2=x1,this.y2=y1),this.dx=this.x2-this.x1,this.dy=this.y2-this.y1,this.minx=Math.min(this.x1,this.x2),this.miny=Math.min(this.y1,this.y2),this.maxx=Math.max(this.x1,this.x2),this.maxy=Math.max(this.y1,this.y2),this.dot=this.x2*this.y1-this.x1*this.y2,this.xxyy=this.dx*this.dx+this.dy*this.dy,this.gradient=this.getGradient(),this.length=this.getLength(),this.direction=Proton.Util.initValue(direction,">")}function CircleZone(x,y,radius){CircleZone._super_.call(this),this.x=x,this.y=y,this.radius=radius,this.angle=0,this.center={x:this.x,y:this.y}}function PointZone(x,y){PointZone._super_.call(this),this.x=x,this.y=y}function RectZone(x,y,width,height){RectZone._super_.call(this),this.x=x,this.y=y,this.width=width,this.height=height}function ImageZone(imageData,x,y,d){ImageZone._super_.call(this),this.reset(imageData,x,y,d)}Proton.POOL_MAX=1e3,Proton.TIME_STEP=60,Proton.USE_CLOCK=!1,Proton.MEASURE=100,Proton.EULER="euler",Proton.RK2="runge-kutta2",Proton.VERLET="verlet",Proton.PARTICLE_CREATED="partilcleCreated",Proton.PARTICLE_UPDATE="partilcleUpdate",Proton.PARTICLE_SLEEP="particleSleep",Proton.PARTICLE_DEAD="partilcleDead",Proton.PROTON_UPDATE="protonUpdate",Proton.PROTON_UPDATE_AFTER="protonUpdateAfter",Proton.EMITTER_ADDED="emitterAdded",Proton.EMITTER_REMOVED="emitterRemoved",Proton.amendChangeTabsBug=!0,Proton.TextureBuffer={},Proton.TextureCanvasBuffer={},Proton.prototype={addRender:function(render){render.proton=this,this.renderers.push(render.proton)},addEmitter:function(emitter){this.emitters.push(emitter),emitter.parent=this,this.dispatchEvent(Proton.EMITTER_ADDED,emitter)},removeEmitter:function(emitter){var index=this.emitters.indexOf(emitter);this.emitters.splice(index,1),emitter.parent=null,this.dispatchEvent(Proton.EMITTER_REMOVED,emitter)},update:function(){if(this.dispatchEvent(Proton.PROTON_UPDATE),Proton.USE_CLOCK){this.oldTime||(this.oldTime=(new Date).getTime());var time=(new Date).getTime();this.elapsed=(time-this.oldTime)/1e3,Proton.amendChangeTabsBug&&this.amendChangeTabsBug(),this.oldTime=time}else this.elapsed=.0167;if(this.elapsed>0)for(var i=0;i<this.emitters.length;i++)this.emitters[i].update(this.elapsed);this.dispatchEvent(Proton.PROTON_UPDATE_AFTER)},amendChangeTabsBug:function(){this.elapsed>.5&&(this.oldTime=(new Date).getTime(),this.elapsed=0)},getCount:function(){for(var total=0,length=this.emitters.length,i=0;i<length;i++)total+=this.emitters[i].particles.length;return total},destroy:function(){for(var length=this.emitters.length,i=0;i<length;i++)this.emitters[i].destroy(),delete this.emitters[i];this.emitters=[],this.time=0,this.oldTime=0,Proton.pool.release()}},EventDispatcher.initialize=function(target){target.addEventListener=p.addEventListener,target.removeEventListener=p.removeEventListener,target.removeAllEventListeners=p.removeAllEventListeners,target.hasEventListener=p.hasEventListener,target.dispatchEvent=p.dispatchEvent};var p=EventDispatcher.prototype;p._listeners=null,p.initialize=function(){},p.addEventListener=function(type,listener){return this._listeners?this.removeEventListener(type,listener):this._listeners={},this._listeners[type]||(this._listeners[type]=[]),this._listeners[type].push(listener),listener},p.removeEventListener=function(type,listener){if(this._listeners&&this._listeners[type])for(var arr=this._listeners[type],i=0,l=arr.length;i<l;i++)if(arr[i]==listener){1==l?delete this._listeners[type]:arr.splice(i,1);break}},p.removeAllEventListeners=function(type){type?this._listeners&&delete this._listeners[type]:this._listeners=null},p.dispatchEvent=function(eventName,eventTarget){var ret=!1,listeners=this._listeners;if(eventName&&listeners){var arr=listeners[eventName];if(!arr)return ret;arr=arr.slice();for(var handler,i=arr.length;i--;){var handler=arr[i];ret=ret||handler(eventTarget)}}return!!ret},p.hasEventListener=function(type){var listeners=this._listeners;return!(!listeners||!listeners[type])},EventDispatcher.initialize(Proton.prototype),Proton.EventDispatcher=EventDispatcher;var Util=Util||{initValue:function(value,defaults){var value=null!=value&&void 0!=value?value:defaults;return value},isArray:function(value){return"object"===("undefined"==typeof value?"undefined":_typeof(value))&&value.hasOwnProperty("length")},destroyArray:function(array){array.length=0},destroyObject:function(obj){for(var o in obj)delete obj[o]},getVector2D:function(postionOrX,y){if("object"==("undefined"==typeof postionOrX?"undefined":_typeof(postionOrX)))return postionOrX;var vector2d=new Proton.Vector2D(postionOrX,y);return vector2d},classApply:function(constructor,argArray){if(!argArray)return new constructor;var args=[null].concat(argArray),factoryFunction=constructor.bind.apply(constructor,args);return new factoryFunction},judgeVector2D:function(pOBJ){var result="";return(pOBJ.hasOwnProperty("x")||pOBJ.hasOwnProperty("y")||pOBJ.hasOwnProperty("p")||pOBJ.hasOwnProperty("position"))&&(result+="p"),(pOBJ.hasOwnProperty("vx")||pOBJ.hasOwnProperty("vx")||pOBJ.hasOwnProperty("v")||pOBJ.hasOwnProperty("velocity"))&&(result+="v"),(pOBJ.hasOwnProperty("ax")||pOBJ.hasOwnProperty("ax")||pOBJ.hasOwnProperty("a")||pOBJ.hasOwnProperty("accelerate"))&&(result+="a"),result},setVector2DByObject:function(target,pOBJ){pOBJ.hasOwnProperty("x")&&(target.p.x=pOBJ.x),pOBJ.hasOwnProperty("y")&&(target.p.y=pOBJ.y),pOBJ.hasOwnProperty("vx")&&(target.v.x=pOBJ.vx),pOBJ.hasOwnProperty("vy")&&(target.v.y=pOBJ.vy),pOBJ.hasOwnProperty("ax")&&(target.a.x=pOBJ.ax),pOBJ.hasOwnProperty("ay")&&(target.a.y=pOBJ.ay),pOBJ.hasOwnProperty("p")&&particle.p.copy(pOBJ.p),pOBJ.hasOwnProperty("v")&&particle.v.copy(pOBJ.v),pOBJ.hasOwnProperty("a")&&particle.a.copy(pOBJ.a),pOBJ.hasOwnProperty("position")&&particle.p.copy(pOBJ.position),pOBJ.hasOwnProperty("velocity")&&particle.v.copy(pOBJ.velocity),pOBJ.hasOwnProperty("accelerate")&&particle.a.copy(pOBJ.accelerate)},addPrototypeByObject:function(target,prototypeObject,filters){for(var singlePrototype in prototypeObject)filters?filters.indexOf(singlePrototype)<0&&(target[singlePrototype]=Proton.Util.getSpanValue(prototypeObject[singlePrototype])):target[singlePrototype]=Proton.Util.getSpanValue(prototypeObject[singlePrototype]);return target},setPrototypeByObject:function(target,prototypeObject,filters){for(var singlePrototype in prototypeObject)target.hasOwnProperty(singlePrototype)&&(filters?filters.indexOf(singlePrototype)<0&&(target[singlePrototype]=Proton.Util.getSpanValue(prototypeObject[singlePrototype])):target[singlePrototype]=Proton.Util.getSpanValue(prototypeObject[singlePrototype]));return target},setSpanValue:function(a,b,c){return a instanceof Proton.Span?a:b?c?new Proton.Span(a,b,c):new Proton.Span(a,b):new Proton.Span(a)},getSpanValue:function(pan){return pan instanceof Proton.Span?pan.getValue():pan},inherits:function(subClass,superClass){if(subClass._super_=superClass,Object.create)subClass.prototype=Object.create(superClass.prototype,{constructor:{value:subClass}});else{var F=function(){};F.prototype=superClass.prototype,subClass.prototype=new F,subClass.prototype.constructor=subClass}},getImageData:function(context,image,rect){context.drawImage(image,rect.x,rect.y);var imagedata=context.getImageData(rect.x,rect.y,rect.width,rect.height);return imagedata},getImage:function(img,particle,drawCanvas,fun){"string"==typeof img?this.loadAndSetImage(img,particle,drawCanvas,fun):"object"==("undefined"==typeof img?"undefined":_typeof(img))?this.loadAndSetImage(img.src,particle,drawCanvas,fun):img instanceof Image&&this.loadedImage(img.src,particle,drawCanvas,fun,img)},loadedImage:function(src,particle,drawCanvas,fun,target){if(particle.target=target,particle.transform.src=src,Proton.TextureBuffer[src]||(Proton.TextureBuffer[src]=particle.target),drawCanvas)if(Proton.TextureCanvasBuffer[src])particle.transform.canvas=Proton.TextureCanvasBuffer[src];else{var _width=Proton.WebGLUtil.nhpot(particle.target.width),_height=Proton.WebGLUtil.nhpot(particle.target.height);particle.transform.canvas=Proton.DomUtil.createCanvas("canvas"+src,_width,_height);var context=particle.transform.canvas.getContext("2d");context.drawImage(particle.target,0,0,particle.target.width,particle.target.height),Proton.TextureCanvasBuffer[src]=particle.transform.canvas}fun&&fun(particle)},loadAndSetImage:function(src,particle,drawCanvas,fun){if(Proton.TextureBuffer[src])this.loadedImage(src,particle,drawCanvas,fun,Proton.TextureBuffer[src]);else{var self=this,myImage=new Image;myImage.onload=function(e){self.loadedImage(src,particle,drawCanvas,fun,e.target)},myImage.src=src}},hexToRGB:function(h){var hex16="#"==h.charAt(0)?h.substring(1,7):h,r=parseInt(hex16.substring(0,2),16),g=parseInt(hex16.substring(2,4),16),b=parseInt(hex16.substring(4,6),16);return{r:r,g:g,b:b}},rgbToHex:function(rbg){return"rgb("+rbg.r+", "+rbg.g+", "+rbg.b+")"}};Proton.Util=Util,Function.prototype.bind||(Function.prototype.bind=function(oThis){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP?this:oThis||this,aArgs.concat(Array.prototype.slice.call(arguments)))};return fNOP.prototype=this.prototype,fBound.prototype=new fNOP,fBound});var WebGLUtil=WebGLUtil||{ipot:function(length){return 0==(length&length-1)},nhpot:function(length){--length;for(var i=1;i<32;i<<=1)length|=length>>i;return length+1},makeTranslation:function(tx,ty){return[1,0,0,0,1,0,tx,ty,1]},makeRotation:function(angleInRadians){var c=Math.cos(angleInRadians),s=Math.sin(angleInRadians);return[c,-s,0,s,c,0,0,0,1]},makeScale:function(sx,sy){return[sx,0,0,0,sy,0,0,0,1]},matrixMultiply:function(a,b){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];return[a00*b00+a01*b10+a02*b20,a00*b01+a01*b11+a02*b21,a00*b02+a01*b12+a02*b22,a10*b00+a11*b10+a12*b20,a10*b01+a11*b11+a12*b21,a10*b02+a11*b12+a12*b22,a20*b00+a21*b10+a22*b20,a20*b01+a21*b11+a22*b21,a20*b02+a21*b12+a22*b22]}};Proton.WebGLUtil=WebGLUtil;var DomUtil=DomUtil||{createCanvas:function($id,$width,$height,$position){var element=document.createElement("canvas"),position=$position?$position:"absolute";return element.id=$id,element.width=$width,element.height=$height,element.style.position=position,element.style.opacity=0,this.transformDom(element,-500,-500,0,0),element},transformDom:function($div,$x,$y,$scale,$rotate){$div.style.WebkitTransform="translate("+$x+"px, "+$y+"px) scale("+$scale+") rotate("+$rotate+"deg)",$div.style.MozTransform="translate("+$x+"px, "+$y+"px) scale("+$scale+") rotate("+$rotate+"deg)",$div.style.OTransform="translate("+$x+"px, "+$y+"px) scale("+$scale+") rotate("+$rotate+"deg)",$div.style.msTransform="translate("+$x+"px, "+$y+"px) scale("+$scale+") rotate("+$rotate+"deg)",$div.style.transform="translate("+$x+"px, "+$y+"px) scale("+$scale+") rotate("+$rotate+"deg)"}};Proton.DomUtil=DomUtil,MStack.prototype.set=function(m,i){0==i?Proton.Mat3.set(m,this.mats[0]):Proton.Mat3.multiply(this.mats[i-1],m,this.mats[i]),this.size=Math.max(this.size,i+1)},MStack.prototype.push=function(m){0==this.size?Proton.Mat3.set(m,this.mats[0]):Proton.Mat3.multiply(this.mats[this.size-1],m,this.mats[this.size]),this.size++},MStack.prototype.pop=function(){this.size>0&&this.size--},MStack.prototype.top=function(){return this.mats[this.size-1]},Proton.MStack=MStack,Particle.ID=0,Particle.prototype={getDirection:function(){return Math.atan2(this.v.x,-this.v.y)*(180/Math.PI)},reset:function(init){return this.life=1/0,this.age=0,this.energy=1,this.dead=!1,this.sleep=!1,this.target=null,this.sprite=null,this.parent=null,this.mass=1,this.radius=10,this.alpha=1,this.scale=1,this.rotation=0,this.color=null,this.easing=Proton.ease.setEasingByName(Proton.easeLinear),init?(this.transform={},this.p=new Proton.Vector2D,this.v=new Proton.Vector2D,this.a=new Proton.Vector2D,this.old={p:new Proton.Vector2D,v:new Proton.Vector2D,a:new Proton.Vector2D},this.behaviours=[]):(Proton.Util.destroyObject(this.transform),this.p.set(0,0),this.v.set(0,0),this.a.set(0,0),this.old.p.set(0,0),this.old.v.set(0,0),this.old.a.set(0,0),this.removeAllBehaviours()),this.transform.rgb={r:255,g:255,b:255},this},update:function(time,index){if(!this.sleep){this.age+=time;var i,length=this.behaviours.length;for(i=0;i<length;i++)this.behaviours[i]&&this.behaviours[i].applyBehaviour(this,time,index)}if(this.age>=this.life)this.destroy();else{var scale=this.easing(this.age/this.life);this.energy=Math.max(1-scale,0)}},addBehaviour:function(behaviour){this.behaviours.push(behaviour),behaviour.hasOwnProperty("parents")&&behaviour.parents.push(this),behaviour.initialize(this)},addBehaviours:function(behaviours){var i,length=behaviours.length;for(i=0;i<length;i++)this.addBehaviour(behaviours[i])},removeBehaviour:function(behaviour){var index=this.behaviours.indexOf(behaviour);if(index>-1){var behaviour=this.behaviours.splice(index,1);behaviour.parents=null}},removeAllBehaviours:function(){Proton.Util.destroyArray(this.behaviours)},destroy:function(){this.removeAllBehaviours(),this.energy=0,this.dead=!0,this.parent=null}},Proton.Particle=Particle,Pool.prototype={create:function(obj,params){return this.cID++,"function"==typeof obj?Proton.Util.classApply(obj,params):obj.clone()},getCount:function(){var count=0;for(var id in this.list)count+=this.list[id].length;return count++},get:function(obj,params){var p,puid=obj.__puid||PUID.id(obj);return p=this.list[puid]&&this.list[puid].length>0?this.list[puid].pop():this.create(obj,params),p.__puid=obj.__puid||puid,p},set:function(obj){return this._getList(obj.__puid).push(obj)},destroy:function(){for(var id in this.list)this.list[id].length=0,delete this.list[id]},_getList:function(uid){return uid=uid||"default",this.list[uid]||(this.list[uid]=[]),this.list[uid]}},Proton.Pool=Pool;var PUID={_id:0,_uids:{},id:function id(obj){for(var id in this._uids)if(this._uids[id]==obj)return id;var nid="PUID_"+this._id++;return this._uids[nid]=obj,nid},hash:function(str){}},MathUtils={randomAToB:function(a,b,INT){return INT?Math.floor(Math.random()*(b-a))+a:a+Math.random()*(b-a)},randomFloating:function(center,f,INT){return MathUtils.randomAToB(center-f,center+f,INT)},randomZone:function(display){},degreeTransform:function(a){return a*Math.PI/180},toColor16:function(num){return"#"+num.toString(16)},randomColor:function(){return"#"+("00000"+(16777216*Math.random()<<0).toString(16)).slice(-6)}};Proton.MathUtils=MathUtils;var NumericalIntegration=function(type){this.type=Proton.Util.initValue(type,Proton.EULER)};NumericalIntegration.prototype={integrate:function(particles,time,damping){this.eulerIntegrate(particles,time,damping)},eulerIntegrate:function(particle,time,damping){particle.sleep||(particle.old.p.copy(particle.p),particle.old.v.copy(particle.v),particle.a.multiplyScalar(1/particle.mass),particle.v.add(particle.a.multiplyScalar(time)),particle.p.add(particle.old.v.multiplyScalar(time)),damping&&particle.v.multiplyScalar(damping),particle.a.clear())}},Proton.NumericalIntegration=NumericalIntegration;var Vector2D=function(x,y){this.x=x||0,this.y=y||0};Vector2D.prototype={set:function(x,y){return this.x=x,this.y=y,this},setX:function(x){return this.x=x,this},setY:function(y){return this.y=y,this},getGradient:function(){return 0!=this.x?Math.atan2(this.y,this.x):this.y>0?Math.PI/2:this.y<0?-Math.PI/2:void 0},copy:function(v){return this.x=v.x,this.y=v.y,this},add:function(v,w){return void 0!==w?this.addVectors(v,w):(this.x+=v.x,this.y+=v.y,this)},addXY:function(a,b){return this.x+=a,this.y+=b,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},addScalar:function(s){return this.x+=s,this.y+=s,this},sub:function(v,w){return void 0!==w?this.subVectors(v,w):(this.x-=v.x,this.y-=v.y,this)},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},multiplyScalar:function(s){return this.x*=s,this.y*=s,this},divideScalar:function(s){return 0!==s?(this.x/=s,this.y/=s):this.set(0,0),this},min:function(v){return this.x>v.x&&(this.x=v.x),this.y>v.y&&(this.y=v.y),this},max:function(v){return this.x<v.x&&(this.x=v.x),this.y<v.y&&(this.y=v.y),this},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(v){return Math.sqrt(this.distanceToSquared(v))},rotate:function(tha){var x=this.x,y=this.y;return this.x=x*Math.cos(tha)+y*Math.sin(tha),this.y=-x*Math.sin(tha)+y*Math.cos(tha),this},distanceToSquared:function(v){var dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy},setLength:function(l){var oldLength=this.length();return 0!==oldLength&&l!==oldLength&&this.multiplyScalar(l/oldLength),this},lerp:function(v,alpha){return this.x+=(v.x-this.x)*alpha,this.y+=(v.y-this.y)*alpha,this},equals:function(v){return v.x===this.x&&v.y===this.y},toArray:function(){return[this.x,this.y]},clear:function(){return this.x=0,this.y=0,this},clone:function(){return new Proton.Vector2D(this.x,this.y)}},Proton.Vector2D=Vector2D;var Polar2D=function(r,tha){this.r=Math.abs(r)||0,this.tha=tha||0};Polar2D.prototype={set:function(r,tha){return this.r=r,this.tha=tha,this},setR:function(r){return this.r=r,this},setTha:function(tha){return this.tha=tha,this},copy:function(p){return this.r=p.r,this.tha=p.tha,this},toVector:function(){return new Proton.Vector2D(this.getX(),this.getY())},getX:function(){return this.r*Math.sin(this.tha)},getY:function(){return-this.r*Math.cos(this.tha)},normalize:function(){return this.r=1,this},equals:function(v){return v.r===this.r&&v.tha===this.tha},toArray:function(){return[this.r,this.tha]},clear:function(){return this.r=0,this.tha=0,this},clone:function(){return new Proton.Polar2D(this.r,this.tha)}},Proton.Polar2D=Polar2D,Span.prototype={getValue:function(INT){return this.isArray?this.a[Math.floor(this.a.length*Math.random())]:this.center?Proton.MathUtils.randomFloating(this.a,this.b,INT):Proton.MathUtils.randomAToB(this.a,this.b,INT)}},Proton.Span=Span,Proton.getSpan=function(a,b,center){return new Proton.Span(a,b,center)},Proton.Util.inherits(ColorSpan,Proton.Span),ColorSpan.prototype.getValue=function(){var color=this.colorArr[Math.floor(this.colorArr.length*Math.random())];return"random"==color||"Random"==color?Proton.MathUtils.randomColor():color},Proton.ColorSpan=ColorSpan,Rectangle.prototype={contains:function(x,y){return x<=this.right&&x>=this.x&&y<=this.bottom&&y>=this.y}},Proton.Rectangle=Rectangle;var Mat3=Mat3||{create:function(mat3){var mat=new Float32Array(9);return mat3&&this.set(mat3,mat),mat},set:function(mat1,mat2){for(var i=0;i<9;i++)mat2[i]=mat1[i];return mat2},multiply:function(mat,mat2,mat3){var a00=mat[0],a01=mat[1],a02=mat[2],a10=mat[3],a11=mat[4],a20=mat[6],a21=mat[7],b00=mat2[0],b01=mat2[1],b02=mat2[2],b10=mat2[3],b11=mat2[4],b20=mat2[6],b21=mat2[7];return mat3[0]=b00*a00+b01*a10,mat3[1]=b00*a01+b01*a11,mat3[2]=a02*b02,mat3[3]=b10*a00+b11*a10,mat3[4]=b10*a01+b11*a11,mat3[6]=b20*a00+b21*a10+a20,mat3[7]=b20*a01+b21*a11+a21,mat3},inverse:function(mat,mat3){var id,a00=mat[0],a01=mat[1],a10=mat[3],a11=mat[4],a20=mat[6],a21=mat[7],b01=a11,b11=-a10,b21=a21*a10-a11*a20,d=a00*b01+a01*b11;return id=1/d,mat3[0]=b01*id,mat3[1]=-a01*id,mat3[3]=b11*id,mat3[4]=a00*id,mat3[6]=b21*id,mat3[7]=(-a21*a00+a01*a20)*id,mat3},multiplyVec2:function(m,vec,mat3){var x=vec[0],y=vec[1];return mat3[0]=x*m[0]+y*m[3]+m[6],mat3[1]=x*m[1]+y*m[4]+m[7],mat3}};Proton.Mat3=Mat3,Behaviour.id=0,Behaviour.prototype={reset:function(life,easing){this.life=Proton.Util.initValue(life,1/0),this.easing=Proton.Util.initValue(easing,Proton.ease.setEasingByName(Proton.easeLinear))},normalizeForce:function(force){return force.multiplyScalar(Proton.MEASURE)},normalizeValue:function(value){return value*Proton.MEASURE},initialize:function(particle){},applyBehaviour:function(particle,time,index){if(this.age+=time,this.age>=this.life||this.dead)this.energy=0,this.dead=!0,this.destroy();else{var scale=this.easing(particle.age/particle.life);this.energy=Math.max(1-scale,0)}},destroy:function(){var i,length=this.parents.length;for(i=0;i<length;i++)this.parents[i].removeBehaviour(this);this.parents=[]}},Proton.Behaviour=Behaviour,Rate.prototype={init:function(){this.startTime=0,this.nextTime=this.timePan.getValue()},getValue:function(time){return this.startTime+=time,this.startTime>=this.nextTime?(this.startTime=0,this.nextTime=this.timePan.getValue(),1==this.numPan.b?this.numPan.getValue(!1)>.5?1:0:this.numPan.getValue(!0)):0}},Proton.Rate=Rate,Initialize.prototype.reset=function(){},Initialize.prototype.init=function(emitter,particle){particle?this.initialize(particle):this.initialize(emitter)},Initialize.prototype.initialize=function(target){},Proton.Initialize=Initialize;var InitializeUtil={initialize:function(emitter,particle,initializes){var i,length=initializes.length;for(i=0;i<length;i++)initializes[i]instanceof Proton.Initialize?initializes[i].init(emitter,particle):Proton.InitializeUtil.init(emitter,particle,initializes[i]);Proton.InitializeUtil.bindEmitter(emitter,particle)},init:function(emitter,particle,initialize){Proton.Util.setPrototypeByObject(particle,initialize),Proton.Util.setVector2DByObject(particle,initialize)},bindEmitter:function(emitter,particle){emitter.bindEmitter&&(particle.p.add(emitter.p),particle.v.add(emitter.v),particle.a.add(emitter.a),particle.v.rotate(Proton.MathUtils.degreeTransform(emitter.rotation)))}};Proton.InitializeUtil=InitializeUtil,Proton.Util.inherits(Life,Proton.Initialize),Life.prototype.initialize=function(target){this.lifePan.a==1/0?target.life=1/0:target.life=this.lifePan.getValue()},Proton.Life=Life,Proton.Util.inherits(Position,Proton.Initialize),Position.prototype.reset=function(zone){this.zone=Proton.Util.initValue(zone,new Proton.PointZone)},Position.prototype.initialize=function(target){this.zone.getPosition(),target.p.x=this.zone.vector.x,target.p.y=this.zone.vector.y},Proton.Position=Position,Proton.P=Position,Proton.Util.inherits(Velocity,Proton.Initialize),Velocity.prototype.reset=function(rpan,thapan,type){this.rPan=Proton.Util.setSpanValue(rpan),this.thaPan=Proton.Util.setSpanValue(thapan),this.type=Proton.Util.initValue(type,"vector")},Velocity.prototype.normalizeVelocity=function(vr){return vr*Proton.MEASURE},Velocity.prototype.initialize=function(target){if("p"==this.type||"P"==this.type||"polar"==this.type){var polar2d=new Proton.Polar2D(this.normalizeVelocity(this.rPan.getValue()),this.thaPan.getValue()*Math.PI/180);target.v.x=polar2d.getX(),target.v.y=polar2d.getY()}else target.v.x=this.normalizeVelocity(this.rPan.getValue()),target.v.y=this.normalizeVelocity(this.thaPan.getValue())},Proton.Velocity=Velocity,Proton.V=Velocity,Proton.Util.inherits(Mass,Proton.Initialize),Mass.prototype.initialize=function(target){target.mass=this.massPan.getValue()},Proton.Mass=Mass,Proton.Util.inherits(Radius,Proton.Initialize),Radius.prototype.reset=function(a,b,c){this.radius=Proton.Util.setSpanValue(a,b,c)},Radius.prototype.initialize=function(particle){particle.radius=this.radius.getValue(),particle.transform.oldRadius=particle.radius},Proton.Radius=Radius,Proton.Util.inherits(ImageTarget,Proton.Initialize),ImageTarget.prototype.initialize=function(particle){var imagetarget=this.image.getValue();"string"==typeof imagetarget?particle.target={width:this.w,height:this.h,src:imagetarget}:particle.target=imagetarget},ImageTarget.prototype.setSpanValue=function(color){return color instanceof Proton.ColorSpan?color:new Proton.ColorSpan(color)},Proton.ImageTarget=ImageTarget,Proton.Util.inherits(Force,Proton.Behaviour),Force.prototype.reset=function(fx,fy,life,easing){this.force=this.normalizeForce(new Proton.Vector2D(fx,fy)),life&&Force._super_.prototype.reset.call(this,life,easing)},Force.prototype.applyBehaviour=function(particle,time,index){Force._super_.prototype.applyBehaviour.call(this,particle,time,index),particle.a.add(this.force)},Proton.Force=Force,Proton.F=Force,Proton.Util.inherits(Attraction,Proton.Behaviour),Attraction.prototype.reset=function(targetPosition,force,radius,life,easing){this.targetPosition=Proton.Util.initValue(targetPosition,new Proton.Vector2D),this.radius=Proton.Util.initValue(radius,1e3),this.force=Proton.Util.initValue(this.normalizeValue(force),100),this.radiusSq=this.radius*this.radius,this.attractionForce=new Proton.Vector2D,this.lengthSq=0,life&&Attraction._super_.prototype.reset.call(this,life,easing)},Attraction.prototype.applyBehaviour=function(particle,time,index){Attraction._super_.prototype.applyBehaviour.call(this,particle,time,index),this.attractionForce.copy(this.targetPosition),this.attractionForce.sub(particle.p),this.lengthSq=this.attractionForce.lengthSq(),this.lengthSq>4e-6&&this.lengthSq<this.radiusSq&&(this.attractionForce.normalize(),this.attractionForce.multiplyScalar(1-this.lengthSq/this.radiusSq),this.attractionForce.multiplyScalar(this.force),particle.a.add(this.attractionForce))},Proton.Attraction=Attraction,Proton.Util.inherits(RandomDrift,Proton.Behaviour),RandomDrift.prototype.reset=function(driftX,driftY,delay,life,easing){this.panFoce=new Proton.Vector2D(driftX,driftY),this.panFoce=this.normalizeForce(this.panFoce),this.delay=delay,life&&RandomDrift._super_.prototype.reset.call(this,life,easing)},RandomDrift.prototype.applyBehaviour=function(particle,time,index){RandomDrift._super_.prototype.applyBehaviour.call(this,particle,time,index),this.time+=time,this.time>=this.delay&&(particle.a.addXY(Proton.MathUtils.randomAToB(-this.panFoce.x,this.panFoce.x),Proton.MathUtils.randomAToB(-this.panFoce.y,this.panFoce.y)),this.time=0)},Proton.RandomDrift=RandomDrift,Proton.Util.inherits(Repulsion,Proton.Attraction),Repulsion.prototype.reset=function(targetPosition,force,radius,life,easing){Repulsion._super_.prototype.reset.call(this,targetPosition,force,radius,life,easing),this.force*=-1},Proton.Repulsion=Repulsion,Proton.Util.inherits(Gravity,Proton.Force),Gravity.prototype.reset=function(g,life,easing){Gravity._super_.prototype.reset.call(this,0,g,life,easing)},Proton.Gravity=Gravity,Proton.G=Gravity,Proton.Util.inherits(Collision,Proton.Behaviour),Collision.prototype.reset=function(emitter,mass,callback,life,easing){this.emitter=Proton.Util.initValue(emitter,null),this.mass=Proton.Util.initValue(mass,!0),this.callback=Proton.Util.initValue(callback,null),this.collisionPool=[],this.delta=new Proton.Vector2D,life&&Collision._super_.prototype.reset.call(this,life,easing)},Collision.prototype.applyBehaviour=function(particle,time,index){for(var otherParticle,lengthSq,overlap,averageMass1,averageMass2,newPool=this.emitter?this.emitter.particles.slice(index):this.pool.slice(index),length=newPool.length,i=0;i<length;i++)otherParticle=newPool[i],otherParticle!==particle&&(this.delta.copy(otherParticle.p),this.delta.sub(particle.p),lengthSq=this.delta.lengthSq(),distance=particle.radius+otherParticle.radius,lengthSq<=distance*distance&&(overlap=distance-Math.sqrt(lengthSq),overlap+=.5,totalMass=particle.mass+otherParticle.mass,averageMass1=this.mass?otherParticle.mass/totalMass:.5,averageMass2=this.mass?particle.mass/totalMass:.5,particle.p.add(this.delta.clone().normalize().multiplyScalar(overlap*-averageMass1)),otherParticle.p.add(this.delta.normalize().multiplyScalar(overlap*averageMass2)),this.callback&&this.callback(particle,otherParticle)))},Proton.Collision=Collision,Proton.Util.inherits(CrossZone,Proton.Behaviour),CrossZone.prototype.reset=function(zone,crossType,life,easing){this.zone=zone,this.zone.crossType=Proton.Util.initValue(crossType,"dead"),life&&CrossZone._super_.prototype.reset.call(this,life,easing)},CrossZone.prototype.applyBehaviour=function(particle,time,index){CrossZone._super_.prototype.applyBehaviour.call(this,particle,time,index),this.zone.crossing(particle)},Proton.CrossZone=CrossZone,Proton.Util.inherits(Alpha,Proton.Behaviour),Alpha.prototype.reset=function(a,b,life,easing){null==b||void 0==b?this.same=!0:this.same=!1,this.a=Proton.Util.setSpanValue(Proton.Util.initValue(a,1)),this.b=Proton.Util.setSpanValue(b),life&&Alpha._super_.prototype.reset.call(this,life,easing)},Alpha.prototype.initialize=function(particle){particle.transform.alphaA=this.a.getValue(),this.same?particle.transform.alphaB=particle.transform.alphaA:particle.transform.alphaB=this.b.getValue()},Alpha.prototype.applyBehaviour=function(particle,time,index){Alpha._super_.prototype.applyBehaviour.call(this,particle,time,index),particle.alpha=particle.transform.alphaB+(particle.transform.alphaA-particle.transform.alphaB)*this.energy,particle.alpha<.001&&(particle.alpha=0)},Proton.Alpha=Alpha,Proton.Util.inherits(Scale,Proton.Behaviour),Scale.prototype.reset=function(a,b,life,easing){null==b||void 0==b?this.same=!0:this.same=!1,this.a=Proton.Util.setSpanValue(Proton.Util.initValue(a,1)),this.b=Proton.Util.setSpanValue(b),life&&Scale._super_.prototype.reset.call(this,life,easing)},Scale.prototype.initialize=function(particle){particle.transform.scaleA=this.a.getValue(),particle.transform.oldRadius=particle.radius,this.same?particle.transform.scaleB=particle.transform.scaleA:particle.transform.scaleB=this.b.getValue()},Scale.prototype.applyBehaviour=function(particle,time,index){Scale._super_.prototype.applyBehaviour.call(this,particle,time,index),particle.scale=particle.transform.scaleB+(particle.transform.scaleA-particle.transform.scaleB)*this.energy,particle.scale<1e-4&&(particle.scale=0),particle.radius=particle.transform.oldRadius*particle.scale},Proton.Scale=Scale,Proton.Util.inherits(Rotate,Proton.Behaviour),Rotate.prototype.reset=function(a,b,style,life,easing){null==b||void 0==b?this.same=!0:this.same=!1,this.a=Proton.Util.setSpanValue(Proton.Util.initValue(a,"Velocity")),this.b=Proton.Util.setSpanValue(Proton.Util.initValue(b,0)),this.style=Proton.Util.initValue(style,"to"),life&&Rotate._super_.prototype.reset.call(this,life,easing);
},Rotate.prototype.initialize=function(particle){particle.rotation=this.a.getValue(),particle.transform.rotationA=this.a.getValue(),this.same||(particle.transform.rotationB=this.b.getValue())},Rotate.prototype.applyBehaviour=function(particle,time,index){Rotate._super_.prototype.applyBehaviour.call(this,particle,time,index),this.same?"V"!=this.a.a&&"Velocity"!=this.a.a&&"v"!=this.a.a||(particle.rotation=particle.getDirection()):"to"==this.style||"TO"==this.style||"_"==this.style?particle.rotation+=particle.transform.rotationB+(particle.transform.rotationA-particle.transform.rotationB)*this.energy:particle.rotation+=particle.transform.rotationB},Proton.Rotate=Rotate,Proton.Util.inherits(Color,Proton.Behaviour),Color.prototype.reset=function(color1,color2,life,easing){this.color1=this.setSpanValue(color1),this.color2=this.setSpanValue(color2),life&&Color._super_.prototype.reset.call(this,life,easing)},Color.prototype.initialize=function(particle){particle.color=this.color1.getValue(),particle.transform.beginRGB=Proton.Util.hexToRGB(particle.color),this.color2&&(particle.transform.endRGB=Proton.Util.hexToRGB(this.color2.getValue()))},Color.prototype.applyBehaviour=function(particle,time,index){this.color2?(Color._super_.prototype.applyBehaviour.call(this,particle,time,index),particle.transform.rgb.r=particle.transform.endRGB.r+(particle.transform.beginRGB.r-particle.transform.endRGB.r)*this.energy,particle.transform.rgb.g=particle.transform.endRGB.g+(particle.transform.beginRGB.g-particle.transform.endRGB.g)*this.energy,particle.transform.rgb.b=particle.transform.endRGB.b+(particle.transform.beginRGB.b-particle.transform.endRGB.b)*this.energy,particle.transform.rgb.r=parseInt(particle.transform.rgb.r,10),particle.transform.rgb.g=parseInt(particle.transform.rgb.g,10),particle.transform.rgb.b=parseInt(particle.transform.rgb.b,10)):(particle.transform.rgb.r=particle.transform.beginRGB.r,particle.transform.rgb.g=particle.transform.beginRGB.g,particle.transform.rgb.b=particle.transform.beginRGB.b)},Color.prototype.setSpanValue=function(color){return color?color instanceof Proton.ColorSpan?color:new Proton.ColorSpan(color):null},Proton.Color=Color,Proton.Util.inherits(GravityWell,Proton.Behaviour),GravityWell.prototype.reset=function(centerPoint,force,life,easing){this.distanceVec=new Proton.Vector2D,this.centerPoint=Proton.Util.initValue(centerPoint,new Proton.Vector2D),this.force=Proton.Util.initValue(this.normalizeValue(force),100),life&&GravityWell._super_.prototype.reset.call(this,life,easing)},GravityWell.prototype.initialize=function(particle){},GravityWell.prototype.applyBehaviour=function(particle,time,index){this.distanceVec.set(this.centerPoint.x-particle.p.x,this.centerPoint.y-particle.p.y);var distanceSq=this.distanceVec.lengthSq();if(0!=distanceSq){var distance=this.distanceVec.length(),factor=this.force*time/(distanceSq*distance);particle.v.x+=factor*this.distanceVec.x,particle.v.y+=factor*this.distanceVec.y}},Proton.GravityWell=GravityWell,Emitter.ID=0,Proton.Util.inherits(Emitter,Proton.Particle),Proton.EventDispatcher.initialize(Emitter.prototype),Emitter.prototype.emit=function(emitTime,life){this.emitTime=0,this.emitTotalTimes=Proton.Util.initValue(emitTime,1/0),1==life||"life"==life||"destroy"==life?"once"==emitTime?this.life=1:this.life=this.emitTotalTimes:isNaN(life)||(this.life=life),this.rate.init()},Emitter.prototype.stopEmit=function(){this.emitTotalTimes=-1,this.emitTime=0},Emitter.prototype.removeAllParticles=function(){for(var i=0;i<this.particles.length;i++)this.particles[i].dead=!0},Emitter.prototype.createParticle=function(initialize,behaviour){var particle=Proton.pool.get(Proton.Particle);return this.setupParticle(particle,initialize,behaviour),this.dispatchEvent(Proton.PARTICLE_CREATED,particle),particle},Emitter.prototype.addSelfInitialize=function(pObj){pObj.init?pObj.init(this):this.initAll()},Emitter.prototype.addInitialize=function(){var i,length=arguments.length;for(i=0;i<length;i++)this.initializes.push(arguments[i])},Emitter.prototype.removeInitialize=function(initializer){var index=this.initializes.indexOf(initializer);index>-1&&this.initializes.splice(index,1)},Emitter.prototype.removeInitializers=function(){Proton.Util.destroyArray(this.initializes)},Emitter.prototype.addBehaviour=function(){var i,length=arguments.length;for(i=0;i<length;i++)this.behaviours.push(arguments[i]),arguments[i].hasOwnProperty("parents")&&arguments[i].parents.push(this)},Emitter.prototype.removeBehaviour=function(behaviour){var index=this.behaviours.indexOf(behaviour);index>-1&&this.behaviours.splice(index,1)},Emitter.prototype.removeAllBehaviours=function(){Proton.Util.destroyArray(this.behaviours)},Emitter.prototype.integrate=function(time){var damping=1-this.damping;Proton.integrator.integrate(this,time,damping);var i,length=this.particles.length;for(i=0;i<length;i++){var particle=this.particles[i];particle.update(time,i),Proton.integrator.integrate(particle,time,damping),this.dispatchEvent(Proton.PARTICLE_UPDATE,particle)}},Emitter.prototype.emitting=function(time){if("once"==this.emitTotalTimes){var i,length=this.rate.getValue(99999);for(i=0;i<length;i++)this.createParticle();this.emitTotalTimes="none"}else if(!isNaN(this.emitTotalTimes)&&(this.emitTime+=time,this.emitTime<this.emitTotalTimes)){var i,length=this.rate.getValue(time);for(i=0;i<length;i++)this.createParticle()}},Emitter.prototype.update=function(time){this.age+=time,(this.age>=this.life||this.dead)&&this.destroy(),this.emitting(time),this.integrate(time);var particle,k,length=this.particles.length;for(k=length-1;k>=0;k--)particle=this.particles[k],particle.dead&&(this.dispatchEvent(Proton.PARTICLE_DEAD,particle),Proton.pool.set(particle),this.particles.splice(k,1))},Emitter.prototype.setupParticle=function(particle,initialize,behaviour){var initializes=this.initializes,behaviours=this.behaviours;initialize&&(initializes=initialize instanceof Array?initialize:[initialize]),behaviour&&(behaviours=behaviour instanceof Array?behaviour:[behaviour]),particle.reset(),Proton.InitializeUtil.initialize(this,particle,initializes),particle.addBehaviours(behaviours),particle.parent=this,this.particles.push(particle)},Emitter.prototype.destroy=function(){this.dead=!0,this.emitTotalTimes=-1,0==this.particles.length&&(this.removeInitializers(),this.removeAllBehaviours(),this.parent&&this.parent.removeEmitter(this))},Proton.Emitter=Emitter,Proton.Util.inherits(BehaviourEmitter,Proton.Emitter),BehaviourEmitter.prototype.addSelfBehaviour=function(){var i,length=arguments.length;for(i=0;i<length;i++)this.selfBehaviours.push(arguments[i])},BehaviourEmitter.prototype.removeSelfBehaviour=function(behaviour){var index=this.selfBehaviours.indexOf(behaviour);index>-1&&this.selfBehaviours.splice(index,1)},BehaviourEmitter.prototype.update=function(time){if(BehaviourEmitter._super_.prototype.update.call(this,time),!this.sleep){var i,length=this.selfBehaviours.length;for(i=0;i<length;i++)this.selfBehaviours[i].applyBehaviour(this,time,i)}},Proton.BehaviourEmitter=BehaviourEmitter,Proton.Util.inherits(FollowEmitter,Proton.Emitter),FollowEmitter.prototype.initEventHandler=function(){var self=this;this.mousemoveHandler=function(e){self.mousemove.call(self,e)},this.mousedownHandler=function(e){self.mousedown.call(self,e)},this.mouseupHandler=function(e){self.mouseup.call(self,e)},this.mouseTarget.addEventListener("mousemove",this.mousemoveHandler,!1)},FollowEmitter.prototype.emit=function(){this._allowEmitting=!0},FollowEmitter.prototype.stopEmit=function(){this._allowEmitting=!1},FollowEmitter.prototype.mousemove=function(e){e.layerX||0==e.layerX?(this.p.x+=(e.layerX-this.p.x)*this.ease,this.p.y+=(e.layerY-this.p.y)*this.ease):(e.offsetX||0==e.offsetX)&&(this.p.x+=(e.offsetX-this.p.x)*this.ease,this.p.y+=(e.offsetY-this.p.y)*this.ease),this._allowEmitting&&FollowEmitter._super_.prototype.emit.call(this,"once")},FollowEmitter.prototype.destroy=function(){FollowEmitter._super_.prototype.destroy.call(this),this.mouseTarget.removeEventListener("mousemove",this.mousemoveHandler,!1)},Proton.FollowEmitter=FollowEmitter;var ease=ease||{easeLinear:function(value){return value},easeInQuad:function(value){return Math.pow(value,2)},easeOutQuad:function(value){return-(Math.pow(value-1,2)-1)},easeInOutQuad:function(value){return(value/=.5)<1?.5*Math.pow(value,2):-.5*((value-=2)*value-2)},easeInCubic:function(value){return Math.pow(value,3)},easeOutCubic:function(value){return Math.pow(value-1,3)+1},easeInOutCubic:function(value){return(value/=.5)<1?.5*Math.pow(value,3):.5*(Math.pow(value-2,3)+2)},easeInQuart:function(value){return Math.pow(value,4)},easeOutQuart:function(value){return-(Math.pow(value-1,4)-1)},easeInOutQuart:function(value){return(value/=.5)<1?.5*Math.pow(value,4):-.5*((value-=2)*Math.pow(value,3)-2)},easeInSine:function(value){return-Math.cos(value*(Math.PI/2))+1},easeOutSine:function(value){return Math.sin(value*(Math.PI/2))},easeInOutSine:function(value){return-.5*(Math.cos(Math.PI*value)-1)},easeInExpo:function(value){return 0===value?0:Math.pow(2,10*(value-1))},easeOutExpo:function(value){return 1===value?1:-Math.pow(2,-10*value)+1},easeInOutExpo:function(value){return 0===value?0:1===value?1:(value/=.5)<1?.5*Math.pow(2,10*(value-1)):.5*(-Math.pow(2,-10*--value)+2)},easeInCirc:function(value){return-(Math.sqrt(1-value*value)-1)},easeOutCirc:function(value){return Math.sqrt(1-Math.pow(value-1,2))},easeInOutCirc:function(value){return(value/=.5)<1?-.5*(Math.sqrt(1-value*value)-1):.5*(Math.sqrt(1-(value-=2)*value)+1)},easeInBack:function(value){var s=1.70158;return value*value*((s+1)*value-s)},easeOutBack:function(value){var s=1.70158;return(value-=1)*value*((s+1)*value+s)+1},easeInOutBack:function(value){var s=1.70158;return(value/=.5)<1?.5*(value*value*(((s*=1.525)+1)*value-s)):.5*((value-=2)*value*(((s*=1.525)+1)*value+s)+2)},setEasingByName:function(easeName){return ease[easeName]?ease[easeName]:ease.easeLinear}};for(var key in ease)"setEasingByName"!=key&&(Proton[key]=ease[key]);Proton.ease=ease,Renderer.prototype={start:function(){this.addEventHandler(),this.renderer.start()},stop:function(){this.renderer.stop()},resize:function(width,height){this.renderer.resize(width,height)},setStroke:function(color,thinkness){this.renderer.hasOwnProperty("stroke")?this.renderer.setStroke(color,thinkness):alert("Sorry this renderer do not suppest stroke method!")},createImageData:function(data){this.renderer instanceof Proton.PixelRender&&this.renderer.createImageData(data)},setMaxRadius:function(radius){this.renderer instanceof Proton.WebGLRender&&this.renderer.setMaxRadius(radius)},blendEquation:function(A){this.renderer instanceof Proton.WebGLRender&&this.renderer.blendEquation(A)},blendFunc:function(A,B){this.renderer instanceof Proton.WebGLRender&&this.renderer.blendFunc(A,B)},setType:function(type){this.type=type,this.renderer=this.getRenderer()},getRenderer:function(){switch(this.type){case"pixi":return new Proton.PixiRender(this.proton,this.element);case"dom":return new Proton.DomRender(this.proton,this.element);case"canvas":return new Proton.CanvasRender(this.proton,this.element);case"webgl":return new Proton.WebGLRender(this.proton,this.element);case"easel":return new Proton.EaselRender(this.proton,this.element);case"easeljs":return new Proton.EaselRender(this.proton,this.element);case"pixel":return new Proton.PixelRender(this.proton,this.element);default:return new Proton.BaseRender(this.proton,this.element)}},render:function(callback){this.renderer.render(callback)},addEventHandler:function(){this.onProtonUpdate&&(this.renderer.onProtonUpdate=this.onProtonUpdate),this.onParticleCreated&&(this.renderer.onParticleCreated=this.onParticleCreated),this.onParticleUpdate&&(this.renderer.onParticleUpdate=this.onParticleUpdate),this.onParticleDead&&(this.renderer.onParticleDead=this.onParticleDead)}},Proton.Renderer=Renderer,BaseRender.prototype={start:function(){var self=this;this.proton.addEventListener(Proton.PROTON_UPDATE,function(){self.onProtonUpdate.call(self)}),this.proton.addEventListener(Proton.PROTON_UPDATE_AFTER,function(){self.onProtonUpdateAfter.call(self)}),this.proton.addEventListener(Proton.EMITTER_ADDED,function(emitter){self.onEmitterAdded.call(self,emitter)}),this.proton.addEventListener(Proton.EMITTER_REMOVED,function(emitter){self.onEmitterRemoved.call(self,emitter)});var i,length=this.proton.emitters.length;for(i=0;i<length;i++){var emitter=this.proton.emitters[i];this.addEmitterListener(emitter)}},resize:function(width,height){},addEmitterListener:function(emitter){var self=this;emitter.addEventListener(Proton.PARTICLE_CREATED,function(particle){self.onParticleCreated.call(self,particle)}),emitter.addEventListener(Proton.PARTICLE_UPDATE,function(particle){self.onParticleUpdate.call(self,particle)}),emitter.addEventListener(Proton.PARTICLE_DEAD,function(particle){self.onParticleDead.call(self,particle)})},stop:function(){var i,length=this.proton.emitters.length;for(this.proton.removeAllEventListeners(),i=0;i<length;i++){var emitter=this.proton.emitters[i];emitter.removeAllEventListeners()}},onEmitterAdded:function(emitter){this.addEmitterListener(emitter)},onEmitterRemoved:function(emitter){emitter.removeAllEventListeners()},onProtonUpdate:function(){},onProtonUpdateAfter:function(){},onParticleCreated:function(particle){},onParticleUpdate:function(particle){},onParticleDead:function(particle){}},Proton.BaseRender=BaseRender,Proton.Util.inherits(DomRender,Proton.BaseRender),DomRender.prototype.start=function(){DomRender._super_.prototype.start.call(this)},DomRender.prototype.setStroke=function(color,thinkness){color=Proton.Util.initValue(color,"#000000"),thinkness=Proton.Util.initValue(thinkness,1),this.stroke={color:color,thinkness:thinkness}},DomRender.prototype.onProtonUpdate=function(){},DomRender.prototype.onParticleCreated=function(particle){if(particle.target){var self=this;Proton.Util.getImage(particle.target,particle,!1,function(particle){self.setImgInDIV.call(self,particle)})}else particle.transform.canvas=Proton.DomUtil.createCanvas(particle.id+"_canvas",particle.radius+1,particle.radius+1,"absolute"),particle.transform.bakOldRadius=particle.radius,this.stroke?(particle.transform.canvas.width=2*particle.radius+2*this.stroke.thinkness,particle.transform.canvas.height=2*particle.radius+2*this.stroke.thinkness):(particle.transform.canvas.width=2*particle.radius+1,particle.transform.canvas.height=2*particle.radius+1),particle.transform.context=particle.transform.canvas.getContext("2d"),particle.transform.context.fillStyle=particle.color,particle.transform.context.beginPath(),particle.transform.context.arc(particle.radius,particle.radius,particle.radius,0,2*Math.PI,!0),this.stroke&&(particle.transform.context.strokeStyle=this.stroke.color,particle.transform.context.lineWidth=this.stroke.thinkness,particle.transform.context.stroke()),particle.transform.context.closePath(),particle.transform.context.fill(),this.element.appendChild(particle.transform.canvas)},DomRender.prototype.onParticleUpdate=function(particle){particle.target?particle.target instanceof Image&&(particle.transform.canvas.style.opacity=particle.alpha,Proton.DomUtil.transformDom(particle.transform.canvas,particle.p.x-particle.target.width/2,particle.p.y-particle.target.height/2,particle.scale,particle.rotation)):(particle.transform.canvas.style.opacity=particle.alpha,particle.transform.oldRadius?Proton.DomUtil.transformDom(particle.transform.canvas,particle.p.x-particle.transform.oldRadius,particle.p.y-particle.transform.oldRadius,particle.scale,particle.rotation):Proton.DomUtil.transformDom(particle.transform.canvas,particle.p.x-particle.transform.bakOldRadius,particle.p.y-particle.transform.bakOldRadius,particle.scale,particle.rotation))},DomRender.prototype.onParticleDead=function(particle){particle.transform.canvas&&this.element.removeChild(particle.transform.canvas)},DomRender.prototype.setImgInDIV=function(particle){particle.transform.canvas=Proton.DomUtil.createCanvas(particle.id+"_canvas",particle.target.width+1,particle.target.height+1,"absolute",particle.p.x-particle.radius,particle.p.y-particle.radius),particle.transform.context=particle.transform.canvas.getContext("2d"),particle.transform.context.drawImage(particle.target,0,0,particle.target.width,particle.target.height),this.element.appendChild(particle.transform.canvas)},Proton.DomRender=DomRender,Proton.Util.inherits(EaselRender,Proton.BaseRender),EaselRender.prototype.resize=function(width,height){},EaselRender.prototype.start=function(){EaselRender._super_.prototype.start.call(this)},EaselRender.prototype.onProtonUpdate=function(){},EaselRender.prototype.onParticleCreated=function(particle){if(particle.target)particle.target=this.pool.get(particle.target),particle.target.parent||(particle.target.image&&(particle.target.regX=particle.target.image.width/2,particle.target.regY=particle.target.image.height/2),this.element.addChild(particle.target));else{var graphics=this.pool.get(createjs.Graphics);this.stroke&&(1==this.stroke?graphics.beginStroke("#000000"):this.stroke instanceof String&&graphics.beginStroke(this.stroke)),graphics.beginFill(particle.color).drawCircle(0,0,particle.radius);var shape=new createjs.Shape(graphics);particle.target=shape,this.element.addChild(particle.target)}},EaselRender.prototype.onParticleUpdate=function(particle){particle.target&&(particle.target.x=particle.p.x,particle.target.y=particle.p.y,particle.target.alpha=particle.alpha,particle.target.scaleX=particle.target.scaleY=particle.scale,particle.target.rotation=particle.rotation)},EaselRender.prototype.onParticleDead=function(particle){particle.target&&(particle.target.parent&&particle.target.parent.removeChild(particle.target),this.pool.set(particle.target),particle.target=null)},Proton.EaselRender=EaselRender,Proton.Util.inherits(CanvasRender,Proton.BaseRender),CanvasRender.prototype.resize=function(width,height){this.element.width=width,this.element.height=height},CanvasRender.prototype.start=function(){CanvasRender._super_.prototype.start.call(this)},CanvasRender.prototype.setStroke=function(color,thinkness){color=Proton.Util.initValue(color,"#000000"),thinkness=Proton.Util.initValue(thinkness,1),this.stroke={color:color,thinkness:thinkness}},CanvasRender.prototype.onProtonUpdate=function(){},CanvasRender.prototype.onParticleCreated=function(particle){particle.target?Proton.Util.getImage(particle.target,particle,!1):particle.color=particle.color?particle.color:"#ff0000"},CanvasRender.prototype.onParticleUpdate=function(particle){if(particle.target){if(particle.target instanceof Image){var w=particle.target.width*particle.scale|0,h=particle.target.height*particle.scale|0,x=particle.p.x-w/2,y=particle.p.y-h/2;if(particle.color){particle.transform.buffer||(particle.transform.buffer=this.getBuffer(particle.target));var bufferContext=particle.transform.buffer.getContext("2d");bufferContext.clearRect(0,0,particle.transform.buffer.width,particle.transform.buffer.height),bufferContext.globalAlpha=particle.alpha,bufferContext.drawImage(particle.target,0,0),bufferContext.globalCompositeOperation="source-atop",bufferContext.fillStyle=Proton.Util.rgbToHex(particle.transform.rgb),bufferContext.fillRect(0,0,particle.transform.buffer.width,particle.transform.buffer.height),bufferContext.globalCompositeOperation="source-over",bufferContext.globalAlpha=1,this.context.drawImage(particle.transform.buffer,0,0,particle.transform.buffer.width,particle.transform.buffer.height,x,y,w,h)}else this.context.save(),this.context.globalAlpha=particle.alpha,this.context.translate(particle.p.x,particle.p.y),this.context.rotate(Proton.MathUtils.degreeTransform(particle.rotation)),this.context.translate(-particle.p.x,-particle.p.y),this.context.drawImage(particle.target,0,0,particle.target.width,particle.target.height,x,y,w,h),this.context.globalAlpha=1,this.context.restore()}}else particle.transform.rgb?this.context.fillStyle="rgba("+particle.transform.rgb.r+","+particle.transform.rgb.g+","+particle.transform.rgb.b+","+particle.alpha+")":this.context.fillStyle=particle.color,this.context.beginPath(),this.context.arc(particle.p.x,particle.p.y,particle.radius,0,2*Math.PI,!0),this.stroke&&(this.context.strokeStyle=this.stroke.color,this.context.lineWidth=this.stroke.thinkness,this.context.stroke()),this.context.closePath(),this.context.fill()},CanvasRender.prototype.onParticleDead=function(particle){},CanvasRender.prototype.getBuffer=function(image){if(image instanceof Image){var size=image.width+"_"+image.height,canvas=this.bufferCache[size];return canvas||(canvas=document.createElement("canvas"),canvas.width=image.width,canvas.height=image.height,this.bufferCache[size]=canvas),canvas}},Proton.CanvasRender=CanvasRender,Proton.Util.inherits(PixelRender,Proton.BaseRender),PixelRender.prototype.resize=function(width,height){this.element.width=width,this.element.height=height},PixelRender.prototype.createImageData=function(rectangle){rectangle?this.rectangle=rectangle:this.rectangle=new Proton.Rectangle(0,0,this.element.width,this.element.height),this.imageData=this.context.createImageData(this.rectangle.width,this.rectangle.height),this.context.putImageData(this.imageData,this.rectangle.x,this.rectangle.y)},PixelRender.prototype.start=function(){PixelRender._super_.prototype.start.call(this)},PixelRender.prototype.onProtonUpdate=function(){this.imageData=this.context.getImageData(this.rectangle.x,this.rectangle.y,this.rectangle.width,this.rectangle.height)},PixelRender.prototype.onProtonUpdateAfter=function(){this.context.putImageData(this.imageData,this.rectangle.x,this.rectangle.y)},PixelRender.prototype.onParticleCreated=function(particle){},PixelRender.prototype.onParticleUpdate=function(particle){this.imageData&&this.setPixel(this.imageData,Math.floor(particle.p.x-this.rectangle.x),Math.floor(particle.p.y-this.rectangle.y),particle)},PixelRender.prototype.setPixel=function(imagedata,x,y,particle){var rgb=particle.transform.rgb;if(!(x<0||x>this.element.width||y<0||y>this.elementwidth)){var i=4*((y>>0)*imagedata.width+(x>>0));imagedata.data[i]=rgb.r,imagedata.data[i+1]=rgb.g,imagedata.data[i+2]=rgb.b,imagedata.data[i+3]=255*particle.alpha}},PixelRender.prototype.onParticleDead=function(particle){},Proton.PixelRender=PixelRender,Proton.Util.inherits(WebGLRender,Proton.BaseRender),WebGLRender.prototype.resize=function(width,height){this.umat[4]=-2,this.umat[7]=1,this.smat[0]=1/width,this.smat[4]=1/height,this.mstack.set(this.umat,0),this.mstack.set(this.smat,1),this.gl.viewport(0,0,width,height),this.element.width=width,this.element.height=height},WebGLRender.prototype.setMaxRadius=function(radius){this.circleCanvasURL=this.createCircle(radius)},WebGLRender.prototype.getVertexShader=function(){var vsSource=["uniform vec2 viewport;","attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","uniform mat3 tMat;","varying vec2 vTextureCoord;","varying float alpha;","void main() {","vec3 v = tMat * vec3(aVertexPosition, 1.0);","gl_Position = vec4(v.x, v.y, 0, 1);","vTextureCoord = aTextureCoord;","alpha = tMat[0][2];","}"].join("\n");return vsSource},WebGLRender.prototype.getFragmentShader=function(){var fsSource=["precision mediump float;","varying vec2 vTextureCoord;","varying float alpha;","uniform sampler2D uSampler;","uniform vec4 color;","uniform bool useTexture;","uniform vec3 uColor;","void main() {","vec4 textureColor = texture2D(uSampler, vTextureCoord);","gl_FragColor = textureColor * vec4(uColor, 1.0);","gl_FragColor.w *= alpha;","}"].join("\n");return fsSource},WebGLRender.prototype.initVar=function(){this.mstack=new Proton.MStack,this.umat=Proton.Mat3.create([2,0,1,0,-2,0,-1,1,1]),this.smat=Proton.Mat3.create([.01,0,1,0,.01,0,0,0,1]),this.texturebuffers={}},WebGLRender.prototype.start=function(){WebGLRender._super_.prototype.start.call(this),this.resize(this.element.width,this.element.height)},WebGLRender.prototype.blendEquation=function(A){this.gl.blendEquation(this.gl[A])},WebGLRender.prototype.blendFunc=function(A,B){this.gl.blendFunc(this.gl[A],this.gl[B])},WebGLRender.prototype.getShader=function(gl,str,fs){var shader;return shader=fs?gl.createShader(gl.FRAGMENT_SHADER):gl.createShader(gl.VERTEX_SHADER),gl.shaderSource(shader,str),gl.compileShader(shader),gl.getShaderParameter(shader,gl.COMPILE_STATUS)?shader:(alert(gl.getShaderInfoLog(shader)),null)},WebGLRender.prototype.initShaders=function(){var fragmentShader=this.getShader(this.gl,this.getFragmentShader(),!0),vertexShader=this.getShader(this.gl,this.getVertexShader(),!1);this.sprogram=this.gl.createProgram(),this.gl.attachShader(this.sprogram,vertexShader),this.gl.attachShader(this.sprogram,fragmentShader),this.gl.linkProgram(this.sprogram),this.gl.getProgramParameter(this.sprogram,this.gl.LINK_STATUS)||alert("Could not initialise shaders"),this.gl.useProgram(this.sprogram),this.sprogram.vpa=this.gl.getAttribLocation(this.sprogram,"aVertexPosition"),this.sprogram.tca=this.gl.getAttribLocation(this.sprogram,"aTextureCoord"),this.gl.enableVertexAttribArray(this.sprogram.tca),this.gl.enableVertexAttribArray(this.sprogram.vpa),this.sprogram.tMatUniform=this.gl.getUniformLocation(this.sprogram,"tMat"),this.sprogram.samplerUniform=this.gl.getUniformLocation(this.sprogram,"uSampler"),this.sprogram.useTex=this.gl.getUniformLocation(this.sprogram,"useTexture"),this.sprogram.color=this.gl.getUniformLocation(this.sprogram,"uColor"),this.gl.uniform1i(this.sprogram.useTex,1)},WebGLRender.prototype.initBuffers=function(){this.unitIBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.unitIBuffer);var vs=[0,3,1,0,2,3];this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(vs),this.gl.STATIC_DRAW);for(var ids=[],i=0;i<100;i++)ids.push(i);for(idx=new Uint16Array(ids),this.unitI33=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.unitI33),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,idx,this.gl.STATIC_DRAW),ids=[],i=0;i<100;i++)ids.push(i,i+1,i+2);idx=new Uint16Array(ids),this.stripBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.stripBuffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,idx,this.gl.STATIC_DRAW)},WebGLRender.prototype.createCircle=function(raidus){this.circleCanvasRadius=Proton.WebGLUtil.nhpot(Proton.Util.initValue(raidus,32));var canvas=Proton.DomUtil.createCanvas("circle_canvas",2*this.circleCanvasRadius,2*this.circleCanvasRadius),context=canvas.getContext("2d");return context.beginPath(),context.arc(this.circleCanvasRadius,this.circleCanvasRadius,this.circleCanvasRadius,0,2*Math.PI,!0),context.closePath(),context.fillStyle="#FFF",context.fill(),canvas.toDataURL()},WebGLRender.prototype.setImgInCanvas=function(particle){var _w=particle.target.width,_h=particle.target.height,_width=Proton.WebGLUtil.nhpot(particle.target.width),_height=Proton.WebGLUtil.nhpot(particle.target.height),_scaleX=particle.target.width/_width,_scaleY=particle.target.height/_height;this.texturebuffers[particle.transform.src]||(this.texturebuffers[particle.transform.src]=[this.gl.createTexture(),this.gl.createBuffer(),this.gl.createBuffer()]),particle.transform.texture=this.texturebuffers[particle.transform.src][0],particle.transform.vcBuffer=this.texturebuffers[particle.transform.src][1],particle.transform.tcBuffer=this.texturebuffers[particle.transform.src][2],this.gl.bindBuffer(this.gl.ARRAY_BUFFER,particle.transform.tcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,_scaleX,0,0,_scaleY,_scaleY,_scaleY]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,particle.transform.vcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,_w,0,0,_h,_w,_h]),this.gl.STATIC_DRAW);var context=particle.transform.canvas.getContext("2d"),data=context.getImageData(0,0,_width,_height);this.gl.bindTexture(this.gl.TEXTURE_2D,particle.transform.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,data),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST),this.gl.generateMipmap(this.gl.TEXTURE_2D),particle.transform.textureLoaded=!0,particle.transform.textureWidth=_w,particle.transform.textureHeight=_h},WebGLRender.prototype.setStroke=function(color,thinkness){},WebGLRender.prototype.onProtonUpdate=function(){},WebGLRender.prototype.onParticleCreated=function(particle){var self=this;particle.transform.textureLoaded=!1,particle.transform.tmat=Proton.Mat3.create(),particle.transform.tmat[8]=1,particle.transform.imat=Proton.Mat3.create(),particle.transform.imat[8]=1,particle.target?Proton.Util.getImage(particle.target,particle,!0,function(particle){self.setImgInCanvas.call(self,particle),particle.transform.oldScale=1}):Proton.Util.getImage(this.circleCanvasURL,particle,!0,function(particle){self.setImgInCanvas.call(self,particle),particle.transform.oldScale=particle.radius/self.circleCanvasRadius})},WebGLRender.prototype.onParticleUpdate=function(particle){particle.transform.textureLoaded&&(this.updateMatrix(particle),this.gl.uniform3f(this.sprogram.color,particle.transform.rgb.r/255,particle.transform.rgb.g/255,particle.transform.rgb.b/255),this.gl.uniformMatrix3fv(this.sprogram.tMatUniform,!1,this.mstack.top()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,particle.transform.vcBuffer),this.gl.vertexAttribPointer(this.sprogram.vpa,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,particle.transform.tcBuffer),this.gl.vertexAttribPointer(this.sprogram.tca,2,this.gl.FLOAT,!1,0,0),this.gl.bindTexture(this.gl.TEXTURE_2D,particle.transform.texture),this.gl.uniform1i(this.sprogram.samplerUniform,0),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.unitIBuffer),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0),this.mstack.pop())},WebGLRender.prototype.onParticleDead=function(particle){},WebGLRender.prototype.updateMatrix=function(particle){var moveOriginMatrix=Proton.WebGLUtil.makeTranslation(-particle.transform.textureWidth/2,-particle.transform.textureHeight/2),translationMatrix=Proton.WebGLUtil.makeTranslation(particle.p.x,particle.p.y),angel=particle.rotation*(Math.PI/180),rotationMatrix=Proton.WebGLUtil.makeRotation(angel),scale=particle.scale*particle.transform.oldScale,scaleMatrix=Proton.WebGLUtil.makeScale(scale,scale),matrix=Proton.WebGLUtil.matrixMultiply(moveOriginMatrix,scaleMatrix);matrix=Proton.WebGLUtil.matrixMultiply(matrix,rotationMatrix),matrix=Proton.WebGLUtil.matrixMultiply(matrix,translationMatrix),Proton.Mat3.inverse(matrix,particle.transform.imat),matrix[2]=particle.alpha,this.mstack.push(matrix)},Proton.WebGLRender=WebGLRender,Zone.prototype={getPosition:function(){},crossing:function(particle){}},Proton.Zone=Zone,Proton.Util.inherits(LineZone,Proton.Zone),LineZone.prototype.getPosition=function(){return this.random=Math.random(),this.vector.x=this.x1+this.random*this.length*Math.cos(this.gradient),this.vector.y=this.y1+this.random*this.length*Math.sin(this.gradient),this.vector},LineZone.prototype.getDirection=function(x,y){var A=this.dy,B=-this.dx,C=this.dot,D=0==B?1:B;return(A*x+B*y+C)*D>0},LineZone.prototype.getDistance=function(x,y){var A=this.dy,B=-this.dx,C=this.dot,D=A*x+B*y+C;return D/Math.sqrt(this.xxyy)},LineZone.prototype.getSymmetric=function(v){var tha2=v.getGradient(),tha1=this.getGradient(),tha=2*(tha1-tha2),oldx=v.x,oldy=v.y;return v.x=oldx*Math.cos(tha)-oldy*Math.sin(tha),v.y=oldx*Math.sin(tha)+oldy*Math.cos(tha),v},LineZone.prototype.getGradient=function(){return Math.atan2(this.dy,this.dx)},LineZone.prototype.getRange=function(particle,fun){var angle=Math.abs(this.getGradient());angle<=Math.PI/4?particle.p.x<this.maxx&&particle.p.x>this.minx&&fun():particle.p.y<this.maxy&&particle.p.y>this.miny&&fun()},LineZone.prototype.getLength=function(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)},LineZone.prototype.crossing=function(particle){
var self=this;"dead"==this.crossType?">"==this.direction||"R"==this.direction||"right"==this.direction||"down"==this.direction?this.getRange(particle,function(){self.getDirection(particle.p.x,particle.p.y)&&(particle.dead=!0)}):this.getRange(particle,function(){self.getDirection(particle.p.x,particle.p.y)||(particle.dead=!0)}):"bound"==this.crossType?this.getRange(particle,function(){self.getDistance(particle.p.x,particle.p.y)<=particle.radius&&(0==self.dx?particle.v.x*=-1:0==self.dy?particle.v.y*=-1:self.getSymmetric(particle.v))}):"cross"==this.crossType&&this.alert&&(alert("Sorry lineZone does not support cross method"),this.alert=!1)},Proton.LineZone=LineZone,Proton.Util.inherits(CircleZone,Proton.Zone),CircleZone.prototype.getPosition=function(){return this.random=Math.random(),this.angle=2*Math.PI*Math.random(),this.vector.x=this.x+this.random*this.radius*Math.cos(this.angle),this.vector.y=this.y+this.random*this.radius*Math.sin(this.angle),this.vector},CircleZone.prototype.setCenter=function(x,y){this.center.x=x,this.center.y=y},CircleZone.prototype.crossing=function(particle){var d=particle.p.distanceTo(this.center);"dead"==this.crossType?d-particle.radius>this.radius&&(particle.dead=!0):"bound"==this.crossType?d+particle.radius>=this.radius&&this.getSymmetric(particle):"cross"==this.crossType&&this.alert&&(alert("Sorry CircleZone does not support cross method"),this.alert=!1)},CircleZone.prototype.getSymmetric=function(particle){var tha2=particle.v.getGradient(),tha1=this.getGradient(particle),tha=2*(tha1-tha2),oldx=particle.v.x,oldy=particle.v.y;particle.v.x=oldx*Math.cos(tha)-oldy*Math.sin(tha),particle.v.y=oldx*Math.sin(tha)+oldy*Math.cos(tha)},CircleZone.prototype.getGradient=function(particle){return-Math.PI/2+Math.atan2(particle.p.y-this.center.y,particle.p.x-this.center.x)},Proton.CircleZone=CircleZone,Proton.Util.inherits(PointZone,Proton.Zone),PointZone.prototype.getPosition=function(){return this.vector.x=this.x,this.vector.y=this.y,this.vector},PointZone.prototype.crossing=function(particle){this.alert&&(alert("Sorry PointZone does not support crossing method"),this.alert=!1)},Proton.PointZone=PointZone,Proton.Util.inherits(RectZone,Proton.Zone),RectZone.prototype.getPosition=function(){return this.vector.x=this.x+Math.random()*this.width,this.vector.y=this.y+Math.random()*this.height,this.vector},RectZone.prototype.crossing=function(particle){"dead"==this.crossType?(particle.p.x+particle.radius<this.x?particle.dead=!0:particle.p.x-particle.radius>this.x+this.width&&(particle.dead=!0),particle.p.y+particle.radius<this.y?particle.dead=!0:particle.p.y-particle.radius>this.y+this.height&&(particle.dead=!0)):"bound"==this.crossType?(particle.p.x-particle.radius<this.x?(particle.p.x=this.x+particle.radius,particle.v.x*=-1):particle.p.x+particle.radius>this.x+this.width&&(particle.p.x=this.x+this.width-particle.radius,particle.v.x*=-1),particle.p.y-particle.radius<this.y?(particle.p.y=this.y+particle.radius,particle.v.y*=-1):particle.p.y+particle.radius>this.y+this.height&&(particle.p.y=this.y+this.height-particle.radius,particle.v.y*=-1)):"cross"==this.crossType&&(particle.p.x+particle.radius<this.x&&particle.v.x<=0?particle.p.x=this.x+this.width+particle.radius:particle.p.x-particle.radius>this.x+this.width&&particle.v.x>=0&&(particle.p.x=this.x-particle.radius),particle.p.y+particle.radius<this.y&&particle.v.y<=0?particle.p.y=this.y+this.height+particle.radius:particle.p.y-particle.radius>this.y+this.height&&particle.v.y>=0&&(particle.p.y=this.y-particle.radius))},Proton.RectZone=RectZone,Proton.Util.inherits(ImageZone,Proton.Zone),ImageZone.prototype.reset=function(imageData,x,y,d){this.imageData=imageData,this.x=Proton.Util.initValue(x,0),this.y=Proton.Util.initValue(y,0),this.d=Proton.Util.initValue(d,2),this.vectors=[],this.setVectors()},ImageZone.prototype.setVectors=function(){var i,j,length1=this.imageData.width,length2=this.imageData.height;for(i=0;i<length1;i+=this.d)for(j=0;j<length2;j+=this.d){var index=4*((j>>0)*length1+(i>>0));this.imageData.data[index+3]>0&&this.vectors.push({x:i+this.x,y:j+this.y})}return this.vector},ImageZone.prototype.getBound=function(x,y){var index=4*((y>>0)*this.imageData.width+(x>>0));return this.imageData.data[index+3]>0},ImageZone.prototype.getPosition=function(){return this.vector.copy(this.vectors[Math.floor(Math.random()*this.vectors.length)])},ImageZone.prototype.getColor=function(x,y){x-=this.x,y-=this.y;var i=4*((y>>0)*this.imageData.width+(x>>0));return{r:this.imageData.data[i],g:this.imageData.data[i+1],b:this.imageData.data[i+2],a:this.imageData.data[i+3]}},ImageZone.prototype.crossing=function(particle){"dead"==this.crossType?this.getBound(particle.p.x-this.x,particle.p.y-this.y)?particle.dead=!0:particle.dead=!1:"bound"==this.crossType&&(this.getBound(particle.p.x-this.x,particle.p.y-this.y)||particle.v.negate())},Proton.ImageZone=ImageZone;var Debug=Debug||{addEventListener:function(proton,fun){proton.addEventListener(Proton.PROTON_UPDATE,function(){fun()})},setStyle:function(c){var color=c||"#ff0000",rgb=Proton.Util.hexToRGB(color),style="rgba("+rgb.r+","+rgb.g+","+rgb.b+",0.5)";return style},drawZone:function(proton,canvas,zone,clear){var context=canvas.getContext("2d"),style=this.setStyle();this.addEventListener(proton,function(){clear&&(zone instanceof Proton.PointZone?(context.beginPath(),context.fillStyle=style,context.arc(zone.x,zone.y,10,0,2*Math.PI,!0),context.fill(),context.closePath()):zone instanceof Proton.LineZone?(context.beginPath(),context.strokeStyle=style,context.moveTo(zone.x1,zone.y1),context.lineTo(zone.x2,zone.y2),context.stroke(),context.closePath()):zone instanceof Proton.RectZone?(context.beginPath(),context.strokeStyle=style,context.drawRect(zone.x,zone.y,zone.width,zone.height),context.stroke(),context.closePath()):zone instanceof Proton.CircleZone&&(context.beginPath(),context.strokeStyle=style,context.arc(zone.x,zone.y,zone.radius,0,2*Math.PI,!0),context.stroke(),context.closePath()))})},drawEmitter:function(proton,canvas,emitter,clear){var context=canvas.getContext("2d"),style=this.setStyle();this.addEventListener(proton,function(){clear&&context.beginPath(),context.fillStyle=style,context.arc(emitter.p.x,emitter.p.y,10,0,2*Math.PI,!0),context.fill(),context.closePath()})},test:{},setTest:function(id,value){this.test[id]=value},getTest:function(id){return!!this.test.hasOwnProperty(id)&&this.test[id]}};return Proton.Debug=Debug,function(){for(var lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}(),Proton});var Stats=function Stats(){function addPanel(panel){return container.appendChild(panel.dom),panel}function showPanel(id){for(var i=0;i<container.children.length;i++)container.children[i].style.display=i===id?"block":"none";mode=id}var mode=0,container=document.createElement("div");container.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",container.addEventListener("click",function(event){event.preventDefault(),showPanel(++mode%container.children.length)},!1);var beginTime=(performance||Date).now(),prevTime=beginTime,frames=0,fpsPanel=addPanel(new Stats.Panel("FPS","#0ff","#002")),msPanel=addPanel(new Stats.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var memPanel=addPanel(new Stats.Panel("MB","#f08","#201"));return showPanel(0),{REVISION:16,dom:container,addPanel:addPanel,showPanel:showPanel,begin:function(){beginTime=(performance||Date).now()},end:function(){frames++;var time=(performance||Date).now();if(msPanel.update(time-beginTime,200),time>=prevTime+1e3&&(fpsPanel.update(1e3*frames/(time-prevTime),100),prevTime=time,frames=0,memPanel)){var memory=performance.memory;memPanel.update(memory.usedJSHeapSize/1048576,memory.jsHeapSizeLimit/1048576)}return time},update:function(){beginTime=this.end()},domElement:container,setMode:showPanel}};Stats.Panel=function(name,fg,bg){var min=1/0,max=0,round=Math.round,PR=round(window.devicePixelRatio||1),WIDTH=80*PR,HEIGHT=48*PR,TEXT_X=3*PR,TEXT_Y=2*PR,GRAPH_X=3*PR,GRAPH_Y=15*PR,GRAPH_WIDTH=74*PR,GRAPH_HEIGHT=30*PR,canvas=document.createElement("canvas");canvas.width=WIDTH,canvas.height=HEIGHT,canvas.style.cssText="width:80px;height:48px";var context=canvas.getContext("2d");return context.font="bold "+9*PR+"px Helvetica,Arial,sans-serif",context.textBaseline="top",context.fillStyle=bg,context.fillRect(0,0,WIDTH,HEIGHT),context.fillStyle=fg,context.fillText(name,TEXT_X,TEXT_Y),context.fillRect(GRAPH_X,GRAPH_Y,GRAPH_WIDTH,GRAPH_HEIGHT),context.fillStyle=bg,context.globalAlpha=.9,context.fillRect(GRAPH_X,GRAPH_Y,GRAPH_WIDTH,GRAPH_HEIGHT),{dom:canvas,update:function(value,maxValue){min=Math.min(min,value),max=Math.max(max,value),context.fillStyle=bg,context.globalAlpha=1,context.fillRect(0,0,WIDTH,GRAPH_Y),context.fillStyle=fg,context.fillText(round(value)+" "+name+" ("+round(min)+"-"+round(max)+")",TEXT_X,TEXT_Y),context.drawImage(canvas,GRAPH_X+PR,GRAPH_Y,GRAPH_WIDTH-PR,GRAPH_HEIGHT,GRAPH_X,GRAPH_Y,GRAPH_WIDTH-PR,GRAPH_HEIGHT),context.fillRect(GRAPH_X+GRAPH_WIDTH-PR,GRAPH_Y,PR,GRAPH_HEIGHT),context.fillStyle=bg,context.globalAlpha=.9,context.fillRect(GRAPH_X+GRAPH_WIDTH-PR,GRAPH_Y,PR,round((1-value/maxValue)*GRAPH_HEIGHT))}}};var TWEEN=TWEEN||function(){var _tweens=[];return{getAll:function(){return _tweens},removeAll:function(){_tweens=[]},add:function(tween){_tweens.push(tween)},remove:function(tween){var i=_tweens.indexOf(tween);i!==-1&&_tweens.splice(i,1)},update:function(time,preserve){if(0===_tweens.length)return!1;var i=0;for(time=void 0!==time?time:TWEEN.now();i<_tweens.length;)_tweens[i].update(time)||preserve?i++:_tweens.splice(i,1);return!0}}}();TWEEN.now=Date.now,TWEEN.Tween=function(object){var _repeatDelayTime,_object=object,_valuesStart={},_valuesEnd={},_valuesStartRepeat={},_duration=1e3,_repeat=0,_yoyo=!1,_isPlaying=!1,_reversed=!1,_delayTime=0,_startTime=null,_easingFunction=TWEEN.Easing.Linear.None,_interpolationFunction=TWEEN.Interpolation.Linear,_chainedTweens=[],_onStartCallback=null,_onStartCallbackFired=!1,_onUpdateCallback=null,_onCompleteCallback=null,_onStopCallback=null;for(var field in object)_valuesStart[field]=parseFloat(object[field],10);this.to=function(properties,duration){return void 0!==duration&&(_duration=duration),_valuesEnd=properties,this},this.start=function(time){TWEEN.add(this),_isPlaying=!0,_onStartCallbackFired=!1,_startTime=void 0!==time?time:TWEEN.now(),_startTime+=_delayTime;for(var property in _valuesEnd){if(_valuesEnd[property]instanceof Array){if(0===_valuesEnd[property].length)continue;_valuesEnd[property]=[_object[property]].concat(_valuesEnd[property])}void 0!==_object[property]&&(_valuesStart[property]=_object[property],_valuesStart[property]instanceof Array==!1&&(_valuesStart[property]*=1),_valuesStartRepeat[property]=_valuesStart[property]||0)}return this},this.stop=function(){return _isPlaying?(TWEEN.remove(this),_isPlaying=!1,null!==_onStopCallback&&_onStopCallback.call(_object,_object),this.stopChainedTweens(),this):this},this.end=function(){return this.update(_startTime+_duration),this},this.stopChainedTweens=function(){for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].stop()},this.delay=function(amount){return _delayTime=amount,this},this.repeat=function(times){return _repeat=times,this},this.repeatDelay=function(amount){return _repeatDelayTime=amount,this},this.yoyo=function(yoyo){return _yoyo=yoyo,this},this.easing=function(easing){return _easingFunction=easing,this},this.interpolation=function(interpolation){return _interpolationFunction=interpolation,this},this.chain=function(){return _chainedTweens=arguments,this},this.onStart=function(callback){return _onStartCallback=callback,this},this.onUpdate=function(callback){return _onUpdateCallback=callback,this},this.onComplete=function(callback){return _onCompleteCallback=callback,this},this.onStop=function(callback){return _onStopCallback=callback,this},this.update=function(time){var property,elapsed,value;if(time<_startTime)return!0;_onStartCallbackFired===!1&&(null!==_onStartCallback&&_onStartCallback.call(_object,_object),_onStartCallbackFired=!0),elapsed=(time-_startTime)/_duration,elapsed=elapsed>1?1:elapsed,value=_easingFunction(elapsed);for(property in _valuesEnd)if(void 0!==_valuesStart[property]){var start=_valuesStart[property]||0,end=_valuesEnd[property];end instanceof Array?_object[property]=_interpolationFunction(end,value):("string"==typeof end&&(end="+"===end.charAt(0)||"-"===end.charAt(0)?start+parseFloat(end,10):parseFloat(end,10)),"number"==typeof end&&(_object[property]=start+(end-start)*value))}if(null!==_onUpdateCallback&&_onUpdateCallback.call(_object,value),1===elapsed){if(_repeat>0){isFinite(_repeat)&&_repeat--;for(property in _valuesStartRepeat){if("string"==typeof _valuesEnd[property]&&(_valuesStartRepeat[property]=_valuesStartRepeat[property]+parseFloat(_valuesEnd[property],10)),_yoyo){var tmp=_valuesStartRepeat[property];_valuesStartRepeat[property]=_valuesEnd[property],_valuesEnd[property]=tmp}_valuesStart[property]=_valuesStartRepeat[property]}return _yoyo&&(_reversed=!_reversed),_startTime=void 0!==_repeatDelayTime?time+_repeatDelayTime:time+_delayTime,!0}null!==_onCompleteCallback&&_onCompleteCallback.call(_object,_object);for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].start(_startTime+_duration);return!1}return!0}},TWEEN.Easing={Linear:{None:function(k){return k}},Quadratic:{In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},Cubic:{In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},Quartic:{In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},Quintic:{In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},Sinusoidal:{In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},Exponential:{In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(-Math.pow(2,-10*(k-1))+2)}},Circular:{In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},Elastic:{In:function(k){return 0===k?0:1===k?1:-Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)},Out:function(k){return 0===k?0:1===k?1:Math.pow(2,-10*k)*Math.sin(5*(k-.1)*Math.PI)+1},InOut:function(k){return 0===k?0:1===k?1:(k*=2,k<1?-.5*Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI):.5*Math.pow(2,-10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)+1)}},Back:{In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?.5*(k*k*((s+1)*k-s)):.5*((k-=2)*k*((s+1)*k+s)+2)}},Bounce:{In:function(k){return 1-TWEEN.Easing.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*TWEEN.Easing.Bounce.In(2*k):.5*TWEEN.Easing.Bounce.Out(2*k-1)+.5}}},TWEEN.Interpolation={Linear:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.Linear;return k<0?fn(v[0],v[1],f):k>1?fn(v[m],v[m-1],m-f):fn(v[i],v[i+1>m?m:i+1],f-i)},Bezier:function(v,k){for(var b=0,n=v.length-1,pw=Math.pow,bn=TWEEN.Interpolation.Utils.Bernstein,i=0;i<=n;i++)b+=pw(1-k,n-i)*pw(k,i)*v[i]*bn(n,i);return b},CatmullRom:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.CatmullRom;return v[0]===v[m]?(k<0&&(i=Math.floor(f=m*(1+k))),fn(v[(i-1+m)%m],v[i],v[(i+1)%m],v[(i+2)%m],f-i)):k<0?v[0]-(fn(v[0],v[0],v[1],v[1],-f)-v[0]):k>1?v[m]-(fn(v[m],v[m],v[m-1],v[m-1],f-m)-v[m]):fn(v[i?i-1:0],v[i],v[m<i+1?m:i+1],v[m<i+2?m:i+2],f-i)},Utils:{Linear:function(p0,p1,t){return(p1-p0)*t+p0},Bernstein:function(n,i){var fc=TWEEN.Interpolation.Utils.Factorial;return fc(n)/fc(i)/fc(n-i)},Factorial:function(){var a=[1];return function(n){var s=1;if(a[n])return a[n];for(var i=n;i>1;i--)s*=i;return a[n]=s,s}}(),CatmullRom:function(p0,p1,p2,p3,t){var v0=.5*(p2-p0),v1=.5*(p3-p1),t2=t*t,t3=t*t2;return(2*p1-2*p2+v0+v1)*t3+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}}},function(root){"function"==typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!=typeof module&&"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=TWEEN:void 0!==root&&(root.TWEEN=TWEEN)}(void 0);